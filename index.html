<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Spello ‚Äì My Word Lists</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-start: #1a0533;
            --bg-mid: #2d0b5e;
            --bg-end: #0f172a;
            --card-bg: #ffffff;
            --card-border: rgba(255,255,255,0.15);
            --text-primary: #1e1b4b;
            --text-secondary: #2c3e50;        /* darker, readable on light card */
            --accent: #7c3aed;
            --accent2: #ec4899;
            --accent3: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --chip-bg: #f3e8ff;
            --chip-border: #c084fc;
            --input-bg: #ffffff;
            --input-border: #a78bfa;
            --shadow: 0 20px 60px rgba(0,0,0,0.35);
            --placeholder-light: #5b6f82;      /* darker placeholder */
        }

        .dark {
            --card-bg: #16103a;
            --card-border: rgba(139,92,246,0.3);
            --text-primary: #f0eaff;
            --text-secondary: #cfc0f0;          /* lighter for dark mode */
            --chip-bg: #2a2060;
            --chip-border: #7c5ccc;
            --input-bg: #1e1750;
            --input-border: #7c5ccc;
            --shadow: 0 20px 60px rgba(0,0,0,0.7);
            --placeholder-light: #a28fc0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            min-height: 100vh;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
            transition: background 0.4s;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 60% 10%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1.5px 1.5px at 80% 50%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 40% 70%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 90% 80%, rgba(255,255,255,0.3) 0%, transparent 100%),
                radial-gradient(1px 1px at 10% 90%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 50% 50%, rgba(255,255,255,0.3) 0%, transparent 100%),
                radial-gradient(1px 1px at 70% 20%, rgba(255,255,255,0.5) 0%, transparent 100%);
            pointer-events: none;
            z-index: 0;
        }

        .main-wrap {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 16px 120px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 32px;
            padding: 36px;
            box-shadow: var(--shadow);
            transition: background 0.3s, border 0.3s;
        }

        @media (max-width: 600px) {
            .card { padding: 24px 20px; border-radius: 24px; }
            .main-wrap { padding: 16px 12px 120px; }
        }

        .logo {
            font-family: 'Fredoka One', cursive;
            font-size: clamp(3.5rem, 10vw, 6rem);
            background: linear-gradient(135deg, #f59e0b, #ec4899, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            display: inline-block;
        }

        h1, h2, h3, h4 { color: var(--text-primary); font-family: 'Fredoka One', cursive; letter-spacing: 0.01em; }
        p, span, label, li { color: var(--text-secondary); }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            border-radius: 16px;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
            font-size: 1.05rem;
            border: none;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
            text-decoration: none;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
        .btn:active:not(:disabled) { transform: translateY(0); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            color: #fff;
            font-size: 1.2rem;
            padding: 18px 36px;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            font-size: 1.2rem;
            padding: 18px 36px;
        }
        .btn-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
        }
        .btn-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #fff;
            font-size: 1.3rem;
            padding: 20px 36px;
        }
        .btn-ghost {
            background: rgba(124,58,237,0.1);
            color: var(--accent);
            border: 2px solid var(--chip-border);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: #fff;
        }
        .btn-sm {
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }

        .stat-card {
            border-radius: 20px;
            padding: 20px 16px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .stat-num {
            font-family: 'Fredoka One', cursive;
            font-size: 2.4rem;
            line-height: 1;
            display: block;
        }
        .stat-label {
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.03em;
            margin-top: 4px;
            display: block;
        }

        .chip-row { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip {
            padding: 10px 20px;
            background: var(--chip-bg);
            border: 2px solid var(--chip-border);
            border-radius: 100px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            color: var(--accent);
            transition: all 0.15s;
        }
        .chip:hover { transform: scale(1.04); }
        .chip.active {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-color: transparent;
            color: white;
        }

        .answer-input {
            width: 100%;
            padding: 20px 24px;
            font-size: 1.6rem;
            font-family: 'Fredoka One', cursive;
            text-align: center;
            border: 3px solid var(--input-border);
            border-radius: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            letter-spacing: 0.05em;
        }
        .answer-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(124,58,237,0.15); }
        .answer-input::placeholder { color: var(--placeholder-light); opacity: 0.8; } /* much darker */

        .word-input {
            flex: 1;
            padding: 14px 20px;
            font-size: 1.1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            border: 2px solid var(--input-border);
            border-radius: 14px;
            background: var(--input-bg);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }
        .word-input:focus { border-color: var(--accent); }
        .word-input::placeholder { color: var(--placeholder-light); opacity: 0.8; }

        .word-chip {
            background: var(--chip-bg);
            border: 2px solid var(--chip-border);
            border-radius: 14px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .word-chip .wname {
            font-weight: 800;
            color: var(--text-primary);
            font-size: 1rem;
            text-transform: capitalize;
        }
        .word-chip .wdel {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.15s;
            color: #ef4444;
            padding: 2px 6px;
            border-radius: 6px;
        }
        .word-chip:hover .wdel { opacity: 1; }

        .progress-bar-wrap {
            height: 12px;
            background: rgba(124,58,237,0.15);
            border-radius: 100px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 100px;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.4s ease;
        }

        .feedback-box {
            border-radius: 20px;
            padding: 28px;
            text-align: center;
            margin-top: 16px;
        }
        .feedback-box.correct {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 3px solid #10b981;
        }
        .feedback-box.incorrect {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border: 3px solid #ef4444;
        }
        .dark .feedback-box.correct {
            background: linear-gradient(135deg, #064e3b, #065f46);
            border-color: #10b981;
        }
        .dark .feedback-box.incorrect {
            background: linear-gradient(135deg, #7f1d1d, #991b1b);
            border-color: #ef4444;
        }

        .dict-box {
            background: linear-gradient(135deg, rgba(124,58,237,0.08), rgba(236,72,153,0.08));
            border: 2px solid rgba(124,58,237,0.3);
            border-radius: 20px;
            padding: 24px;
            margin-top: 16px;
            text-align: left;
        }
        .dict-box .word-title {
            font-size: 1.8rem;
            font-family: 'Fredoka One', cursive;
            color: var(--accent);
            margin-bottom: 8px;
            text-transform: capitalize;
        }
        .dict-box .definition {
            font-size: 1.1rem;
            line-height: 1.5;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-left: 8px;
            border-left: 4px solid var(--accent2);
        }
        .dict-box .example {
            font-style: italic;
            color: var(--text-secondary);
            background: rgba(124,58,237,0.05);
            padding: 12px;
            border-radius: 12px;
        }

        .speak-btn {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            border-radius: 20px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.6rem;
            letter-spacing: 0.05em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 8px 24px rgba(37,99,235,0.4);
        }
        .speak-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(37,99,235,0.5); }
        .speak-btn:active { transform: translateY(0); }

        .speak-btn .pulse-ring {
            display: inline-block;
            font-size: 1.8rem;
            animation: speakPulse 2s infinite;
        }
        @keyframes speakPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .wave-bars {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-top: 8px;
        }
        .wave-bar {
            width: 5px;
            border-radius: 3px;
            background: linear-gradient(to top, #7c3aed, #ec4899);
            animation: wave 1.2s ease-in-out infinite;
        }
        .wave-bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .wave-bar:nth-child(2) { height: 22px; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 32px; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 22px; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { height: 12px; animation-delay: 0.4s; }
        @keyframes wave {
            0%,100% { transform: scaleY(0.4); }
            50% { transform: scaleY(1); }
        }

        .flex { display: flex; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1; }
        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        @media (max-width: 480px) { .grid2 { grid-template-columns: 1fr; } .grid3 { grid-template-columns: 1fr 1fr; } }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mb-8 { margin-bottom: 32px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mt-6 { margin-top: 24px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.85rem; }
        .bold { font-weight: 800; }
        .w-full { width: 100%; }
        .sep { height: 1px; background: rgba(124,58,237,0.15); margin: 20px 0; }

        .score-banner {
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            color: white;
            margin-bottom: 24px;
        }
        .score-banner .big-score {
            font-family: 'Fredoka One', cursive;
            font-size: 5rem;
            line-height: 1;
        }
        .score-banner .pct {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .info-box {
            border-radius: 16px;
            padding: 20px;
            border: 2px solid;
        }
        .info-box.danger { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.3); }
        .info-box.info { background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.3); }
        .dark .info-box.danger { background: rgba(239,68,68,0.15); }
        .dark .info-box.info { background: rgba(59,130,246,0.15); }

        .listen-section {
            background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(236,72,153,0.08));
            border: 2px solid rgba(245,158,11,0.25);
            border-radius: 24px;
            padding: 28px;
            margin-bottom: 20px;
        }
        .dark .listen-section {
            background: linear-gradient(135deg, rgba(245,158,11,0.07), rgba(236,72,153,0.05));
        }

        .result-word {
            padding: 14px 18px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 800;
            font-size: 1.05rem;
            text-transform: capitalize;
        }
        .result-word.ok { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .result-word.bad { background: #fee2e2; border: 2px solid #ef4444; color: #7f1d1d; }
        .dark .result-word.ok { background: #064e3b; color: #6ee7b7; }
        .dark .result-word.bad { background: #7f1d1d; color: #fca5a5; }

        .fab-row {
            position: fixed;
            bottom: 24px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        .fab {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .fab:hover { transform: scale(1.1); }
        .fab-theme { background: white; }
        .dark .fab-theme { background: #2d2060; color: white; }
        .fab-help { background: linear-gradient(135deg, #7c3aed, #ec4899); color: white; }

        /* list management */
        .list-tab {
            display: inline-block;
            padding: 10px 22px;
            background: var(--chip-bg);
            border: 2px solid var(--chip-border);
            border-radius: 40px;
            font-weight: 800;
            cursor: pointer;
            color: var(--accent);
        }
        .list-tab.active {
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            border-color: transparent;
            color: white;
        }
        .student-section { /* repurpose for single user */
            background: rgba(124,58,237,0.05);
            border: 1px solid rgba(124,58,237,0.2);
            border-radius: 24px;
            padding: 28px;
            margin-bottom: 20px;
        }
        .dark .student-section {
            background: rgba(124,58,237,0.1);
            border-color: rgba(124,58,237,0.35);
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        .modal-card {
            background: var(--card-bg);
            border-radius: 28px;
            max-width: 560px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 36px;
            position: relative;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 4px solid rgba(124,58,237,0.2);
            border-top-color: #7c3aed;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes bounce { 0%,100% { transform: translateY(0); } 40% { transform: translateY(-16px); } }
        .bounce { animation: bounce 0.8s ease 3; }
    </style>
</head>
<body id="body">
    <div class="fab-row">
        <button class="fab fab-theme" onclick="toggleDark()" id="themeBtn" title="Toggle dark mode">üåô</button>
        <button class="fab fab-help" onclick="openHelp()" title="Help">‚ùì</button>
    </div>
    <div class="main-wrap" id="app"></div>

    <!-- Help modal (shortened for brevity, same content) -->
    <div class="modal-bg" id="helpModal" style="display:none" onclick="closeHelp(event)">
        <div class="modal-card">
            <button style="position:absolute;top:18px;right:18px;background:rgba(124,58,237,0.1);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.1rem;color:var(--accent)" onclick="closeHelp()">‚úï</button>
            <h2 style="font-size:1.8rem;margin-bottom:20px">üìñ How to Use Spello</h2>
            <div style="line-height:1.9">
                <p>‚Ä¢ Create multiple word lists for yourself</p>
                <p>‚Ä¢ Click definition to see meaning from dictionary API</p>
                <p>‚Ä¢ Toggle dark mode for comfort</p>
            </div>
        </div>
    </div>

<script>
(function() {
    // ========== STATE (single user, multiple lists) ==========
    const state = {
        page: 'home',                // home | manage | playing | results
        lists: [],                   // array of { name: "List1", words: ["cat", "dog"] }
        activeListIndex: 0,           // index of currently selected list
        // game session
        idx: 0,
        score: 0,
        streak: 0,
        correctSet: new Set(),
        userAnswer: '',
        answered: false,
        showFeedback: false,
        showHint: false,
        hintLoading: false,
        currentDefinition: null,
        // stats (global for user)
        bestStreak: 0,
        totalWords: 0,
        testResults: [],
        dark: false
    };

    // ========== LOAD/SAVE ==========
    function load() {
        try {
            const d = localStorage.getItem('spello_dark');
            if (d !== null) state.dark = d === 'true';

            const lists = localStorage.getItem('spello_lists');
            if (lists) {
                state.lists = JSON.parse(lists);
            } else {
                // default list
                state.lists = [{ name: 'My Words', words: [] }];
            }

            const activeIdx = localStorage.getItem('spello_activeList');
            if (activeIdx !== null) state.activeListIndex = parseInt(activeIdx, 10) || 0;

            const best = localStorage.getItem('spello_bestStreak');
            if (best) state.bestStreak = parseInt(best, 10);
            const total = localStorage.getItem('spello_totalWords');
            if (total) state.totalWords = parseInt(total, 10);
            const results = localStorage.getItem('spello_testResults');
            if (results) state.testResults = JSON.parse(results);

            if (state.dark) {
                document.body.classList.add('dark');
                document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
            }
        } catch(e) { console.error(e); }
    }

    function save() {
        try {
            localStorage.setItem('spello_dark', state.dark);
            localStorage.setItem('spello_lists', JSON.stringify(state.lists));
            localStorage.setItem('spello_activeList', state.activeListIndex);
            localStorage.setItem('spello_bestStreak', state.bestStreak);
            localStorage.setItem('spello_totalWords', state.totalWords);
            localStorage.setItem('spello_testResults', JSON.stringify(state.testResults));
        } catch(e) { console.error(e); }
    }

    // ========== VOICE (with forced accent) ==========
    let selectedVoice = null;

    function setVoiceForAccent() {
        if (!window.speechSynthesis) return;
        const voices = window.speechSynthesis.getVoices();
        // prioritize South African English, then British, then any English
        selectedVoice = voices.find(v => v.lang === 'en-ZA') ||
                        voices.find(v => v.lang.startsWith('en-ZA')) ||
                        voices.find(v => v.lang === 'en-GB' && (v.name.includes('Daniel') || v.name.includes('Serena'))) ||
                        voices.find(v => v.lang === 'en-GB') ||
                        voices.find(v => v.lang.startsWith('en-GB')) ||
                        voices.find(v => v.lang.startsWith('en-')) ||
                        null;
    }

    if ('speechSynthesis' in window) {
        window.speechSynthesis.onvoiceschanged = setVoiceForAccent;
        setVoiceForAccent(); // immediate attempt
    }

    function speak(text, rate = 0.75) {
        if (!('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        if (selectedVoice) utter.voice = selectedVoice;
        utter.rate = rate;
        utter.pitch = 1.0;
        utter.volume = 1.0;
        // ensure voice is set before speaking
        setTimeout(() => window.speechSynthesis.speak(utter), 50);
    }

    // ========== DICTIONARY API ==========
    async function fetchDefinition(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
            if (!res.ok) throw new Error('not found');
            const data = await res.json();
            const meaning = data[0]?.meanings[0];
            const definition = meaning?.definitions[0]?.definition || 'No definition found.';
            const example = meaning?.definitions[0]?.example || '';
            return { word, definition, example };
        } catch (e) {
            return { word, definition: `No dictionary entry for "${word}".`, example: '' };
        }
    }

    async function requestDefinition() {
        const w = currentWords()[state.idx];
        state.showHint = true;
        state.hintLoading = true;
        state.currentDefinition = null;
        render();

        const defData = await fetchDefinition(w);
        state.currentDefinition = defData;
        state.hintLoading = false;
        render();
        speak(defData.definition, 0.8);
    }

    function replayDefinition() {
        if (state.currentDefinition?.definition) {
            speak(state.currentDefinition.definition, 0.8);
        }
    }

    // ========== UTILS ==========
    function currentWords() {
        return state.lists[state.activeListIndex]?.words || [];
    }

    function setActiveList(index) {
        if (state.lists[index]) {
            state.activeListIndex = index;
            save();
            render();
        }
    }

    function addList() {
        const name = prompt('New list name:');
        if (!name) return;
        state.lists.push({ name: name.trim(), words: [] });
        state.activeListIndex = state.lists.length - 1;
        save();
        render();
    }

    function deleteList(index) {
        if (state.lists.length <= 1) {
            alert('Keep at least one list.');
            return;
        }
        if (!confirm(`Delete list "${state.lists[index].name}"?`)) return;
        state.lists.splice(index, 1);
        if (state.activeListIndex >= state.lists.length) state.activeListIndex = state.lists.length - 1;
        save();
        render();
    }

    function addWord() {
        const inp = document.getElementById('wordInput');
        if (!inp) return;
        const w = inp.value.trim().toLowerCase().replace(/[^a-z\-']/g, '');
        if (!w) { inp.value = ''; return; }
        const words = state.lists[state.activeListIndex].words;
        if (!words.includes(w)) {
            words.push(w);
        }
        inp.value = '';
        save();
        render();
        inp.focus();
    }

    function removeWord(idx) {
        state.lists[state.activeListIndex].words.splice(idx, 1);
        save();
        render();
    }

    // ========== GAME FLOW ==========
    function startGame() {
        const words = currentWords();
        if (!words.length) return;
        state.page = 'playing';
        state.idx = 0;
        state.score = 0;
        state.streak = 0;
        state.correctSet = new Set();
        state.userAnswer = '';
        state.answered = false;
        state.showFeedback = false;
        state.showHint = false;
        state.currentDefinition = null;
        render();
    }

    function speakCurrentWord() {
        const w = currentWords()[state.idx];
        speak(w, 0.65);
    }

    function submitAnswer() {
        const inp = document.getElementById('answerInput');
        const val = inp ? inp.value.trim().toLowerCase() : state.userAnswer.trim().toLowerCase();
        state.userAnswer = val;
        const correct = val === currentWords()[state.idx];
        if (correct) {
            state.score++;
            state.correctSet.add(state.idx);
            state.streak++;
            if (state.streak > state.bestStreak) state.bestStreak = state.streak;
            state.totalWords++;
        } else {
            state.streak = 0;
        }
        state.answered = true;
        state.showFeedback = true;
        render();
    }

    function nextWord() {
        if (state.idx < currentWords().length - 1) {
            state.idx++;
            state.userAnswer = '';
            state.answered = false;
            state.showFeedback = false;
            state.showHint = false;
            state.currentDefinition = null;
            render();
        } else {
            endGame();
        }
    }

    function endGame() {
        const words = currentWords();
        const pct = Math.round((state.score / words.length) * 100);
        const result = {
            date: new Date().toISOString(),
            listName: state.lists[state.activeListIndex].name,
            words: [...words],
            score: state.score,
            total: words.length,
            percentage: pct,
            correctIndices: [...state.correctSet]
        };
        state.testResults.push(result);
        save();
        state.page = 'results';
        render();
    }

    function practiceAgain() {
        state.page = 'playing';
        state.idx = 0;
        state.score = 0;
        state.streak = 0;
        state.correctSet = new Set();
        state.userAnswer = '';
        state.answered = false;
        state.showFeedback = false;
        state.showHint = false;
        state.currentDefinition = null;
        render();
    }

    function newWords() {
        state.page = 'manage';
        save();
        render();
    }

    function exportCSV() {
        const rows = [['Date','List','Score','Percentage','Words']];
        state.testResults.forEach(t => {
            rows.push([
                new Date(t.date).toLocaleDateString(),
                t.listName,
                `${t.score}/${t.total}`,
                `${t.percentage}%`,
                t.words.join('; ')
            ]);
        });
        if (rows.length <= 1) { alert('No data to export.'); return; }
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\r\n');
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
        a.download = `spello-${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
    }

    function clearAll() {
        if (!confirm('‚ö†Ô∏è Delete ALL lists and progress?')) return;
        localStorage.clear();
        state.lists = [{ name: 'My Words', words: [] }];
        state.activeListIndex = 0;
        state.bestStreak = 0;
        state.totalWords = 0;
        state.testResults = [];
        state.dark = false;
        document.body.classList.remove('dark');
        document.getElementById('themeBtn').textContent = 'üåô';
        save();
        render();
    }

    // ========== NAVIGATION ==========
    function goHome() { state.page = 'home'; render(); }
    function goManage() { state.page = 'manage'; render(); }

    // ========== DARK MODE / HELP ==========
    function toggleDark() {
        state.dark = !state.dark;
        document.body.classList.toggle('dark', state.dark);
        document.getElementById('themeBtn').textContent = state.dark ? '‚òÄÔ∏è' : 'üåô';
        save();
        render();
    }
    function openHelp() { document.getElementById('helpModal').style.display = 'flex'; }
    function closeHelp(e) {
        if (!e || e.target === document.getElementById('helpModal')) {
            document.getElementById('helpModal').style.display = 'none';
        }
    }

    // ========== RENDER ==========
    function render() {
        const app = document.getElementById('app');
        switch(state.page) {
            case 'home':    app.innerHTML = homeHTML(); break;
            case 'manage':  app.innerHTML = manageHTML(); break;
            case 'playing': app.innerHTML = playHTML(); afterPlay(); break;
            case 'results': app.innerHTML = resultsHTML(); break;
        }
    }

    function homeHTML() {
        const tests = state.testResults.length;
        const wCount = currentWords().length;
        return `
        <div class="card">
            <div class="text-center mb-8">
                <div class="logo">‚ú® Spello ‚ú®</div>
                <p style="font-size:1.2rem;margin-top:8px">Master your spelling, one list at a time</p>
            </div>
            <div class="stats-grid mb-8">
                <div class="stat-card" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#f59e0b">
                    <span class="stat-num" style="color:#92400e">${state.bestStreak}</span>
                    <span class="stat-label" style="color:#b45309">Best Streak üî•</span>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#d1fae5,#a7f3d0);border-color:#10b981">
                    <span class="stat-num" style="color:#065f46">${state.totalWords}</span>
                    <span class="stat-label" style="color:#047857">Words Mastered üìö</span>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-color:#3b82f6">
                    <span class="stat-num" style="color:#1e3a8a">${tests}</span>
                    <span class="stat-label" style="color:#1d4ed8">Tests Done üìù</span>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#ede9fe,#ddd6fe);border-color:#8b5cf6">
                    <span class="stat-num" style="color:#4c1d95">${wCount}</span>
                    <span class="stat-label" style="color:#6d28d9">Words Ready üéØ</span>
                </div>
            </div>
            <div class="flex gap-4" style="flex-direction:column">
                <button class="btn btn-success w-full" onclick="goManage()" style="font-size:1.4rem;padding:22px">
                    üìã Manage Lists
                </button>
                <button class="btn btn-primary w-full" onclick="startGame()" style="font-size:1.3rem;padding:20px" ${!wCount ? 'disabled' : ''}>
                    üöÄ Start Spelling
                </button>
            </div>
        </div>`;
    }

    function manageHTML() {
        const activeList = state.lists[state.activeListIndex];
        return `
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <h1 style="font-size:2rem">üìö My Word Lists</h1>
                <button class="btn btn-ghost btn-sm" onclick="goHome()">üè† Home</button>
            </div>
            <div class="mb-6">
                <label class="bold mb-2" style="display:block;">Select list:</label>
                <div class="chip-row">
                    ${state.lists.map((lst, i) => `
                        <span class="list-tab ${i === state.activeListIndex ? 'active' : ''}" 
                              onclick="setActiveList(${i})">${lst.name} (${lst.words.length})</span>
                    `).join('')}
                    <span class="list-tab" onclick="addList()">‚ûï New List</span>
                </div>
                ${state.lists.length > 1 ? `
                <button class="btn btn-danger btn-sm mt-2" onclick="deleteList(${state.activeListIndex})">
                    üóëÔ∏è Delete "${activeList.name}"
                </button>` : ''}
            </div>

            <div class="mb-6">
                <label class="bold mb-2">Add words to "${activeList.name}" üìù</label>
                <div class="flex gap-3">
                    <input id="wordInput" class="word-input" placeholder="Type word and press Enter‚Ä¶"
                           onkeydown="if(event.key==='Enter')addWord()" autocomplete="off">
                    <button class="btn btn-blue" onclick="addWord()">Add</button>
                </div>
            </div>

            ${activeList.words.length ? `
            <div class="mb-6">
                <h3 style="font-size:1.1rem;margin-bottom:12px;">Words (${activeList.words.length})</h3>
                <div class="grid2">
                    ${activeList.words.map((w,i) => `
                        <div class="word-chip">
                            <span class="wname">${w}</span>
                            <button class="wdel" onclick="removeWord(${i})">‚úï</button>
                        </div>`).join('')}
                </div>
            </div>` : '<p>Add some words to get started.</p>'}

            <button class="btn btn-success w-full" style="font-size:1.3rem;padding:20px"
                    onclick="startGame()" ${!activeList.words.length ? 'disabled' : ''}>
                üöÄ Start Spelling Adventure!
            </button>
        </div>`;
    }

    function playHTML() {
        const words = currentWords();
        const w = words[state.idx];
        const pct = Math.round(((state.idx + (state.answered ? 1 : 0)) / words.length) * 100);
        const isCorrect = state.answered && state.userAnswer === w;
        const def = state.currentDefinition;
        return `
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 style="font-size:1.6rem">List: ${state.lists[state.activeListIndex].name}</h2>
                    <p style="font-size:0.95rem">Listen and spell</p>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="goHome()">Exit</button>
            </div>
            <div class="mb-6">
                <div class="flex justify-between mb-2" style="font-size:0.9rem;font-weight:700;">
                    <span>Word ${state.idx + 1} / ${words.length}</span>
                    <span>Score: ${state.score} ‚≠ê</span>
                    <span>Streak: ${state.streak} üî•</span>
                </div>
                <div class="progress-bar-wrap"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
            </div>
            <div class="listen-section mb-4">
                <div class="text-center mb-4">
                    <div style="font-size:3rem">üîä</div>
                </div>
                <button class="speak-btn mb-3" onclick="speakCurrentWord()">
                    <span class="pulse-ring">üîä</span><span>SAY THE WORD</span>
                </button>
                <button class="btn btn-primary w-full" style="font-size:1.1rem;padding:16px" onclick="requestDefinition()">
                    üìò Definition
                </button>
                ${state.showHint ? `
                <div class="dict-box mt-4">
                    ${state.hintLoading
                        ? `<div class="spinner"></div><p style="text-align:center;">Looking up definition‚Ä¶</p>`
                        : def ? `
                            <div class="word-title">${def.word}</div>
                            <div class="definition">üìñ ${def.definition}</div>
                            ${def.example ? `<div class="example">üí¨ "${def.example}"</div>` : ''}
                            <button class="btn btn-ghost btn-sm mt-3" onclick="replayDefinition()">üîÅ Read definition</button>
                          ` : '<p>No definition.</p>'}
                </div>` : ''}
            </div>
            <div class="mb-4">
                <input id="answerInput" class="answer-input"
                       value="${state.answered ? state.userAnswer : ''}"
                       placeholder="‚úèÔ∏è Spell the word‚Ä¶"
                       autocomplete="off" spellcheck="false"
                       ${state.answered ? 'disabled' : ''}
                       onkeydown="if(event.key==='Enter'&&!state.answered)submitAnswer()">
            </div>
            ${state.showFeedback ? `
            <div class="feedback-box ${isCorrect ? 'correct' : 'incorrect'} mb-4">
                <div style="font-size:3.5rem;">${isCorrect ? 'üéâ' : 'üí™'}</div>
                <h3 style="font-size:1.5rem;color:${isCorrect ? '#065f46' : '#7f1d1d'}">
                    ${isCorrect ? 'Perfect!' : `Correct spelling: <em>${w}</em>`}
                </h3>
            </div>` : ''}
            ${!state.answered
                ? `<button class="btn btn-primary w-full" onclick="submitAnswer()">‚úÖ Check Answer</button>`
                : `<button class="btn btn-success w-full" onclick="nextWord()">
                       ${state.idx < words.length - 1 ? 'üöÄ Next Word' : 'üéâ See Results'}
                   </button>`}
        </div>`;
    }

    function afterPlay() {
        if (!state.answered) document.getElementById('answerInput')?.focus();
    }

    function resultsHTML() {
        const words = currentWords();
        const pct = Math.round((state.score / words.length) * 100);
        return `
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <h2 style="font-size:1.8rem">üèÅ Results</h2>
                <button class="btn btn-ghost btn-sm" onclick="goHome()">üè† Home</button>
            </div>
            <div class="text-center mb-6">
                <div style="font-size:4rem;animation:bounce 0.8s ease 3">${pct===100?'üèÜ':pct>=80?'üéâ':'üëç'}</div>
                <h2 style="font-size:2rem;">Great job!</h2>
            </div>
            <div class="score-banner mb-6" style="background:linear-gradient(135deg,#7c3aed,#ec4899)">
                <div class="big-score">${state.score}/${words.length}</div>
                <div class="pct">${pct}%</div>
            </div>
            <div class="grid2 mb-6">
                ${words.map((w,i) => `
                    <div class="result-word ${state.correctSet.has(i)?'ok':'bad'}">
                        <span>${w}</span><span>${state.correctSet.has(i)?'‚úì':'‚úó'}</span>
                    </div>`).join('')}
            </div>
            <div class="grid2">
                <button class="btn btn-primary" onclick="practiceAgain()">üîÑ Practice Again</button>
                <button class="btn btn-blue" onclick="newWords()">üìã Lists</button>
            </div>
        </div>`;
    }

    // Expose globals
    window.toggleDark = toggleDark;
    window.openHelp = openHelp;
    window.closeHelp = closeHelp;
    window.goHome = goHome;
    window.goManage = goManage;
    window.startGame = startGame;
    window.speakCurrentWord = speakCurrentWord;
    window.requestDefinition = requestDefinition;
    window.replayDefinition = replayDefinition;
    window.submitAnswer = submitAnswer;
    window.nextWord = nextWord;
    window.practiceAgain = practiceAgain;
    window.newWords = newWords;
    window.exportCSV = exportCSV;
    window.clearAll = clearAll;
    window.setActiveList = setActiveList;
    window.addList = addList;
    window.deleteList = deleteList;
    window.addWord = addWord;
    window.removeWord = removeWord;

    // init
    load();
    render();
})();
</script>
</body>
</html> 