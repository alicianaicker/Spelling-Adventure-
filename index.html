<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Spello - Master Your Spelling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        /* ==================== DARK MODE - COMPLETELY REWORKED ==================== */
        .dark-mode {
            background: linear-gradient(135deg, #0d0b1a 0%, #151225 50%, #1d1930 100%) !important;
        }
        
        .dark-mode .game-card {
            background: #1a162e !important;
            border: 1px solid #3f3868;
        }
        
        .dark-mode h1, 
        .dark-mode h2, 
        .dark-mode h3,
        .dark-mode .font-bold {
            color: #ffffff !important;
        }
        
        .dark-mode p, 
        .dark-mode span, 
        .dark-mode label,
        .dark-mode div:not(.stat-value) {
            color: #e0d9ff !important;
        }
        
        .dark-mode .text-gray-600,
        .dark-mode .text-gray-700,
        .dark-mode .text-gray-500 {
            color: #ccc2ff !important;
        }
        
        /* Stats Cards - Fixed */
        .dark-mode .stat-card {
            background: #272141 !important;
            border: 1px solid #5f5398;
        }
        
        .dark-mode .stat-card .stat-value {
            color: #ffffff !important;
        }
        
        .dark-mode .stat-card .stat-label {
            color: #c4b8ff !important;
        }
        
        /* Parent Dashboard Stats - Fixed */
        .dark-mode .parent-stat-card {
            background: #2a2348 !important;
            border: 1px solid #675ba8;
        }
        
        .dark-mode .parent-stat-card .stat-number {
            color: #ffffff !important;
        }
        
        .dark-mode .parent-stat-card .stat-desc {
            color: #cfc4ff !important;
        }
        
        /* Student Sections - Fixed */
        .dark-mode .student-section {
            background: #221e3a !important;
            border: 1px solid #524b85;
        }
        
        .dark-mode .student-section h2 {
            color: #ffffff !important;
        }
        
        .dark-mode .student-section .text-gray-600 {
            color: #c7bcff !important;
        }
        
        /* Test Cards - Fixed */
        .dark-mode .test-card {
            background: #2d2550 !important;
            border: 1px solid #6f63b0;
        }
        
        .dark-mode .test-card .text-gray-500,
        .dark-mode .test-card .text-gray-600 {
            color: #c4b8ff !important;
        }
        
        .dark-mode .test-card .font-bold {
            color: #ffffff !important;
        }
        
        /* Data Management Cards - Fixed */
        .dark-mode .bg-red-50 {
            background: #3d2a2a !important;
            border-color: #a15555 !important;
        }
        
        .dark-mode .bg-red-50 h3 {
            color: #ffb5b5 !important;
        }
        
        .dark-mode .bg-red-50 p {
            color: #ffcdcd !important;
        }
        
        .dark-mode .bg-blue-50 {
            background: #232d4a !important;
            border-color: #4f77b3 !important;
        }
        
        .dark-mode .bg-blue-50 h3 {
            color: #b8d4ff !important;
        }
        
        .dark-mode .bg-blue-50 p {
            color: #c6dbff !important;
        }
        
        /* Help Modal Dark Mode */
        .dark-mode .modal-content {
            background: #1f1b38 !important;
            border: 2px solid #6f63b0;
        }
        
        .dark-mode .modal-content h2,
        .dark-mode .modal-content h3 {
            color: #ffffff !important;
        }
        
        .dark-mode .modal-content p,
        .dark-mode .modal-content li {
            color: #d9ceff !important;
        }
        
        .dark-mode .modal-content .bg-blue-50 {
            background: #252147 !important;
        }
        
        .dark-mode .modal-close {
            background: #332b58;
            color: white;
        }
        
        /* Control buttons */
        .control-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        .theme-btn {
            background: white;
        }
        
        .help-btn {
            background: #8b5cf6;
            color: white;
        }
        
        .dark-mode .theme-btn {
            background: #2d2550;
            border-color: #9d87e8;
            color: #ffffff;
        }
        
        .dark-mode .help-btn {
            background: #7c3aed;
            border-color: #a78bfa;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
        }
        
        /* Main content */
        .main-content {
            min-height: 100vh;
            padding: 30px;
            padding-bottom: 100px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        @media (min-width: 1024px) {
            .main-content {
                padding: 40px 60px;
                padding-bottom: 100px;
            }
        }
        
        .game-card {
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 40px;
            width: 100%;
        }
        
        .dark-mode .game-card {
            background: #1a162e;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .main-content {
                padding: 20px;
                padding-bottom: 100px;
            }
        }
        
        /* Child selector */
        .child-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        
        .child-chip {
            padding: 12px 24px;
            background: #f3e8ff;
            border: 2px solid #c084fc;
            border-radius: 40px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .child-chip:hover {
            transform: scale(1.05);
            background: #e9d5ff;
        }
        
        .child-chip.selected {
            background: #8b5cf6;
            border-color: #6d28d9;
            color: white;
        }
        
        .dark-mode .child-chip {
            background: #382e60;
            border-color: #9d87e8;
            color: white;
        }
        
        .dark-mode .child-chip.selected {
            background: #7c3aed;
            border-color: #a78bfa;
        }
        
        .speak-button {
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        .audio-only-hint {
            background: #f0eaff;
            border-radius: 24px;
            padding: 30px;
            margin-top: 24px;
            border: 3px solid #8b5cf6;
            text-align: center;
        }
        
        .dark-mode .audio-only-hint {
            background: #2a2445;
            border-color: #b79aff;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s ease;
        }
        
        .word-chip {
            background: #f3e8ff;
            border: 1px solid #c084fc;
            border-radius: 20px;
            padding: 14px;
        }
        
        .dark-mode .word-chip {
            background: #382e60;
            border-color: #9d87e8;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(139, 92, 246, 0.3);
            border-radius: 50%;
            border-top-color: #8b5cf6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 40px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 35px;
            position: relative;
        }
    </style>
</head>
<body id="body" class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600">
    <!-- Control Buttons -->
    <div class="control-buttons">
        <button onclick="window.toggleDarkMode()" class="control-btn theme-btn">
            <span id="theme-icon">üåô</span>
        </button>
        <button onclick="window.showHelp()" class="control-btn help-btn">
            <span>‚ùì</span>
        </button>
    </div>
    
    <!-- Main Content -->
    <div id="app" class="main-content"></div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-close" onclick="window.hideHelp()">‚úï</div>
            <h2 class="text-3xl font-bold mb-6">üìñ How to Use Spello</h2>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-xl font-bold mb-2">üéØ Getting Started</h3>
                    <p>1. Select your name or add a new one</p>
                    <p>2. Add words you want to practice</p>
                    <p>3. Click "Start Adventure" to begin</p>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-2">üîä During the Game</h3>
                    <p>‚Ä¢ Click "SAY THE WORD" to hear the word (South African accent)</p>
                    <p>‚Ä¢ Click "Use the word in a sentence" to hear it in context</p>
                    <p>‚Ä¢ Type your answer and click "Check My Answer"</p>
                    <p>‚Ä¢ Watch your streak grow with correct answers!</p>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h3>
                    <p>‚Ä¢ View progress for all students</p>
                    <p>‚Ä¢ See test scores and improvement over time</p>
                    <p>‚Ä¢ Export data as CSV for record keeping</p>
                    <p>‚Ä¢ Clear all data if needed</p>
                </div>
                
                <div>
                    <h3 class="text-xl font-bold mb-2">üîí Privacy</h3>
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <p>‚úÖ All data stored locally on your device only</p>
                        <p>‚úÖ No accounts or sign-ups needed</p>
                        <p>‚úÖ No tracking or analytics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let state = {
            mode: 'home',
            gameState: 'setup',
            students: [],
            currentStudent: '',
            words: [],
            currentIndex: 0,
            userAnswer: '',
            score: 0,
            showAnswer: false,
            answered: false,
            correctAnswers: [],
            streak: 0,
            bestStreak: 0,
            totalWords: 0,
            testResults: [],
            showHint: false,
            currentSentence: '',
            isLoadingHint: false,
            darkMode: false
        };

        // Load initial data from localStorage
        function loadFromStorage() {
            try {
                // Load dark mode
                const savedDarkMode = localStorage.getItem('spello_darkMode');
                if (savedDarkMode !== null) {
                    state.darkMode = savedDarkMode === 'true';
                }
                
                // Load students
                const savedStudents = localStorage.getItem('spello_students');
                if (savedStudents) {
                    state.students = JSON.parse(savedStudents);
                } else {
                    state.students = [];
                }
                
                // Load current student
                const savedCurrentStudent = localStorage.getItem('spello_currentStudent');
                if (savedCurrentStudent) {
                    state.currentStudent = savedCurrentStudent;
                    loadStudentData(savedCurrentStudent);
                }
                
                // Apply dark mode
                if (state.darkMode) {
                    document.getElementById('body').classList.add('dark-mode');
                    document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
                }
            } catch (e) {
                console.error('Error loading from storage:', e);
                // Reset to defaults if there's an error
                state.students = [];
                state.currentStudent = '';
            }
        }

        // Save all data to localStorage
        function saveToStorage() {
            try {
                localStorage.setItem('spello_darkMode', state.darkMode);
                localStorage.setItem('spello_students', JSON.stringify(state.students));
                localStorage.setItem('spello_currentStudent', state.currentStudent || '');
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        // Load student-specific data
        function loadStudentData(studentName) {
            const student = state.students.find(s => s.name === studentName);
            if (student) {
                state.bestStreak = student.bestStreak || 0;
                state.totalWords = student.totalWords || 0;
                state.testResults = student.testResults || [];
            } else {
                state.bestStreak = 0;
                state.totalWords = 0;
                state.testResults = [];
            }
        }

        // Save student data
        function saveStudentData() {
            const studentIndex = state.students.findIndex(s => s.name === state.currentStudent);
            
            const studentData = {
                name: state.currentStudent,
                bestStreak: state.bestStreak,
                totalWords: state.totalWords,
                testResults: state.testResults,
                lastActive: new Date().toISOString()
            };
            
            if (studentIndex >= 0) {
                state.students[studentIndex] = studentData;
            } else if (state.currentStudent) {
                state.students.push(studentData);
            }
            
            saveToStorage();
        }

        // Initialize
        loadFromStorage();

        // ==================== HELP MODAL ====================
        function showHelp() {
            document.getElementById('helpModal').style.display = 'flex';
        }
        
        function hideHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                hideHelp();
            }
        };

        // ==================== SOUTH AFRICAN VOICE ====================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    
                    // Priority: Find South African voices
                    let selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-ZA') || 
                        voice.name.includes('South African') ||
                        voice.name.includes('Tessa') ||
                        voice.name.includes('Zola')
                    );
                    
                    // Fallback to clear British voices
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            voice.lang.includes('en-GB') && 
                            (voice.name.includes('Daniel') || 
                             voice.name.includes('Kate'))
                        );
                    }
                    
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.includes('en-'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.rate = 0.7;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    window.speechSynthesis.speak(utterance);
                }, 100);
            }
        }

        // Pre-load voices
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = function() {
                window.speechSynthesis.getVoices();
            };
        }

        // ==================== SENTENCE API ====================
        const sentenceCache = new Map();

        function getLocalSentence(word) {
            const sentences = {
                'cat': 'The cat sat on the windowsill, watching the birds outside.',
                'dog': 'My dog loves to play fetch in the park every afternoon.',
                'fish': 'The colourful fish swam gracefully in the aquarium.',
                'bird': 'A beautiful bird sang sweetly in the old oak tree.',
                'rabbit': 'The fluffy rabbit hopped quickly through the garden.',
                'horse': 'The majestic horse galloped across the open field.',
                'cow': 'The spotted cow grazed peacefully in the meadow.',
                'lion': 'The mighty lion rested under the shade of the acacia tree.',
                'tiger': 'The striped tiger prowled silently through the jungle.',
                'elephant': 'The enormous elephant sprayed water with its long trunk.',
                'apple': 'She bit into the crisp, red apple and smiled.',
                'banana': 'Monkeys love to eat ripe, yellow bananas.',
                'bread': 'The smell of fresh bread filled the kitchen.',
                'milk': 'Please pour a glass of cold milk for the children.',
                'water': 'Remember to drink plenty of clean water every day.',
                'cake': 'Grandma baked a delicious chocolate cake for my birthday.',
                'pizza': 'We ordered a large pepperoni pizza for dinner.',
                'rice': 'Rice is a staple food in many countries around the world.',
                'soup': 'Hot chicken soup is perfect when you are feeling sick.',
                'egg': 'She fried an egg for breakfast this morning.',
                'run': 'The children love to run and play in the playground.',
                'jump': 'Can you jump over the small puddle on the path?',
                'swim': 'We learned how to swim at the community pool.',
                'fly': 'Pilots must train for many years before they can fly planes.',
                'eat': 'It is important to eat healthy foods to grow strong.',
                'drink': 'You should drink eight glasses of water each day.',
                'sleep': 'Young children need plenty of sleep to grow properly.',
                'play': 'After finishing homework, we can play outside.',
                'read': 'I love to read adventure stories before bedtime.',
                'write': 'Please write your name clearly at the top of the page.',
                'red': 'She wore a bright red dress to the party.',
                'blue': 'The clear blue sky stretched endlessly above us.',
                'green': 'Fresh green grass covered the hillside after the rain.',
                'yellow': 'Daffodils are beautiful yellow flowers that bloom in spring.',
                'orange': 'He peeled the juicy orange and shared it with his sister.',
                'purple': 'The royal purple robe was adorned with gold trim.',
                'brown': 'The brown bear searched for salmon in the river.',
                'black': 'A black cat crossed the path on Halloween night.',
                'white': 'Pure white snow covered the mountain peaks.',
                'pink': 'The garden was full of pretty pink roses.',
                'ball': 'He kicked the ball straight into the goal.',
                'car': 'The red sports car zoomed down the highway.',
                'book': 'She borrowed an interesting book from the library.',
                'pen': 'Please use a blue pen to complete the test.',
                'chair': 'Pull up a chair and join us at the table.',
                'table': 'We gathered around the table for Sunday dinner.',
                'door': 'Please close the door gently when you leave.',
                'window': 'Open the window to let in some fresh air.',
                'house': 'Their house has a beautiful garden in front.',
                'school': 'School starts at eight o\'clock every morning.',
                'mom': 'My mom makes the best pancakes on Saturday mornings.',
                'dad': 'Dad taught me how to ride a bicycle.',
                'baby': 'The baby slept peacefully in its crib.',
                'girl': 'A little girl skipped happily down the street.',
                'boy': 'The young boy helped his grandmother carry groceries.',
                'teacher': 'Our teacher explained the maths problem clearly.',
                'doctor': 'The doctor prescribed medicine for the cough.',
                'friend': 'My best friend moved to a different city last year.',
                'park': 'We had a picnic at the park on Sunday afternoon.',
                'beach': 'Building sandcastles at the beach is lots of fun.',
                'store': 'I need to stop at the store to buy milk.',
                'home': 'After a long day, I was happy to be home.',
                'zoo': 'The zoo has a new exhibit for the penguins.',
                'rain': 'Do not forget your umbrella when it starts to rain.',
                'snow': 'The first snow of winter fell during the night.',
                'wind': 'Strong wind blew the leaves across the yard.',
                'cloud': 'A single white cloud floated across the blue sky.',
                'sun': 'The warm sun felt good on our faces.',
                'one': 'I would like one scoop of ice cream please.',
                'two': 'She has two cats and one dog at home.',
                'three': 'A triangle has three sides of equal length.',
                'four': 'There are four seasons in the calendar year.',
                'five': 'I have five fingers on my left hand.'
            };
            
            if (sentences[word]) {
                return sentences[word];
            }
            
            const templates = [
                `The word ${word} is used in many different ways.`,
                `Can you spell the word ${word} correctly?`,
                `Listen carefully to the word ${word}.`,
                `Now try to spell the word ${word}.`,
                `The word for this round is ${word}.`
            ];
            
            return templates[Math.floor(Math.random() * templates.length)];
        }

        async function getSentenceForWord(word) {
            if (sentenceCache.has(word)) {
                return sentenceCache.get(word);
            }
            
            // Try API first
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data[0] && data[0].meanings) {
                        for (const meaning of data[0].meanings) {
                            if (meaning.definitions) {
                                for (const definition of meaning.definitions) {
                                    if (definition.example) {
                                        sentenceCache.set(word, definition.example);
                                        return definition.example;
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                console.log('API failed, using local sentence');
            }
            
            // Fallback to local sentences
            const localSentence = getLocalSentence(word);
            sentenceCache.set(word, localSentence);
            return localSentence;
        }

        // ==================== DARK MODE TOGGLE ====================
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            saveToStorage();
            
            const body = document.getElementById('body');
            const icon = document.getElementById('theme-icon');
            
            if (state.darkMode) {
                body.classList.add('dark-mode');
                icon.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.remove('dark-mode');
                icon.textContent = 'üåô';
            }
            
            render();
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            
            if (state.mode === 'home') {
                app.innerHTML = `
                    <div class="w-full">
                        <div class="game-card p-8 md:p-12">
                            <div class="text-center mb-12">
                                <h1 class="text-6xl md:text-8xl font-bold mb-4 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600 bg-clip-text text-transparent">
                                    ‚ú® Spello ‚ú®
                                </h1>
                                <p class="text-2xl md:text-3xl text-gray-600">Master your spelling skills</p>
                            </div>

                            <div class="stats-grid">
                                <div class="stat-card rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-value text-4xl md:text-5xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="stat-label text-sm md:text-base text-yellow-700 font-medium">Best Streak üî•</div>
                                </div>
                                <div class="stat-card rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-value text-4xl md:text-5xl font-bold text-green-800">${state.totalWords}</div>
                                    <div class="stat-label text-sm md:text-base text-green-700 font-medium">Words Mastered üìö</div>
                                </div>
                                <div class="stat-card rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-value text-4xl md:text-5xl font-bold text-blue-800">${state.testResults.length}</div>
                                    <div class="stat-label text-sm md:text-base text-blue-700 font-medium">Tests Done üìù</div>
                                </div>
                                <div class="stat-card rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-value text-4xl md:text-5xl font-bold text-purple-800">${state.words.length}</div>
                                    <div class="stat-label text-sm md:text-base text-purple-700 font-medium">Words Ready üéØ</div>
                                </div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-6">
                                <button onclick="startLearning()" 
                                        class="flex-1 py-8 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl md:text-3xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all shadow-xl">
                                    üöÄ Start Learning
                                </button>
                                <button onclick="openParentDashboard()" 
                                        class="flex-1 py-8 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-2xl md:text-3xl font-bold rounded-2xl hover:from-blue-600 hover:to-indigo-700 transform hover:scale-105 transition-all shadow-xl">
                                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.mode === 'parent') {
                renderParent();
            }
            else if (state.mode === 'student') {
                if (state.gameState === 'setup') renderSetup();
                else if (state.gameState === 'playing') renderPlaying();
                else if (state.gameState === 'results') renderResults();
            }
        }

        function renderParent() {
            const students = state.students || [];
            
            const totalStudents = students.length;
            const totalWords = students.reduce((acc, s) => acc + (s.totalWords || 0), 0);
            const totalTests = students.reduce((acc, s) => acc + (s.testResults?.length || 0), 0);
            const bestStreakOverall = Math.max(...students.map(s => s.bestStreak || 0), 0);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="w-full">
                    <div class="game-card p-8 md:p-12">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 class="text-3xl md:text-4xl font-bold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h1>
                            <div class="flex gap-3">
                                <button onclick="exportData()" class="px-8 py-4 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors text-lg font-bold">
                                    üì• Export CSV
                                </button>
                                <button onclick="goHome()" class="px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors text-lg font-bold">
                                    üè† Home
                                </button>
                            </div>
                        </div>

                        ${students.length === 0 ? `
                            <div class="text-center py-20 bg-gray-50 rounded-3xl">
                                <div class="text-8xl mb-6">üìä</div>
                                <h3 class="text-3xl font-bold text-gray-700 mb-3">No Students Yet</h3>
                                <p class="text-xl text-gray-500 mb-8">Go to Start Learning and add your first student!</p>
                                <button onclick="startLearning()" class="px-10 py-5 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600 text-xl">
                                    üöÄ Add a Student
                                </button>
                            </div>
                        ` : `
                            <div class="stats-grid mb-10">
                                <div class="parent-stat-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-number text-4xl font-bold text-blue-800">${totalStudents}</div>
                                    <div class="stat-desc text-sm text-blue-600">Total Students</div>
                                </div>
                                <div class="parent-stat-card bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-number text-4xl font-bold text-green-800">${totalWords}</div>
                                    <div class="stat-desc text-sm text-green-600">Total Words</div>
                                </div>
                                <div class="parent-stat-card bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-number text-4xl font-bold text-purple-800">${totalTests}</div>
                                    <div class="stat-desc text-sm text-purple-600">Total Tests</div>
                                </div>
                                <div class="parent-stat-card bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-6 md:p-8 text-center">
                                    <div class="stat-number text-4xl font-bold text-yellow-800">${bestStreakOverall}</div>
                                    <div class="stat-desc text-sm text-yellow-600">Best Streak</div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                ${students.map(student => {
                                    const studentTests = student.testResults || [];
                                    const studentAvg = studentTests.length > 0 
                                        ? Math.round(studentTests.reduce((acc, t) => acc + t.percentage, 0) / studentTests.length)
                                        : 0;
                                    const recentTests = studentTests.slice(-5).reverse();
                                    const totalCorrect = studentTests.reduce((acc, t) => acc + t.score, 0);
                                    
                                    return `
                                        <div class="student-section bg-gray-50 rounded-2xl p-6 md:p-8">
                                            <div class="flex items-center gap-4 mb-6">
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                                    ${student.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <h2 class="text-3xl font-bold">${student.name}</h2>
                                                    <p class="text-gray-600 text-lg">${studentTests.length} tests completed</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-4 mb-6">
                                                <div class="test-card bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-blue-600">${studentAvg}%</div>
                                                    <div class="text-sm text-gray-500">Average</div>
                                                </div>
                                                <div class="test-card bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-green-600">${totalCorrect}</div>
                                                    <div class="text-sm text-gray-500">Correct</div>
                                                </div>
                                                <div class="test-card bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-purple-600">${student.totalWords || 0}</div>
                                                    <div class="text-sm text-gray-500">Total Words</div>
                                                </div>
                                            </div>
                                            
                                            <h3 class="font-bold text-xl mb-4">üìã Recent Tests</h3>
                                            <div class="space-y-4">
                                                ${recentTests.map(test => `
                                                    <div class="test-card bg-white rounded-xl p-5 border-l-4 ${test.percentage >= 80 ? 'border-green-500' : 'border-yellow-500'}">
                                                        <div class="flex justify-between items-center mb-3">
                                                            <span class="font-bold text-lg">${test.score}/${test.total} words correct</span>
                                                            <span class="text-gray-500">${new Date(test.date).toLocaleDateString()}</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                                            <div class="bg-${test.percentage >= 80 ? 'green' : 'yellow'}-500 h-3 rounded-full" style="width: ${test.percentage}%"></div>
                                                        </div>
                                                        <div class="mt-3 text-gray-600">
                                                            Words: ${test.words.join(', ')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="mt-8 grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-red-800 mb-2">‚ö†Ô∏è Clear All Data</h3>
                                    <p class="text-red-600 mb-4">This will delete all students and progress.</p>
                                    <button onclick="clearAllData()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors w-full md:w-auto">
                                        üóëÔ∏è Delete Everything
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-blue-800 mb-2">üìä Export Data</h3>
                                    <p class="text-blue-600 mb-4">Download all progress as CSV.</p>
                                    <button onclick="exportData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors w-full md:w-auto">
                                        ‚¨áÔ∏è Download CSV
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            const studentNames = state.students.map(s => s.name);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="w-full max-w-4xl mx-auto">
                    <div class="game-card p-8 md:p-12">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl md:text-4xl font-bold">üìö Let's Get Started</h1>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                üè† Home
                            </button>
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">Select or add a student üë§</label>
                            
                            <div class="child-selector">
                                ${studentNames.map(name => `
                                    <div class="child-chip ${state.currentStudent === name ? 'selected' : ''}" 
                                         onclick="selectStudent('${name}')">
                                        ${name}
                                    </div>
                                `).join('')}
                                <div class="child-chip" onclick="addNewStudent()">
                                    ‚ûï New Student
                                </div>
                            </div>
                            
                            ${!state.currentStudent && studentNames.length > 0 ? `
                                <p class="text-sm text-orange-600 mt-2">‚ö†Ô∏è Please select a student or add a new one</p>
                            ` : ''}
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">Add spelling words üìù</label>
                            <div class="flex flex-col md:flex-row gap-3">
                                <input type="text" id="newWord" placeholder="Type a word..."
                                       class="flex-1 px-6 py-5 border-2 border-blue-300 rounded-2xl text-xl focus:border-blue-500 focus:outline-none"
                                       onkeypress="if(event.key==='Enter') addWord()">
                                <button onclick="addWord()" class="px-8 py-5 bg-blue-500 text-white rounded-2xl font-bold hover:bg-blue-600 transition-colors text-xl">
                                    Add Word
                                </button>
                            </div>
                        </div>

                        ${state.words.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="font-bold text-xl mb-4">Your Words (${state.words.length})</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${state.words.map((word, i) => `
                                        <div class="word-chip flex justify-between items-center group">
                                            <span class="font-bold text-lg capitalize">${word}</span>
                                            <button onclick="removeWord(${i})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-xl">
                                                ‚úï
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="startGame()" 
                                ${state.words.length === 0 || !state.currentStudent ? 'disabled' : ''}
                                class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-xl">
                            üöÄ Start Spelling Adventure!
                        </button>
                    </div>
                </div>
            `;
        }

        async function showHint(word) {
            state.isLoadingHint = true;
            state.showHint = true;
            render();
            
            const sentence = await getSentenceForWord(word);
            state.currentSentence = sentence;
            state.isLoadingHint = false;
            
            setTimeout(() => {
                speakText(sentence);
            }, 200);
            
            render();
        }

        function renderPlaying() {
            const app = document.getElementById('app');
            const progress = ((state.currentIndex + 1) / state.words.length) * 100;
            const currentWord = state.words[state.currentIndex];

            app.innerHTML = `
                <div class="w-full max-w-3xl mx-auto">
                    <div class="game-card p-8 md:p-12">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-3xl md:text-4xl font-bold">Hello, ${state.currentStudent}! ‚ú®</h2>
                                <p class="text-lg text-gray-600 mt-2">Click the buttons to hear the word</p>
                            </div>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                Exit
                            </button>
                        </div>

                        <div class="mb-8">
                            <div class="flex justify-between text-base md:text-lg mb-3">
                                <span class="font-medium">Word ${state.currentIndex + 1} of ${state.words.length}</span>
                                <span class="font-medium">Score: ${state.score} ‚≠ê</span>
                                <span class="font-medium">Streak: ${state.streak} üî•</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="progress-bar h-5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-8 mb-8">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üîä</div>
                                <p class="text-xl font-bold mb-2">Spelling Bee Word:</p>
                            </div>

                            <button onclick="speakWord('${currentWord}')" 
                                    class="speak-button w-full text-white px-8 py-6 rounded-2xl font-bold transform hover:scale-105 transition-all flex items-center justify-center gap-4 text-2xl">
                                <span class="text-3xl">üîä</span>
                                <span>SAY THE WORD</span>
                            </button>
                            
                            <button onclick="showHint('${currentWord}')"
                                    class="w-full mt-4 bg-purple-500 text-white px-8 py-5 rounded-2xl font-bold hover:bg-purple-600 transform hover:scale-105 transition-all flex items-center justify-center gap-3 text-xl">
                                üí° Use the word in a sentence
                            </button>

                            ${state.showHint ? `
                                <div class="audio-only-hint mt-6">
                                    ${state.isLoadingHint ? `
                                        <div class="flex flex-col items-center justify-center py-6">
                                            <div class="loading-spinner"></div>
                                            <p class="mt-4 text-purple-600 font-medium">Finding a sentence...</p>
                                        </div>
                                    ` : `
                                        <div class="flex flex-col items-center">
                                            <div class="text-5xl mb-4 animate-pulse">üéß</div>
                                            <p class="text-lg font-medium text-purple-700 mb-3">Listening to sentence...</p>
                                            <button onclick="speakHint()" class="mt-2 px-6 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-colors text-lg flex items-center justify-center gap-2">
                                                üîÅ Play Sentence Again
                                            </button>
                                        </div>
                                    `}
                                </div>
                            ` : ''}
                        </div>

                        <div class="mb-6">
                            <input type="text" id="answerInput" value="${state.userAnswer}"
                                   oninput="updateUserAnswer(this.value)"
                                   ${state.answered ? 'disabled' : ''}
                                   class="w-full px-8 py-6 text-2xl md:text-3xl text-center border-4 ${state.answered ? 'border-gray-300' : 'border-purple-400'} rounded-2xl font-bold focus:border-purple-500 focus:outline-none"
                                   placeholder="‚úèÔ∏è Type your answer..."
                                   autocomplete="off" autocorrect="off" spellcheck="false">
                        </div>

                        ${state.showAnswer ? `
                            <div class="p-8 rounded-2xl mb-6 text-center ${
                                state.userAnswer.toLowerCase().trim() === currentWord 
                                    ? 'bg-green-100 border-4 border-green-400' 
                                    : 'bg-red-100 border-4 border-red-400'
                            }">
                                <div class="text-6xl mb-4">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord ? '‚úì‚úì‚úì' : '‚úó‚úó‚úó'}
                                </div>
                                <p class="text-2xl md:text-3xl font-bold mb-3">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Lekker! You got it right!' 
                                        : `The correct spelling is: "${currentWord}"`}
                                </p>
                                <p class="text-xl text-gray-600">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Well done! üåü' 
                                        : 'Keep practicing - you\'ll get it next time! üí™'}
                                </p>
                            </div>
                        ` : ''}

                        ${!state.answered ? `
                            <button onclick="submitAnswer()" 
                                    class="w-full py-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-2xl font-bold rounded-2xl hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all shadow-xl">
                                ‚úÖ Check My Answer
                            </button>
                        ` : `
                            <button onclick="nextWord()" 
                                    class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all shadow-xl">
                                ${state.currentIndex < state.words.length - 1 ? 'üöÄ Next Word' : 'üéâ See My Results'}
                            </button>
                        `}
                    </div>
                </div>
            `;

            if (!state.answered) {
                setTimeout(() => document.getElementById('answerInput')?.focus(), 100);
            }
        }

        function renderResults() {
            const app = document.getElementById('app');
            const percentage = Math.round((state.score / state.words.length) * 100);
            
            let message = '';
            let emoji = '';
            let color = '';
            if (percentage === 100) {
                message = "PERFECT SCORE! You're a spelling champion!";
                emoji = "üèÜüåüüéâ";
                color = "from-yellow-400 to-orange-400";
            } else if (percentage >= 80) {
                message = "Excellent work! You're getting really good!";
                emoji = "üéâ‚ú®‚≠ê";
                color = "from-green-400 to-emerald-400";
            } else if (percentage >= 60) {
                message = "Good job! Keep practicing to get even better!";
                emoji = "üëçüìöüí™";
                color = "from-blue-400 to-indigo-400";
            } else {
                message = "Nice try! Every mistake helps you learn. Try again!";
                emoji = "üí™üåüüìù";
                color = "from-purple-400 to-pink-400";
            }

            app.innerHTML = `
                <div class="w-full max-w-3xl mx-auto">
                    <div class="game-card p-8 md:p-12">
                        <div class="flex justify-end mb-4">
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                üè† Home
                            </button>
                        </div>

                        <div class="text-center mb-8">
                            <div class="text-8xl mb-6 animate-bounce">${emoji}</div>
                            <h2 class="text-4xl md:text-5xl font-bold mb-4">Great job, ${state.currentStudent}!</h2>
                            <p class="text-2xl text-gray-600">${message}</p>
                        </div>

                        <div class="bg-gradient-to-r ${color} rounded-2xl p-10 mb-8 text-white text-center">
                            <div class="text-7xl font-bold mb-4">${state.score}/${state.words.length}</div>
                            <div class="text-4xl font-bold mb-4">${percentage}%</div>
                            <div class="text-2xl">Words correct: ${state.score}</div>
                        </div>

                        <h3 class="text-3xl font-bold mb-6">Your Results:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-10">
                            ${state.words.map((word, i) => `
                                <div class="p-5 rounded-xl ${state.correctAnswers.includes(i) ? 'bg-green-100 border-2 border-green-400' : 'bg-red-100 border-2 border-red-400'} flex justify-between items-center">
                                    <span class="font-bold text-xl capitalize">${word}</span>
                                    <span class="text-3xl ${state.correctAnswers.includes(i) ? 'correct-icon' : 'incorrect-icon'}">
                                        ${state.correctAnswers.includes(i) ? '‚úì‚úì' : '‚úó‚úó'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="practiceAgain()" 
                                    class="py-5 bg-purple-500 text-white text-xl font-bold rounded-xl hover:bg-purple-600 transform hover:scale-105 transition-all">
                                üîÑ Practice Again
                            </button>
                            <button onclick="newWords()"
                                    class="py-5 bg-blue-500 text-white text-xl font-bold rounded-xl hover:bg-blue-600 transform hover:scale-105 transition-all">
                                ‚ûï New Words
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== STUDENT FUNCTIONS ====================
        function selectStudent(name) {
            state.currentStudent = name;
            loadStudentData(name);
            saveToStorage();
            render();
        }

        function addNewStudent() {
            const name = prompt("Enter student's name:");
            if (name && name.trim()) {
                const trimmedName = name.trim();
                
                if (!state.students.find(s => s.name === trimmedName)) {
                    const newStudent = { 
                        name: trimmedName, 
                        bestStreak: 0, 
                        totalWords: 0, 
                        testResults: [] 
                    };
                    state.students.push(newStudent);
                }
                
                state.currentStudent = trimmedName;
                loadStudentData(trimmedName);
                saveToStorage();
                render();
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function exportData() {
            const data = [];
            
            state.students.forEach(student => {
                (student.testResults || []).forEach(test => {
                    data.push({
                        Student: student.name,
                        Date: new Date(test.date).toLocaleDateString(),
                        Score: `${test.score}/${test.total}`,
                        Percentage: `${test.percentage}%`,
                        Words: test.words.join('; ')
                    });
                });
            });
            
            if (data.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spello-progress-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function convertToCSV(objArray) {
            if (objArray.length === 0) return '';
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            const headers = Object.keys(array[0]);
            let str = headers.join(',') + '\r\n';
            return array.reduce((str, next) => {
                str += headers.map(header => `"${next[header] || ''}"`).join(',') + '\r\n';
                return str;
            }, str);
        }

        // ==================== EVENT HANDLERS ====================
        function startLearning() { 
            state.mode = 'student'; 
            state.gameState = 'setup';
            render(); 
        }
        
        function openParentDashboard() { 
            state.mode = 'parent'; 
            render(); 
        }
        
        function goHome() { 
            state.mode = 'home'; 
            render(); 
        }

        function updateStudentName(name) { state.studentName = name; }
        function updateUserAnswer(answer) { state.userAnswer = answer; }

        function addWord() {
            const input = document.getElementById('newWord');
            const word = input.value.trim().toLowerCase();
            if (word && !state.words.includes(word)) {
                state.words.push(word);
                input.value = '';
                render();
            }
        }

        function removeWord(index) {
            state.words.splice(index, 1);
            render();
        }

        function startGame() {
            if (state.words.length > 0 && state.currentStudent) {
                state.gameState = 'playing';
                state.currentIndex = 0;
                state.score = 0;
                state.correctAnswers = [];
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.streak = 0;
                state.showHint = false;
                state.currentSentence = '';
                render();
            }
        }

        function speakWord(word) {
            speakText(word);
        }

        function speakHint() {
            if (state.currentSentence) {
                speakText(state.currentSentence);
            }
        }

        function submitAnswer() {
            const input = document.getElementById('answerInput');
            if (input) {
                state.userAnswer = input.value;
            }
            checkAnswer();
            render();
        }

        function checkAnswer() {
            const correct = state.userAnswer.toLowerCase().trim() === state.words[state.currentIndex];
            if (correct) {
                state.score++;
                state.correctAnswers.push(state.currentIndex);
                state.streak++;
                if (state.streak > state.bestStreak) {
                    state.bestStreak = state.streak;
                }
                state.totalWords++;
            } else {
                state.streak = 0;
            }
            state.showAnswer = true;
            state.answered = true;
        }

        function nextWord() {
            if (state.currentIndex < state.words.length - 1) {
                state.currentIndex++;
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.showHint = false;
                state.currentSentence = '';
                render();
            } else {
                finishGame();
            }
        }

        function finishGame() {
            const result = {
                studentName: state.currentStudent,
                date: new Date().toISOString(),
                words: [...state.words],
                score: state.score,
                total: state.words.length,
                percentage: Math.round((state.score / state.words.length) * 100),
                correctAnswers: [...state.correctAnswers]
            };
            
            state.testResults.push(result);
            
            // Update student data
            const studentIndex = state.students.findIndex(s => s.name === state.currentStudent);
            if (studentIndex >= 0) {
                state.students[studentIndex].bestStreak = Math.max(state.students[studentIndex].bestStreak || 0, state.bestStreak);
                state.students[studentIndex].totalWords = (state.students[studentIndex].totalWords || 0) + state.score;
                state.students[studentIndex].testResults = state.students[studentIndex].testResults || [];
                state.students[studentIndex].testResults.push(result);
            }
            
            saveToStorage();
            
            state.gameState = 'results';
            render();
        }

        function practiceAgain() {
            state.gameState = 'playing';
            state.currentIndex = 0;
            state.score = 0;
            state.correctAnswers = [];
            state.userAnswer = '';
            state.showAnswer = false;
            state.answered = false;
            state.streak = 0;
            state.showHint = false;
            state.currentSentence = '';
            render();
        }

        function newWords() {
            state.words = [];
            state.gameState = 'setup';
            render();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Delete ALL students and progress? This cannot be undone!')) {
                localStorage.clear();
                state.students = [];
                state.currentStudent = '';
                state.testResults = [];
                state.totalWords = 0;
                state.bestStreak = 0;
                state.words = [];
                state.gameState = 'setup';
                sentenceCache.clear();
                render();
            }
        }

        // Make functions globally available
        window.toggleDarkMode = toggleDarkMode;
        window.showHelp = showHelp;
        window.hideHelp = hideHelp;
        window.startLearning = startLearning;
        window.openParentDashboard = openParentDashboard;
        window.goHome = goHome;
        window.updateStudentName = updateStudentName;
        window.updateUserAnswer = updateUserAnswer;
        window.addWord = addWord;
        window.removeWord = removeWord;
        window.startGame = startGame;
        window.speakWord = speakWord;
        window.speakHint = speakHint;
        window.showHint = showHint;
        window.submitAnswer = submitAnswer;
        window.nextWord = nextWord;
        window.practiceAgain = practiceAgain;
        window.newWords = newWords;
        window.clearAllData = clearAllData;
        window.exportData = exportData;
        window.selectStudent = selectStudent;
        window.addNewStudent = addNewStudent;

        // Initial render
        render();
    </script>
</body>
</html>