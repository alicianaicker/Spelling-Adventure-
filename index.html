<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Spelling Adventure - South African English</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        /* Dark mode styles */
        .dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #2d1b4b 100%) !important;
        }
        
        .dark-mode .card {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        
        .dark-mode .card-header {
            border-bottom-color: #334155 !important;
        }
        
        .dark-mode .text-gray-600, 
        .dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        .dark-mode .stat-card {
            background-color: #2d3a4f !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode .stat-card div {
            color: #f1f5f9 !important;
        }
        
        .dark-mode input {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #64748b !important;
        }
        
        .dark-mode input::placeholder {
            color: #94a3b8 !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-yellow-100 {
            background-color: #422f1f !important;
            color: #fcd34d !important;
        }
        
        .dark-mode .bg-green-100 {
            background-color: #1f4030 !important;
            color: #6ee7b7 !important;
        }
        
        .dark-mode .bg-blue-100 {
            background-color: #1e3a5f !important;
            color: #93c5fd !important;
        }
        
        .dark-mode .bg-purple-100 {
            background-color: #352d5e !important;
            color: #c4b5fd !important;
        }
        
        .dark-mode .bg-red-100 {
            background-color: #542c2c !important;
            color: #fca5a5 !important;
        }
        
        .correct-icon {
            color: #10b981;
            animation: pop 0.3s ease;
        }
        
        .incorrect-icon {
            color: #ef4444;
            animation: shake 0.3s ease;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .stat-card {
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
        }
        
        .dark-mode .theme-toggle {
            background: rgba(30, 41, 59, 0.9);
            border-color: #64748b;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
        }
        
        .speak-button {
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .speak-button:active {
            transform: scale(0.95);
        }
        
        .hint-card {
            background: linear-gradient(135deg, #f3e8ff, #ede9fe);
            border-left: 6px solid #8b5cf6;
        }
        
        .dark-mode .hint-card {
            background: linear-gradient(135deg, #2e293a, #1e1a2a);
            border-left-color: #a78bfa;
        }
        
        .game-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .dark-mode .game-card {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s ease;
        }
        
        .word-chip {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            border: 1px solid #c084fc;
        }
        
        .dark-mode .word-chip {
            background: linear-gradient(135deg, #2e293a, #2a2438);
            border-color: #6b21a8;
        }
        
        .full-height {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        @media (max-width: 640px) {
            .full-height {
                padding: 12px;
            }
        }
    </style>
</head>
<body id="body" class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600">
    <div id="app" class="full-height"></div>
    
    <!-- Theme Toggle - Fixed position separate from app -->
    <button onclick="window.toggleDarkMode()" class="theme-toggle">
        <span id="theme-icon">üåô</span>
    </button>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let state = {
            mode: 'home',
            gameState: 'setup',
            studentName: '',
            words: [],
            currentIndex: 0,
            userAnswer: '',
            score: 0,
            showAnswer: false,
            answered: false,
            correctAnswers: [],
            streak: 0,
            bestStreak: parseInt(localStorage.getItem('bestStreak') || '0'),
            totalWords: parseInt(localStorage.getItem('totalWords') || '0'),
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            showHint: false,
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // Apply dark mode on load
        if (state.darkMode) {
            document.getElementById('body').classList.add('dark-mode');
            document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        }

        // ==================== SOUTH AFRICAN SPEECH FUNCTIONS ====================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    
                    // Try South African voices
                    let selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-ZA') || 
                        voice.name.includes('South African') ||
                        voice.name.includes('Tessa') ||
                        voice.name.includes('Zola')
                    );
                    
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.includes('en-'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.rate = 0.75;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    window.speechSynthesis.speak(utterance);
                }, 100);
            }
        }

        // Pre-load voices
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = function() {
                window.speechSynthesis.getVoices();
            };
        }

        // ==================== CONTEXTUAL HINT SYSTEM ====================
        function getContextualHint(word) {
            word = word.toLowerCase().trim();
            
            // Animal hints
            if (word === 'cat') return "This furry friend says 'meow' and loves to nap in the sun.";
            if (word === 'dog') return "People call this animal 'man's best friend' and it loves to wag its tail.";
            if (word === 'fish') return "This creature lives in water and swims using its fins.";
            if (word === 'bird') return "This animal has feathers and can fly through the sky.";
            if (word === 'rabbit') return "This fluffy animal has long ears and loves to hop.";
            if (word === 'horse') return "People ride this tall animal with a mane and tail.";
            if (word === 'cow') return "This farm animal gives us milk and says 'moo'.";
            if (word === 'lion') return "Known as the king of the jungle, this big cat has a mighty roar.";
            if (word === 'tiger') return "This striped big cat is orange with black stripes.";
            if (word === 'elephant') return "The largest land animal with a long trunk and big tusks.";
            
            // Food hints
            if (word === 'apple') return "A crunchy fruit that can be red, green, or yellow. Good for keeping doctors away!";
            if (word === 'banana') return "A long yellow fruit that monkeys love to eat. You need to peel it first.";
            if (word === 'bread') return "A food made from flour that you toast in the morning for breakfast.";
            if (word === 'milk') return "A white drink that comes from cows. Good for strong bones!";
            if (word === 'water') return "The clear liquid we drink every day to stay healthy.";
            if (word === 'cake') return "A sweet dessert with icing that people have on birthdays.";
            if (word === 'pizza') return "An Italian dish with a round base, tomato sauce, and cheese on top.";
            if (word === 'rice') return "Small white grains that are a staple food in many countries.";
            if (word === 'soup') return "A warm liquid food eaten with a spoon, especially when you're sick.";
            if (word === 'egg') return "A food that comes from chickens. You can have it fried or boiled.";
            
            // Action hints
            if (word === 'run') return "To move quickly using your legs, faster than walking.";
            if (word === 'jump') return "To push yourself off the ground and land somewhere else.";
            if (word === 'swim') return "To move through water using your arms and legs.";
            if (word === 'fly') return "To move through the air like a bird or an aeroplane.";
            if (word === 'eat') return "To put food in your mouth and swallow it.";
            if (word === 'drink') return "To take liquid into your body through your mouth.";
            if (word === 'sleep') return "To rest with your eyes closed at night.";
            if (word === 'play') return "To have fun with toys, games, or friends.";
            if (word === 'read') return "To look at words in a book and understand them.";
            if (word === 'write') return "To put words on paper using a pen or pencil.";
            
            // Color hints
            if (word === 'red') return "The colour of a ripe apple, a fire truck, or a rose.";
            if (word === 'blue') return "The colour of the sky on a clear day and the deep ocean.";
            if (word === 'green') return "The colour of grass, leaves on trees, and fresh vegetables.";
            if (word === 'yellow') return "The colour of the sun, bananas, and bright flowers.";
            if (word === 'orange') return "A mix of red and yellow, like the fruit with the same name.";
            if (word === 'purple') return "The colour of grapes and some pretty flowers.";
            if (word === 'brown') return "The colour of chocolate, tree trunks, and soil.";
            if (word === 'black') return "The colour of night sky and coal.";
            if (word === 'white') return "The colour of snow, milk, and clouds.";
            if (word === 'pink') return "A soft colour often seen in flowers and candy.";
            
            // Object hints
            if (word === 'ball') return "A round object you can throw, catch, or kick in games.";
            if (word === 'car') return "A vehicle with four wheels that takes people places.";
            if (word === 'book') return "Something with pages that you read to learn or enjoy stories.";
            if (word === 'pen') return "A tool with ink inside for writing on paper.";
            if (word === 'chair') return "Furniture with legs and a back that you sit on.";
            if (word === 'table') return "Furniture with a flat top where you eat meals or work.";
            if (word === 'door') return "A moving panel that opens to let you into a room.";
            if (word === 'window') return "A glass opening in a wall that lets you see outside.";
            if (word === 'house') return "A building where people live with their family.";
            if (word === 'school') return "A place where children go to learn from teachers.";
            
            // People hints
            if (word === 'mom') return "The woman who gave birth to you and takes care of you.";
            if (word === 'dad') return "The man in your family who loves and protects you.";
            if (word === 'baby') return "A very young child who can't walk or talk yet.";
            if (word === 'girl') return "A young female child who might play with dolls.";
            if (word === 'boy') return "A young male child who might play with trucks.";
            if (word === 'teacher') return "A person who helps students learn at school.";
            if (word === 'doctor') return "A person who helps sick people feel better.";
            if (word === 'friend') return "Someone you like to spend time and play with.";
            
            // Place hints
            if (word === 'park') return "An outdoor area with grass, trees, and playgrounds for fun.";
            if (word === 'beach') return "A sandy place by the ocean where you can swim and build sandcastles.";
            if (word === 'store') return "A place where you go to buy things like food and toys.";
            if (word === 'home') return "The place where you live with your family.";
            if (word === 'zoo') return "A place where you can see many different animals.";
            
            // Weather hints
            if (word === 'rain') return "Water that falls from clouds in drops.";
            if (word === 'snow') return "Soft white frozen water that falls in winter.";
            if (word === 'wind') return "Moving air that you can feel but not see.";
            if (word === 'cloud') return "Fluffy white shapes in the sky made of water drops.";
            if (word === 'sun') return "The bright star in the sky that gives us light and warmth.";
            
            // Word pattern hints
            if (word.endsWith('ing')) return "This word describes an action that is happening right now.";
            if (word.endsWith('ed')) return "This word describes something that already happened in the past.";
            if (word.endsWith('er') || word.endsWith('or')) return "This word describes a person who does a specific job or action.";
            if (word.endsWith('ful')) return "This word describes something that is full of a certain quality.";
            if (word.endsWith('less')) return "This word describes something that is without a certain quality.";
            
            // Length-based hints
            if (word.length > 8) return `This is a long word with ${word.length} letters. Take your time spelling it!`;
            if (word.length <= 4) return "This is a short word that you use often in daily life.";
            
            // Double letter check
            for (let i = 0; i < word.length - 1; i++) {
                if (word[i] === word[i + 1]) {
                    return `Be careful - this word has two ${word[i]} letters together in the middle.`;
                }
            }
            
            // Default hints for any word
            const defaultHints = [
                "Listen carefully to the sounds in this word.",
                "Think about each letter as you spell it.",
                "Try saying the word slowly to hear all the sounds.",
                "Break the word into smaller parts to spell it.",
                "Focus on the beginning, middle, and end of the word.",
                "Take a deep breath and spell it one letter at a time.",
                "You know this word - just trust your ears!"
            ];
            
            return defaultHints[Math.floor(Math.random() * defaultHints.length)];
        }

        // ==================== DARK MODE TOGGLE ====================
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            
            const body = document.getElementById('body');
            const icon = document.getElementById('theme-icon');
            
            if (state.darkMode) {
                body.classList.add('dark-mode');
                icon.textContent = '‚òÄÔ∏è';
            } else {
                body.classList.remove('dark-mode');
                icon.textContent = 'üåô';
            }
            
            render();
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            
            if (state.mode === 'home') {
                app.innerHTML = `
                    <div class="w-full max-w-6xl mx-auto">
                        <div class="game-card rounded-3xl shadow-2xl p-6 md:p-10">
                            <div class="text-center mb-10">
                                <h1 class="text-5xl md:text-7xl font-bold mb-4 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600 bg-clip-text text-transparent">
                                    ‚ú® Spelling Adventure ‚ú®
                                </h1>
                                <p class="text-xl md:text-2xl text-gray-600">South African English Edition üáøüá¶</p>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-12">
                                <div class="stat-card bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-sm md:text-base text-yellow-700 font-medium">Best Streak üî•</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-green-800">${state.totalWords}</div>
                                    <div class="text-sm md:text-base text-green-700 font-medium">Words Mastered üìö</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-blue-800">${state.testResults.length}</div>
                                    <div class="text-sm md:text-base text-blue-700 font-medium">Tests Done üìù</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-purple-800">${state.words.length}</div>
                                    <div class="text-sm md:text-base text-purple-700 font-medium">Words Ready üéØ</div>
                                </div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                                <button onclick="startLearning()" 
                                        class="flex-1 py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all shadow-xl">
                                    üöÄ Start Learning
                                </button>
                                <button onclick="openParentDashboard()" 
                                        class="flex-1 py-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-2xl font-bold rounded-2xl hover:from-blue-600 hover:to-indigo-700 transform hover:scale-105 transition-all shadow-xl">
                                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.mode === 'parent') {
                renderParent();
            }
            else if (state.mode === 'student') {
                if (state.gameState === 'setup') renderSetup();
                else if (state.gameState === 'playing') renderPlaying();
                else if (state.gameState === 'results') renderResults();
            }
        }

        function renderParent() {
            const app = document.getElementById('app');
            
            const totalTests = state.testResults.length;
            const averageScore = totalTests > 0 
                ? Math.round(state.testResults.reduce((acc, t) => acc + t.percentage, 0) / totalTests) 
                : 0;
            
            const studentMap = new Map();
            state.testResults.forEach(test => {
                if (!studentMap.has(test.studentName)) {
                    studentMap.set(test.studentName, {
                        tests: [],
                        totalCorrect: 0,
                        totalWords: 0
                    });
                }
                const student = studentMap.get(test.studentName);
                student.tests.push(test);
                student.totalCorrect += test.score;
                student.totalWords += test.total;
            });

            app.innerHTML = `
                <div class="w-full max-w-7xl mx-auto">
                    <div class="game-card rounded-3xl shadow-2xl p-6 md:p-10">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 class="text-3xl md:text-4xl font-bold">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h1>
                            <button onclick="goHome()" class="px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors text-lg font-bold w-full md:w-auto">
                                üè† Back to Home
                            </button>
                        </div>

                        ${totalTests === 0 ? `
                            <div class="text-center py-20 bg-gray-50 rounded-3xl">
                                <div class="text-8xl mb-6">üìä</div>
                                <h3 class="text-3xl font-bold text-gray-700 mb-3">No Data Yet</h3>
                                <p class="text-xl text-gray-500 mb-8">Complete some spelling tests to see progress here!</p>
                                <button onclick="startLearning()" class="px-10 py-5 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600 text-xl">
                                    üöÄ Start Your First Test
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                                <div class="bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-blue-800">${totalTests}</div>
                                    <div class="text-sm text-blue-600">Total Tests</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-green-800">${averageScore}%</div>
                                    <div class="text-sm text-green-600">Average Score</div>
                                </div>
                                <div class="bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-purple-800">${state.totalWords}</div>
                                    <div class="text-sm text-purple-600">Words Mastered</div>
                                </div>
                                <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-sm text-yellow-600">Best Streak</div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                ${Array.from(studentMap.entries()).map(([name, data]) => {
                                    const studentAvg = Math.round((data.totalCorrect / data.totalWords) * 100);
                                    const recentTests = data.tests.slice(-5).reverse();
                                    
                                    return `
                                        <div class="bg-gray-50 rounded-2xl p-6 md:p-8">
                                            <div class="flex items-center gap-4 mb-6">
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                                    ${name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <h2 class="text-3xl font-bold">${name}</h2>
                                                    <p class="text-gray-600 text-lg">${data.tests.length} tests completed</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-4 mb-6">
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-blue-600">${studentAvg}%</div>
                                                    <div class="text-sm text-gray-500">Average</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-green-600">${data.totalCorrect}</div>
                                                    <div class="text-sm text-gray-500">Correct</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-purple-600">${data.totalWords}</div>
                                                    <div class="text-sm text-gray-500">Total Words</div>
                                                </div>
                                            </div>
                                            
                                            <h3 class="font-bold text-xl mb-4">üìã Recent Tests</h3>
                                            <div class="space-y-4">
                                                ${recentTests.map(test => `
                                                    <div class="bg-white rounded-xl p-5 border-l-4 ${test.percentage >= 80 ? 'border-green-500' : 'border-yellow-500'}">
                                                        <div class="flex justify-between items-center mb-3">
                                                            <span class="font-bold text-lg">${test.score}/${test.total} words correct</span>
                                                            <span class="text-gray-500">${new Date(test.date).toLocaleDateString()}</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                                            <div class="bg-${test.percentage >= 80 ? 'green' : 'yellow'}-500 h-3 rounded-full" style="width: ${test.percentage}%"></div>
                                                        </div>
                                                        <div class="mt-3 text-gray-600">
                                                            Words: ${test.words.join(', ')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="mt-8 bg-gray-50 rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4">üìà Progress Over Time</h3>
                                <div class="h-48 flex items-end justify-between gap-2">
                                    ${state.testResults.slice(-10).map((test, i) => `
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-gradient-to-t from-blue-500 to-purple-500 rounded-t-lg transition-all hover:from-blue-600 hover:to-purple-600" 
                                                 style="height: ${test.percentage * 1.5}%"></div>
                                            <span class="text-xs text-gray-600 mt-2">Test ${i+1}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="mt-8 grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-red-800 mb-2">‚ö†Ô∏è Clear All Data</h3>
                                    <p class="text-red-600 mb-4">This will delete all progress for all students.</p>
                                    <button onclick="clearAllData()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors w-full md:w-auto">
                                        üóëÔ∏è Delete Everything
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-blue-800 mb-2">üìä Export Data</h3>
                                    <p class="text-blue-600 mb-4">Download progress as a CSV file.</p>
                                    <button onclick="exportData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors w-full md:w-auto">
                                        ‚¨áÔ∏è Download CSV
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card rounded-3xl shadow-2xl p-6 md:p-10">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl md:text-4xl font-bold">üìö Let's Get Started</h1>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                üè† Home
                            </button>
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">What's your name? üåü</label>
                            <input type="text" id="studentNameInput" value="${state.studentName}" 
                                   oninput="updateStudentName(this.value)"
                                   class="w-full px-6 py-5 border-2 border-purple-300 rounded-2xl text-xl focus:border-purple-500 focus:outline-none"
                                   placeholder="Enter your name...">
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">Add spelling words üìù</label>
                            <div class="flex flex-col md:flex-row gap-3">
                                <input type="text" id="newWord" placeholder="Type a word..."
                                       class="flex-1 px-6 py-5 border-2 border-blue-300 rounded-2xl text-xl focus:border-blue-500 focus:outline-none"
                                       onkeypress="if(event.key==='Enter') addWord()">
                                <button onclick="addWord()" class="px-8 py-5 bg-blue-500 text-white rounded-2xl font-bold hover:bg-blue-600 transition-colors text-xl">
                                    Add Word
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">‚ú® Any word works - we'll give you a helpful hint!</p>
                        </div>

                        ${state.words.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="font-bold text-xl mb-4">Your Words (${state.words.length})</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${state.words.map((word, i) => `
                                        <div class="word-chip rounded-xl p-4 flex justify-between items-center group">
                                            <span class="font-bold text-lg capitalize">${word}</span>
                                            <button onclick="removeWord(${i})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-xl">
                                                ‚úï
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="startGame()" 
                                ${state.words.length === 0 || !state.studentName.trim() ? 'disabled' : ''}
                                class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-xl">
                            üöÄ Start Spelling Adventure!
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlaying() {
            const app = document.getElementById('app');
            const progress = ((state.currentIndex + 1) / state.words.length) * 100;
            const currentWord = state.words[state.currentIndex];
            const hint = getContextualHint(currentWord);

            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card rounded-3xl shadow-2xl p-6 md:p-10">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-3xl md:text-4xl font-bold">Hello, ${state.studentName}! ‚ú®</h2>
                                <p class="text-lg text-gray-600 mt-2">Listen and spell the word</p>
                            </div>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                Exit
                            </button>
                        </div>

                        <div class="mb-8">
                            <div class="flex justify-between text-base md:text-lg mb-3">
                                <span class="font-medium">Word ${state.currentIndex + 1} of ${state.words.length}</span>
                                <span class="font-medium">Score: ${state.score} ‚≠ê</span>
                                <span class="font-medium">Streak: ${state.streak} üî•</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="progress-bar h-5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-8 mb-8">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üîä</div>
                                <p class="text-xl font-bold mb-6">Click the button to hear the word:</p>
                            </div>

                            <button onclick="speakWord('${currentWord}')" 
                                    class="speak-button w-full text-white px-8 py-6 rounded-2xl font-bold transform hover:scale-105 transition-all flex items-center justify-center gap-4 text-2xl">
                                <span class="text-3xl">üîä</span>
                                <span>SAY THE WORD</span>
                            </button>
                            
                            <button onclick="toggleHint('${currentWord}')"
                                    class="w-full mt-4 bg-purple-500 text-white px-8 py-5 rounded-2xl font-bold hover:bg-purple-600 transform hover:scale-105 transition-all flex items-center justify-center gap-3 text-xl">
                                üí° Need a Hint?
                            </button>

                            ${state.showHint ? `
                                <div class="hint-card mt-6 p-6 rounded-2xl">
                                    <p class="text-lg md:text-xl leading-relaxed">${hint}</p>
                                    <button onclick="speakHint('${currentWord}')" class="mt-4 w-full px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-colors text-lg flex items-center justify-center gap-2">
                                        üîÅ Hear Hint Again
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="mb-6">
                            <input type="text" id="answerInput" value="${state.userAnswer}"
                                   oninput="updateUserAnswer(this.value)"
                                   ${state.answered ? 'disabled' : ''}
                                   class="w-full px-8 py-6 text-2xl md:text-3xl text-center border-4 ${state.answered ? 'border-gray-300' : 'border-purple-400'} rounded-2xl font-bold focus:border-purple-500 focus:outline-none"
                                   placeholder="‚úèÔ∏è Type your answer..."
                                   autocomplete="off" autocorrect="off" spellcheck="false">
                        </div>

                        ${state.showAnswer ? `
                            <div class="p-8 rounded-2xl mb-6 text-center ${
                                state.userAnswer.toLowerCase().trim() === currentWord 
                                    ? 'bg-green-100 border-4 border-green-400' 
                                    : 'bg-red-100 border-4 border-red-400'
                            }">
                                <div class="text-6xl mb-4">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord ? '‚úì‚úì‚úì' : '‚úó‚úó‚úó'}
                                </div>
                                <p class="text-2xl md:text-3xl font-bold mb-3">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Lekker! You got it right!' 
                                        : `The correct spelling is: "${currentWord}"`}
                                </p>
                                <p class="text-xl text-gray-600">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Well done! üåü' 
                                        : 'Keep practicing - you\'ll get it next time! üí™'}
                                </p>
                            </div>
                        ` : ''}

                        ${!state.answered ? `
                            <button onclick="submitAnswer()" 
                                    class="w-full py-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-2xl font-bold rounded-2xl hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all shadow-xl">
                                ‚úÖ Check My Answer
                            </button>
                        ` : `
                            <button onclick="nextWord()" 
                                    class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all shadow-xl">
                                ${state.currentIndex < state.words.length - 1 ? 'üöÄ Next Word' : 'üéâ See My Results'}
                            </button>
                        `}
                    </div>
                </div>
            `;

            if (!state.answered) {
                setTimeout(() => document.getElementById('answerInput')?.focus(), 100);
            }
        }

        function renderResults() {
            const app = document.getElementById('app');
            const percentage = Math.round((state.score / state.words.length) * 100);
            
            let message = '';
            let emoji = '';
            let color = '';
            if (percentage === 100) {
                message = "PERFECT SCORE! You're a spelling champion!";
                emoji = "üèÜüåüüéâ";
                color = "from-yellow-400 to-orange-400";
            } else if (percentage >= 80) {
                message = "Excellent work! You're getting really good!";
                emoji = "üéâ‚ú®‚≠ê";
                color = "from-green-400 to-emerald-400";
            } else if (percentage >= 60) {
                message = "Good job! Keep practicing to get even better!";
                emoji = "üëçüìöüí™";
                color = "from-blue-400 to-indigo-400";
            } else {
                message = "Nice try! Every mistake helps you learn. Try again!";
                emoji = "üí™üåüüìù";
                color = "from-purple-400 to-pink-400";
            }

            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card rounded-3xl shadow-2xl p-6 md:p-10">
                        <div class="flex justify-end mb-4">
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                üè† Home
                            </button>
                        </div>

                        <div class="text-center mb-8">
                            <div class="text-8xl mb-6 animate-bounce">${emoji}</div>
                            <h2 class="text-4xl md:text-5xl font-bold mb-4">Great job, ${state.studentName}!</h2>
                            <p class="text-2xl text-gray-600">${message}</p>
                        </div>

                        <div class="bg-gradient-to-r ${color} rounded-2xl p-10 mb-8 text-white text-center">
                            <div class="text-7xl font-bold mb-4">${state.score}/${state.words.length}</div>
                            <div class="text-4xl font-bold mb-4">${percentage}%</div>
                            <div class="text-2xl">Words correct: ${state.score}</div>
                        </div>

                        <h3 class="text-3xl font-bold mb-6">Your Results:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-10">
                            ${state.words.map((word, i) => `
                                <div class="p-5 rounded-xl ${state.correctAnswers.includes(i) ? 'bg-green-100 border-2 border-green-400' : 'bg-red-100 border-2 border-red-400'} flex justify-between items-center">
                                    <span class="font-bold text-xl capitalize">${word}</span>
                                    <span class="text-3xl ${state.correctAnswers.includes(i) ? 'correct-icon' : 'incorrect-icon'}">
                                        ${state.correctAnswers.includes(i) ? '‚úì‚úì' : '‚úó‚úó'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="practiceAgain()" 
                                    class="py-5 bg-purple-500 text-white text-xl font-bold rounded-xl hover:bg-purple-600 transform hover:scale-105 transition-all">
                                üîÑ Practice Again
                            </button>
                            <button onclick="newWords()"
                                    class="py-5 bg-blue-500 text-white text-xl font-bold rounded-xl hover:bg-blue-600 transform hover:scale-105 transition-all">
                                ‚ûï New Words
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function exportData() {
            const data = state.testResults.map(r => ({
                Student: r.studentName,
                Date: new Date(r.date).toLocaleDateString(),
                Score: `${r.score}/${r.total}`,
                Percentage: `${r.percentage}%`,
                Words: r.words.join('; ')
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spelling-progress-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function convertToCSV(objArray) {
            if (objArray.length === 0) return '';
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = Object.keys(array[0]).join(',') + '\r\n';
            return array.reduce((str, next) => {
                str += Object.values(next).map(value => `"${value}"`).join(',') + '\r\n';
                return str;
            }, str);
        }

        // ==================== EVENT HANDLERS ====================
        function startLearning() { state.mode = 'student'; render(); }
        function openParentDashboard() { state.mode = 'parent'; render(); }
        function goHome() { state.mode = 'home'; render(); }

        function updateStudentName(name) { state.studentName = name; }
        function updateUserAnswer(answer) { state.userAnswer = answer; }

        function addWord() {
            const input = document.getElementById('newWord');
            const word = input.value.trim().toLowerCase();
            if (word && !state.words.includes(word)) {
                state.words.push(word);
                input.value = '';
                render();
            }
        }

        function removeWord(index) {
            state.words.splice(index, 1);
            render();
        }

        function startGame() {
            if (state.words.length > 0 && state.studentName.trim()) {
                state.gameState = 'playing';
                state.currentIndex = 0;
                state.score = 0;
                state.correctAnswers = [];
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.streak = 0;
                state.showHint = false;
                render();
            }
        }

        function speakWord(word) {
            speakText(word);
        }

        function speakHint(word) {
            const hint = getContextualHint(word);
            speakText(hint);
        }

        function toggleHint(word) {
            state.showHint = !state.showHint;
            render();
        }

        function submitAnswer() {
            const input = document.getElementById('answerInput');
            if (input) {
                state.userAnswer = input.value;
            }
            checkAnswer();
            render();
        }

        function checkAnswer() {
            const correct = state.userAnswer.toLowerCase().trim() === state.words[state.currentIndex];
            if (correct) {
                state.score++;
                state.correctAnswers.push(state.currentIndex);
                state.streak++;
                if (state.streak > state.bestStreak) {
                    state.bestStreak = state.streak;
                    localStorage.setItem('bestStreak', state.bestStreak);
                }
                state.totalWords++;
                localStorage.setItem('totalWords', state.totalWords);
            } else {
                state.streak = 0;
            }
            state.showAnswer = true;
            state.answered = true;
        }

        function nextWord() {
            if (state.currentIndex < state.words.length - 1) {
                state.currentIndex++;
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.showHint = false;
                render();
            } else {
                finishGame();
            }
        }

        function finishGame() {
            const result = {
                studentName: state.studentName,
                date: new Date().toISOString(),
                words: [...state.words],
                score: state.score,
                total: state.words.length,
                percentage: Math.round((state.score / state.words.length) * 100),
                correctAnswers: [...state.correctAnswers]
            };
            state.testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(state.testResults));
            state.gameState = 'results';
            render();
        }

        function practiceAgain() {
            state.gameState = 'playing';
            state.currentIndex = 0;
            state.score = 0;
            state.correctAnswers = [];
            state.userAnswer = '';
            state.showAnswer = false;
            state.answered = false;
            state.streak = 0;
            state.showHint = false;
            render();
        }

        function newWords() {
            state.words = [];
            state.gameState = 'setup';
            render();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è Delete ALL progress? This cannot be undone!')) {
                localStorage.clear();
                state.testResults = [];
                state.totalWords = 0;
                state.bestStreak = 0;
                render();
            }
        }

        // Make functions globally available
        window.toggleDarkMode = toggleDarkMode;
        window.startLearning = startLearning;
        window.openParentDashboard = openParentDashboard;
        window.goHome = goHome;
        window.updateStudentName = updateStudentName;
        window.updateUserAnswer = updateUserAnswer;
        window.addWord = addWord;
        window.removeWord = removeWord;
        window.startGame = startGame;
        window.speakWord = speakWord;
        window.speakHint = speakHint;
        window.toggleHint = toggleHint;
        window.submitAnswer = submitAnswer;
        window.nextWord = nextWord;
        window.practiceAgain = practiceAgain;
        window.newWords = newWords;
        window.clearAllData = clearAllData;
        window.exportData = exportData;

        // Initial render
        render();
    </script>
</body>
</html>