<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Spelling Adventure - South African English</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            width: 100%;
            transition: background 0.3s ease;
        }
        
        /* Dark mode styles */
        .dark-mode {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #2d1b4b 100%) !important;
        }
        
        .dark-mode .card {
            background-color: #1e293b !important;
            color: #e2e8f0 !important;
            border-color: #475569 !important;
        }
        
        .dark-mode .card-header {
            border-bottom-color: #334155 !important;
        }
        
        .dark-mode .text-gray-600, 
        .dark-mode .text-gray-700 {
            color: #cbd5e1 !important;
        }
        
        .dark-mode .stat-card {
            background-color: #2d3a4f !important;
            color: #f1f5f9 !important;
        }
        
        .dark-mode .stat-card div {
            color: #f1f5f9 !important;
        }
        
        .dark-mode input {
            background-color: #334155 !important;
            color: #f1f5f9 !important;
            border-color: #64748b !important;
        }
        
        .dark-mode input::placeholder {
            color: #94a3b8 !important;
        }
        
        .dark-mode .bg-gray-50 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-gray-100 {
            background-color: #1e293b !important;
        }
        
        .dark-mode .bg-yellow-100 {
            background-color: #422f1f !important;
            color: #fcd34d !important;
        }
        
        .dark-mode .bg-green-100 {
            background-color: #1f4030 !important;
            color: #6ee7b7 !important;
        }
        
        .dark-mode .bg-blue-100 {
            background-color: #1e3a5f !important;
            color: #93c5fd !important;
        }
        
        .dark-mode .bg-purple-100 {
            background-color: #352d5e !important;
            color: #c4b5fd !important;
        }
        
        .dark-mode .bg-red-100 {
            background-color: #542c2c !important;
            color: #fca5a5 !important;
        }
        
        .correct-icon {
            color: #10b981;
            animation: pop 0.3s ease;
        }
        
        .incorrect-icon {
            color: #ef4444;
            animation: shake 0.3s ease;
        }
        
        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .stat-card {
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        
        /* Theme toggle - properly positioned */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: white;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        
        .dark-mode .theme-toggle {
            background: #1e293b;
            border-color: #475569;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        /* Main content area - accounts for fixed elements */
        .main-content {
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px; /* Space for theme toggle */
        }
        
        @media (min-width: 768px) {
            .main-content {
                padding: 40px;
                padding-bottom: 100px;
            }
        }
        
        .speak-button {
            transition: all 0.2s ease;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .speak-button:active {
            transform: scale(0.95);
        }
        
        /* Hint section styles */
        .hint-section {
            background: linear-gradient(135deg, #f3e8ff, #ede9fe);
            border-radius: 24px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .dark-mode .hint-section {
            background: linear-gradient(135deg, #2e293a, #26223a);
        }
        
        .hint-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .game-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 32px;
        }
        
        .dark-mode .game-card {
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.3s ease;
        }
        
        .word-chip {
            background: linear-gradient(135deg, #f3e8ff, #e9d5ff);
            border: 1px solid #c084fc;
            border-radius: 16px;
            padding: 12px;
        }
        
        .dark-mode .word-chip {
            background: linear-gradient(135deg, #2e293a, #2a2438);
            border-color: #6b21a8;
        }
        
        .letter-tile {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 4px;
            transition: all 0.2s ease;
        }
        
        .dark-mode .letter-tile {
            background: #2d3a4f;
            border-color: #64748b;
            color: #f1f5f9;
        }
        
        .letter-tile.highlight {
            border-color: #8b5cf6;
            background: #ede9fe;
            transform: scale(1.1);
        }
        
        .dark-mode .letter-tile.highlight {
            background: #4c3b6e;
            border-color: #a78bfa;
        }
        
        .rhyme-word {
            display: inline-block;
            padding: 8px 16px;
            background: #e2e8f0;
            border-radius: 20px;
            margin: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rhyme-word:hover {
            background: #cbd5e1;
            transform: scale(1.05);
        }
        
        .dark-mode .rhyme-word {
            background: #334155;
            color: #f1f5f9;
        }
        
        .dark-mode .rhyme-word:hover {
            background: #475569;
        }
    </style>
</head>
<body id="body" class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600">
    <!-- Theme Toggle - Fixed position outside main content -->
    <button onclick="window.toggleDarkMode()" class="theme-toggle">
        <span id="theme-icon">ğŸŒ™</span>
    </button>
    
    <!-- Main Content Area -->
    <div id="app" class="main-content"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let state = {
            mode: 'home',
            gameState: 'setup',
            studentName: '',
            words: [],
            currentIndex: 0,
            userAnswer: '',
            score: 0,
            showAnswer: false,
            answered: false,
            correctAnswers: [],
            streak: 0,
            bestStreak: parseInt(localStorage.getItem('bestStreak') || '0'),
            totalWords: parseInt(localStorage.getItem('totalWords') || '0'),
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            showHint: false,
            hintLevel: 'basic', // basic, syllable, rhyme, letter
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // Apply dark mode on load
        if (state.darkMode) {
            document.getElementById('body').classList.add('dark-mode');
            document.getElementById('theme-icon').textContent = 'â˜€ï¸';
        }

        // ==================== SOUTH AFRICAN SPEECH FUNCTIONS ====================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    const voices = window.speechSynthesis.getVoices();
                    
                    let selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-ZA') || 
                        voice.name.includes('South African') ||
                        voice.name.includes('Tessa') ||
                        voice.name.includes('Zola')
                    );
                    
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.includes('en-'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    utterance.rate = 0.75;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    window.speechSynthesis.speak(utterance);
                }, 100);
            }
        }

        // Pre-load voices
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = function() {
                window.speechSynthesis.getVoices();
            };
        }

        // ==================== MULTI-LEVEL HINT SYSTEM ====================
        function getHint(word, level) {
            word = word.toLowerCase().trim();
            
            switch(level) {
                case 'basic':
                    return getBasicHint(word);
                case 'syllable':
                    return getSyllableHint(word);
                case 'rhyme':
                    return getRhymeHint(word);
                case 'letter':
                    return getLetterHint(word);
                default:
                    return getBasicHint(word);
            }
        }
        
        function getBasicHint(word) {
            const hints = {
                // Animals
                'cat': "ğŸ± This furry friend says 'meow' and loves to nap in sunny spots.",
                'dog': "ğŸ• People call this animal 'man's best friend'. It wags its tail when happy.",
                'fish': "ğŸ  This creature lives in water and swims using its fins.",
                'bird': "ğŸ•Šï¸ This animal has feathers and can fly through the sky.",
                'rabbit': "ğŸ° This fluffy animal has long ears and loves to hop.",
                'horse': "ğŸ People ride this tall animal with a flowing mane and tail.",
                'cow': "ğŸ„ This farm animal gives us milk and says 'moo'.",
                'lion': "ğŸ¦ Known as the king of the jungle, this big cat has a mighty roar.",
                'tiger': "ğŸ¯ This striped big cat is orange with black stripes.",
                'elephant': "ğŸ˜ The largest land animal with a long trunk and big tusks.",
                
                // Food
                'apple': "ğŸ A crunchy fruit that can be red, green, or yellow. Good for keeping doctors away!",
                'banana': "ğŸŒ A long yellow fruit that monkeys love. You need to peel it first.",
                'bread': "ğŸ A food made from flour that you toast in the morning for breakfast.",
                'milk': "ğŸ¥› A white drink that comes from cows. Good for strong bones!",
                'water': "ğŸ’§ The clear liquid we drink every day to stay healthy.",
                'cake': "ğŸ‚ A sweet dessert with icing that people have on birthdays.",
                'pizza': "ğŸ• An Italian dish with a round base, tomato sauce, and cheese on top.",
                'rice': "ğŸš Small white grains that are a staple food in many countries.",
                'soup': "ğŸ¥£ A warm liquid food eaten with a spoon, especially when you're sick.",
                'egg': "ğŸ¥š A food that comes from chickens. You can have it fried or boiled.",
                
                // Actions
                'run': "ğŸƒ To move quickly using your legs, faster than walking.",
                'jump': "ğŸ¤¸ To push yourself off the ground and land somewhere else.",
                'swim': "ğŸŠ To move through water using your arms and legs.",
                'fly': "âœˆï¸ To move through the air like a bird or an aeroplane.",
                'eat': "ğŸ½ï¸ To put food in your mouth and swallow it.",
                'drink': "ğŸ¥¤ To take liquid into your body through your mouth.",
                'sleep': "ğŸ˜´ To rest with your eyes closed, usually at night.",
                'play': "ğŸ® To have fun with toys, games, or friends.",
                'read': "ğŸ“š To look at words in a book and understand them.",
                'write': "âœï¸ To put words on paper using a pen or pencil.",
                
                // Colors
                'red': "ğŸ”´ The colour of a ripe apple, a fire truck, or a rose.",
                'blue': "ğŸ”µ The colour of the sky on a clear day and the deep ocean.",
                'green': "ğŸŸ¢ The colour of grass, leaves on trees, and fresh vegetables.",
                'yellow': "ğŸŸ¡ The colour of the sun, bananas, and bright flowers.",
                'orange': "ğŸŸ  A mix of red and yellow, like the fruit with the same name.",
                'purple': "ğŸŸ£ The colour of grapes and some pretty flowers.",
                'brown': "ğŸŸ¤ The colour of chocolate, tree trunks, and soil.",
                'black': "âš« The colour of night sky and coal.",
                'white': "âšª The colour of snow, milk, and clouds.",
                'pink': "ğŸŒ¸ A soft colour often seen in flowers and candy.",
                
                // Objects
                'ball': "âš½ A round object you can throw, catch, or kick in games.",
                'car': "ğŸš— A vehicle with four wheels that takes people places.",
                'book': "ğŸ“– Something with pages that you read to learn or enjoy stories.",
                'pen': "ğŸ–Šï¸ A tool with ink inside for writing on paper.",
                'chair': "ğŸª‘ Furniture with legs and a back that you sit on.",
                'table': "ğŸª‘ Furniture with a flat top where you eat meals or work.",
                'door': "ğŸšª A moving panel that opens to let you into a room.",
                'window': "ğŸªŸ A glass opening in a wall that lets you see outside.",
                'house': "ğŸ  A building where people live with their family.",
                'school': "ğŸ« A place where children go to learn from teachers."
            };
            
            if (hints[word]) {
                return hints[word];
            }
            
            // Pattern-based hints for unknown words
            if (word.endsWith('ing')) {
                return "â³ This word shows an action that is happening right now.";
            }
            if (word.endsWith('ed')) {
                return "ğŸ“… This word shows an action that already happened in the past.";
            }
            if (word.endsWith('er') || word.endsWith('or')) {
                return "ğŸ‘¤ This word describes a person who does a specific job.";
            }
            if (word.endsWith('ful')) {
                return "âœ¨ This word describes something that is full of a certain quality.";
            }
            if (word.endsWith('less')) {
                return "ğŸš« This word describes something that is without a certain quality.";
            }
            
            return "ğŸ”¤ Listen carefully to the sounds in this word. Try saying it slowly.";
        }
        
        function getSyllableHint(word) {
            // Count syllables (simplified)
            const syllables = word.split(/[aeiou]+/i).length;
            const parts = [];
            
            // Simple syllable splitting
            let currentPart = '';
            for (let i = 0; i < word.length; i++) {
                currentPart += word[i];
                if ('aeiou'.includes(word[i]) && i < word.length - 1) {
                    parts.push(currentPart);
                    currentPart = '';
                }
            }
            if (currentPart) parts.push(currentPart);
            
            if (parts.length > 1) {
                return `ğŸ“£ This word has ${syllables} syllable${syllables > 1 ? 's' : ''}. Try breaking it into parts: ${parts.join(' - ')}`;
            } else {
                return `ğŸ“£ This word has 1 syllable. Say it as one smooth sound.`;
            }
        }
        
        function getRhymeHint(word) {
            const rhymes = {
                'cat': ['bat', 'hat', 'mat', 'rat', 'sat'],
                'dog': ['frog', 'log', 'cog', 'hog'],
                'sun': ['fun', 'run', 'bun', 'gun'],
                'ball': ['tall', 'fall', 'call', 'mall'],
                'car': ['star', 'far', 'jar', 'bar'],
                'book': ['look', 'took', 'cook', 'hook'],
                'house': ['mouse', 'louse', 'spouse'],
                'tree': ['bee', 'see', 'free', 'three'],
                'blue': ['true', 'shoe', 'glue', 'flew'],
                'red': ['bed', 'head', 'said', 'led'],
                'big': ['pig', 'wig', 'fig', 'dig'],
                'small': ['tall', 'call', 'ball', 'fall']
            };
            
            if (rhymes[word]) {
                const rhymeWords = rhymes[word].join(', ');
                return `ğŸµ This word rhymes with words like: ${rhymeWords}. Can you hear the similar ending?`;
            } else {
                // Find words with same ending
                const ending = word.slice(-3);
                return `ğŸµ This word ends with "${ending}". Try to think of other words that sound similar at the end.`;
            }
        }
        
        function getLetterHint(word) {
            const letters = word.split('');
            const firstLetter = letters[0];
            const lastLetter = letters[letters.length - 1];
            const middleLetter = letters[Math.floor(letters.length / 2)];
            
            let hint = `ğŸ”¤ This word has ${letters.length} letters. `;
            hint += `It starts with '${firstLetter}' and ends with '${lastLetter}'. `;
            
            // Check for double letters
            for (let i = 0; i < word.length - 1; i++) {
                if (word[i] === word[i + 1]) {
                    hint += `âš ï¸ Watch out! There are two '${word[i]}' letters together. `;
                    break;
                }
            }
            
            // Vowel count
            const vowels = word.match(/[aeiou]/gi) || [];
            hint += `It has ${vowels.length} vowel${vowels.length !== 1 ? 's' : ''}. `;
            
            return hint;
        }

        // ==================== DARK MODE TOGGLE ====================
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            
            const body = document.getElementById('body');
            const icon = document.getElementById('theme-icon');
            
            if (state.darkMode) {
                body.classList.add('dark-mode');
                icon.textContent = 'â˜€ï¸';
            } else {
                body.classList.remove('dark-mode');
                icon.textContent = 'ğŸŒ™';
            }
            
            render();
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            
            if (state.mode === 'home') {
                app.innerHTML = `
                    <div class="w-full max-w-6xl mx-auto">
                        <div class="game-card p-6 md:p-10">
                            <div class="text-center mb-10">
                                <h1 class="text-5xl md:text-7xl font-bold mb-4 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-600 bg-clip-text text-transparent">
                                    âœ¨ Spelling Adventure âœ¨
                                </h1>
                                <p class="text-xl md:text-2xl text-gray-600">South African English Edition ğŸ‡¿ğŸ‡¦</p>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-12">
                                <div class="stat-card bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-sm md:text-base text-yellow-700 font-medium">Best Streak ğŸ”¥</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-green-800">${state.totalWords}</div>
                                    <div class="text-sm md:text-base text-green-700 font-medium">Words Mastered ğŸ“š</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-blue-800">${state.testResults.length}</div>
                                    <div class="text-sm md:text-base text-blue-700 font-medium">Tests Done ğŸ“</div>
                                </div>
                                <div class="stat-card bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl md:text-5xl font-bold text-purple-800">${state.words.length}</div>
                                    <div class="text-sm md:text-base text-purple-700 font-medium">Words Ready ğŸ¯</div>
                                </div>
                            </div>

                            <div class="flex flex-col md:flex-row gap-4 md:gap-6">
                                <button onclick="startLearning()" 
                                        class="flex-1 py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 transform hover:scale-105 transition-all shadow-xl">
                                    ğŸš€ Start Learning
                                </button>
                                <button onclick="openParentDashboard()" 
                                        class="flex-1 py-6 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-2xl font-bold rounded-2xl hover:from-blue-600 hover:to-indigo-700 transform hover:scale-105 transition-all shadow-xl">
                                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Parent Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.mode === 'parent') {
                renderParent();
            }
            else if (state.mode === 'student') {
                if (state.gameState === 'setup') renderSetup();
                else if (state.gameState === 'playing') renderPlaying();
                else if (state.gameState === 'results') renderResults();
            }
        }

        function renderParent() {
            const app = document.getElementById('app');
            
            const totalTests = state.testResults.length;
            const averageScore = totalTests > 0 
                ? Math.round(state.testResults.reduce((acc, t) => acc + t.percentage, 0) / totalTests) 
                : 0;
            
            const studentMap = new Map();
            state.testResults.forEach(test => {
                if (!studentMap.has(test.studentName)) {
                    studentMap.set(test.studentName, {
                        tests: [],
                        totalCorrect: 0,
                        totalWords: 0
                    });
                }
                const student = studentMap.get(test.studentName);
                student.tests.push(test);
                student.totalCorrect += test.score;
                student.totalWords += test.total;
            });

            app.innerHTML = `
                <div class="w-full max-w-7xl mx-auto">
                    <div class="game-card p-6 md:p-10">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 class="text-3xl md:text-4xl font-bold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Parent Dashboard</h1>
                            <button onclick="goHome()" class="px-8 py-4 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors text-lg font-bold w-full md:w-auto">
                                ğŸ  Back to Home
                            </button>
                        </div>

                        ${totalTests === 0 ? `
                            <div class="text-center py-20 bg-gray-50 rounded-3xl">
                                <div class="text-8xl mb-6">ğŸ“Š</div>
                                <h3 class="text-3xl font-bold text-gray-700 mb-3">No Data Yet</h3>
                                <p class="text-xl text-gray-500 mb-8">Complete some spelling tests to see progress here!</p>
                                <button onclick="startLearning()" class="px-10 py-5 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600 text-xl">
                                    ğŸš€ Start Your First Test
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                                <div class="bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-blue-800">${totalTests}</div>
                                    <div class="text-sm text-blue-600">Total Tests</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-green-800">${averageScore}%</div>
                                    <div class="text-sm text-green-600">Average Score</div>
                                </div>
                                <div class="bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-purple-800">${state.totalWords}</div>
                                    <div class="text-sm text-purple-600">Words Mastered</div>
                                </div>
                                <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-6 text-center">
                                    <div class="text-4xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-sm text-yellow-600">Best Streak</div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                ${Array.from(studentMap.entries()).map(([name, data]) => {
                                    const studentAvg = Math.round((data.totalCorrect / data.totalWords) * 100);
                                    const recentTests = data.tests.slice(-5).reverse();
                                    
                                    return `
                                        <div class="bg-gray-50 rounded-2xl p-6 md:p-8">
                                            <div class="flex items-center gap-4 mb-6">
                                                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-3xl font-bold">
                                                    ${name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <h2 class="text-3xl font-bold">${name}</h2>
                                                    <p class="text-gray-600 text-lg">${data.tests.length} tests completed</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-4 mb-6">
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-blue-600">${studentAvg}%</div>
                                                    <div class="text-sm text-gray-500">Average</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-green-600">${data.totalCorrect}</div>
                                                    <div class="text-sm text-gray-500">Correct</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-3xl font-bold text-purple-600">${data.totalWords}</div>
                                                    <div class="text-sm text-gray-500">Total Words</div>
                                                </div>
                                            </div>
                                            
                                            <h3 class="font-bold text-xl mb-4">ğŸ“‹ Recent Tests</h3>
                                            <div class="space-y-4">
                                                ${recentTests.map(test => `
                                                    <div class="bg-white rounded-xl p-5 border-l-4 ${test.percentage >= 80 ? 'border-green-500' : 'border-yellow-500'}">
                                                        <div class="flex justify-between items-center mb-3">
                                                            <span class="font-bold text-lg">${test.score}/${test.total} words correct</span>
                                                            <span class="text-gray-500">${new Date(test.date).toLocaleDateString()}</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                                            <div class="bg-${test.percentage >= 80 ? 'green' : 'yellow'}-500 h-3 rounded-full" style="width: ${test.percentage}%"></div>
                                                        </div>
                                                        <div class="mt-3 text-gray-600">
                                                            Words: ${test.words.join(', ')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="mt-8 bg-gray-50 rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4">ğŸ“ˆ Progress Over Time</h3>
                                <div class="h-48 flex items-end justify-between gap-2">
                                    ${state.testResults.slice(-10).map((test, i) => `
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-gradient-to-t from-blue-500 to-purple-500 rounded-t-lg transition-all hover:from-blue-600 hover:to-purple-600" 
                                                 style="height: ${test.percentage * 1.5}%"></div>
                                            <span class="text-xs text-gray-600 mt-2">Test ${i+1}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="mt-8 grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-red-800 mb-2">âš ï¸ Clear All Data</h3>
                                    <p class="text-red-600 mb-4">This will delete all progress for all students.</p>
                                    <button onclick="clearAllData()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors w-full md:w-auto">
                                        ğŸ—‘ï¸ Delete Everything
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-blue-800 mb-2">ğŸ“Š Export Data</h3>
                                    <p class="text-blue-600 mb-4">Download progress as a CSV file.</p>
                                    <button onclick="exportData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors w-full md:w-auto">
                                        â¬‡ï¸ Download CSV
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card p-6 md:p-10">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl md:text-4xl font-bold">ğŸ“š Let's Get Started</h1>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                ğŸ  Home
                            </button>
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">What's your name? ğŸŒŸ</label>
                            <input type="text" id="studentNameInput" value="${state.studentName}" 
                                   oninput="updateStudentName(this.value)"
                                   class="w-full px-6 py-5 border-2 border-purple-300 rounded-2xl text-xl focus:border-purple-500 focus:outline-none"
                                   placeholder="Enter your name...">
                        </div>

                        <div class="mb-8">
                            <label class="block text-xl font-bold mb-3">Add spelling words ğŸ“</label>
                            <div class="flex flex-col md:flex-row gap-3">
                                <input type="text" id="newWord" placeholder="Type a word..."
                                       class="flex-1 px-6 py-5 border-2 border-blue-300 rounded-2xl text-xl focus:border-blue-500 focus:outline-none"
                                       onkeypress="if(event.key==='Enter') addWord()">
                                <button onclick="addWord()" class="px-8 py-5 bg-blue-500 text-white rounded-2xl font-bold hover:bg-blue-600 transition-colors text-xl">
                                    Add Word
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-3">âœ¨ Any word works - we'll help you learn it!</p>
                        </div>

                        ${state.words.length > 0 ? `
                            <div class="mb-8">
                                <h3 class="font-bold text-xl mb-4">Your Words (${state.words.length})</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${state.words.map((word, i) => `
                                        <div class="word-chip flex justify-between items-center group">
                                            <span class="font-bold text-lg capitalize">${word}</span>
                                            <button onclick="removeWord(${i})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity text-xl">
                                                âœ•
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="startGame()" 
                                ${state.words.length === 0 || !state.studentName.trim() ? 'disabled' : ''}
                                class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-xl">
                            ğŸš€ Start Spelling Adventure!
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlaying() {
            const app = document.getElementById('app');
            const progress = ((state.currentIndex + 1) / state.words.length) * 100;
            const currentWord = state.words[state.currentIndex];
            const currentHint = getHint(currentWord, state.hintLevel);

            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card p-6 md:p-10">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-3xl md:text-4xl font-bold">Hello, ${state.studentName}! âœ¨</h2>
                                <p class="text-lg text-gray-600 mt-2">Listen and spell the word</p>
                            </div>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                Exit
                            </button>
                        </div>

                        <div class="mb-8">
                            <div class="flex justify-between text-base md:text-lg mb-3">
                                <span class="font-medium">Word ${state.currentIndex + 1} of ${state.words.length}</span>
                                <span class="font-medium">Score: ${state.score} â­</span>
                                <span class="font-medium">Streak: ${state.streak} ğŸ”¥</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-5">
                                <div class="progress-bar h-5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-8 mb-8">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">ğŸ”Š</div>
                                <p class="text-xl font-bold mb-6">Click to hear the word:</p>
                            </div>

                            <button onclick="speakWord('${currentWord}')" 
                                    class="speak-button w-full text-white px-8 py-6 rounded-2xl font-bold transform hover:scale-105 transition-all flex items-center justify-center gap-4 text-2xl">
                                <span class="text-3xl">ğŸ”Š</span>
                                <span>SAY THE WORD</span>
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <button onclick="changeHintLevel('basic')" 
                                        class="px-4 py-3 ${state.hintLevel === 'basic' ? 'bg-purple-600 text-white' : 'bg-white text-purple-600'} border-2 border-purple-400 rounded-xl font-bold hover:bg-purple-100 transition-colors">
                                    ğŸ“ Basic
                                </button>
                                <button onclick="changeHintLevel('syllable')" 
                                        class="px-4 py-3 ${state.hintLevel === 'syllable' ? 'bg-purple-600 text-white' : 'bg-white text-purple-600'} border-2 border-purple-400 rounded-xl font-bold hover:bg-purple-100 transition-colors">
                                    ğŸ”¨ Syllables
                                </button>
                                <button onclick="changeHintLevel('rhyme')" 
                                        class="px-4 py-3 ${state.hintLevel === 'rhyme' ? 'bg-purple-600 text-white' : 'bg-white text-purple-600'} border-2 border-purple-400 rounded-xl font-bold hover:bg-purple-100 transition-colors">
                                    ğŸµ Rhymes
                                </button>
                                <button onclick="changeHintLevel('letter')" 
                                        class="px-4 py-3 ${state.hintLevel === 'letter' ? 'bg-purple-600 text-white' : 'bg-white text-purple-600'} border-2 border-purple-400 rounded-xl font-bold hover:bg-purple-100 transition-colors">
                                    ğŸ”¤ Letters
                                </button>
                            </div>

                            <div class="hint-section mt-6">
                                <p class="text-lg md:text-xl leading-relaxed">${currentHint}</p>
                                <button onclick="speakHint('${currentWord}')" class="mt-4 w-full px-6 py-4 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition-colors text-lg flex items-center justify-center gap-2">
                                    ğŸ” Hear This Hint
                                </button>
                            </div>
                        </div>

                        <div class="mb-6">
                            <input type="text" id="answerInput" value="${state.userAnswer}"
                                   oninput="updateUserAnswer(this.value)"
                                   ${state.answered ? 'disabled' : ''}
                                   class="w-full px-8 py-6 text-2xl md:text-3xl text-center border-4 ${state.answered ? 'border-gray-300' : 'border-purple-400'} rounded-2xl font-bold focus:border-purple-500 focus:outline-none"
                                   placeholder="âœï¸ Type your answer..."
                                   autocomplete="off" autocorrect="off" spellcheck="false">
                        </div>

                        ${state.showAnswer ? `
                            <div class="p-8 rounded-2xl mb-6 text-center ${
                                state.userAnswer.toLowerCase().trim() === currentWord 
                                    ? 'bg-green-100 border-4 border-green-400' 
                                    : 'bg-red-100 border-4 border-red-400'
                            }">
                                <div class="text-6xl mb-4">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord ? 'âœ“âœ“âœ“' : 'âœ—âœ—âœ—'}
                                </div>
                                <p class="text-2xl md:text-3xl font-bold mb-3">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Lekker! You got it right!' 
                                        : `The correct spelling is: "${currentWord}"`}
                                </p>
                                <p class="text-xl text-gray-600">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Well done! ğŸŒŸ' 
                                        : 'Keep practicing - you\'ll get it next time! ğŸ’ª'}
                                </p>
                            </div>
                        ` : ''}

                        ${!state.answered ? `
                            <button onclick="submitAnswer()" 
                                    class="w-full py-6 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-2xl font-bold rounded-2xl hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all shadow-xl">
                                âœ… Check My Answer
                            </button>
                        ` : `
                            <button onclick="nextWord()" 
                                    class="w-full py-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-2xl font-bold rounded-2xl hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all shadow-xl">
                                ${state.currentIndex < state.words.length - 1 ? 'ğŸš€ Next Word' : 'ğŸ‰ See My Results'}
                            </button>
                        `}
                    </div>
                </div>
            `;

            if (!state.answered) {
                setTimeout(() => document.getElementById('answerInput')?.focus(), 100);
            }
        }

        function renderResults() {
            const app = document.getElementById('app');
            const percentage = Math.round((state.score / state.words.length) * 100);
            
            let message = '';
            let emoji = '';
            let color = '';
            if (percentage === 100) {
                message = "PERFECT SCORE! You're a spelling champion!";
                emoji = "ğŸ†ğŸŒŸğŸ‰";
                color = "from-yellow-400 to-orange-400";
            } else if (percentage >= 80) {
                message = "Excellent work! You're getting really good!";
                emoji = "ğŸ‰âœ¨â­";
                color = "from-green-400 to-emerald-400";
            } else if (percentage >= 60) {
                message = "Good job! Keep practicing to get even better!";
                emoji = "ğŸ‘ğŸ“šğŸ’ª";
                color = "from-blue-400 to-indigo-400";
            } else {
                message = "Nice try! Every mistake helps you learn. Try again!";
                emoji = "ğŸ’ªğŸŒŸğŸ“";
                color = "from-purple-400 to-pink-400";
            }

            app.innerHTML = `
                <div class="w-full max-w-2xl mx-auto">
                    <div class="game-card p-6 md:p-10">
                        <div class="flex justify-end mb-4">
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 text-lg">
                                ğŸ  Home
                            </button>
                        </div>

                        <div class="text-center mb-8">
                            <div class="text-8xl mb-6 animate-bounce">${emoji}</div>
                            <h2 class="text-4xl md:text-5xl font-bold mb-4">Great job, ${state.studentName}!</h2>
                            <p class="text-2xl text-gray-600">${message}</p>
                        </div>

                        <div class="bg-gradient-to-r ${color} rounded-2xl p-10 mb-8 text-white text-center">
                            <div class="text-7xl font-bold mb-4">${state.score}/${state.words.length}</div>
                            <div class="text-4xl font-bold mb-4">${percentage}%</div>
                            <div class="text-2xl">Words correct: ${state.score}</div>
                        </div>

                        <h3 class="text-3xl font-bold mb-6">Your Results:</h3>
                        <div class="grid grid-cols-2 gap-4 mb-10">
                            ${state.words.map((word, i) => `
                                <div class="p-5 rounded-xl ${state.correctAnswers.includes(i) ? 'bg-green-100 border-2 border-green-400' : 'bg-red-100 border-2 border-red-400'} flex justify-between items-center">
                                    <span class="font-bold text-xl capitalize">${word}</span>
                                    <span class="text-3xl ${state.correctAnswers.includes(i) ? 'correct-icon' : 'incorrect-icon'}">
                                        ${state.correctAnswers.includes(i) ? 'âœ“âœ“' : 'âœ—âœ—'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="practiceAgain()" 
                                    class="py-5 bg-purple-500 text-white text-xl font-bold rounded-xl hover:bg-purple-600 transform hover:scale-105 transition-all">
                                ğŸ”„ Practice Again
                            </button>
                            <button onclick="newWords()"
                                    class="py-5 bg-blue-500 text-white text-xl font-bold rounded-xl hover:bg-blue-600 transform hover:scale-105 transition-all">
                                â• New Words
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function exportData() {
            const data = state.testResults.map(r => ({
                Student: r.studentName,
                Date: new Date(r.date).toLocaleDateString(),
                Score: `${r.score}/${r.total}`,
                Percentage: `${r.percentage}%`,
                Words: r.words.join('; ')
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spelling-progress-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function convertToCSV(objArray) {
            if (objArray.length === 0) return '';
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = Object.keys(array[0]).join(',') + '\r\n';
            return array.reduce((str, next) => {
                str += Object.values(next).map(value => `"${value}"`).join(',') + '\r\n';
                return str;
            }, str);
        }

        // ==================== EVENT HANDLERS ====================
        function startLearning() { state.mode = 'student'; render(); }
        function openParentDashboard() { state.mode = 'parent'; render(); }
        function goHome() { state.mode = 'home'; render(); }

        function updateStudentName(name) { state.studentName = name; }
        function updateUserAnswer(answer) { state.userAnswer = answer; }

        function addWord() {
            const input = document.getElementById('newWord');
            const word = input.value.trim().toLowerCase();
            if (word && !state.words.includes(word)) {
                state.words.push(word);
                input.value = '';
                render();
            }
        }

        function removeWord(index) {
            state.words.splice(index, 1);
            render();
        }

        function startGame() {
            if (state.words.length > 0 && state.studentName.trim()) {
                state.gameState = 'playing';
                state.currentIndex = 0;
                state.score = 0;
                state.correctAnswers = [];
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.streak = 0;
                state.showHint = false;
                state.hintLevel = 'basic';
                render();
            }
        }

        function speakWord(word) {
            speakText(word);
        }

        function speakHint(word) {
            const hint = getHint(word, state.hintLevel);
            speakText(hint.replace(/[ğŸ”¤ğŸ“£ğŸµğŸ”¨âš ï¸âœ¨ğŸš«ğŸ•Šï¸ğŸ±ğŸ•ğŸ ğŸ¦ğŸ¯ğŸ˜ğŸğŸŒğŸğŸ¥›ğŸ’§ğŸ‚ğŸ•ğŸšğŸ¥£ğŸ¥šğŸƒğŸ¤¸ğŸŠâœˆï¸ğŸ½ï¸ğŸ¥¤ğŸ˜´ğŸ®ğŸ“šâœï¸ğŸ”´ğŸ”µğŸŸ¢ğŸŸ¡ğŸŸ ğŸŸ£ğŸŸ¤âš«âšªğŸŒ¸âš½ğŸš—ğŸ“–ğŸ–Šï¸ğŸª‘ğŸšªğŸªŸğŸ ğŸ«]/g, ''));
        }

        function changeHintLevel(level) {
            state.hintLevel = level;
            render();
        }

        function toggleHint(word) {
            state.showHint = !state.showHint;
            render();
        }

        function submitAnswer() {
            const input = document.getElementById('answerInput');
            if (input) {
                state.userAnswer = input.value;
            }
            checkAnswer();
            render();
        }

        function checkAnswer() {
            const correct = state.userAnswer.toLowerCase().trim() === state.words[state.currentIndex];
            if (correct) {
                state.score++;
                state.correctAnswers.push(state.currentIndex);
                state.streak++;
                if (state.streak > state.bestStreak) {
                    state.bestStreak = state.streak;
                    localStorage.setItem('bestStreak', state.bestStreak);
                }
                state.totalWords++;
                localStorage.setItem('totalWords', state.totalWords);
            } else {
                state.streak = 0;
            }
            state.showAnswer = true;
            state.answered = true;
        }

        function nextWord() {
            if (state.currentIndex < state.words.length - 1) {
                state.currentIndex++;
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.showHint = false;
                state.hintLevel = 'basic';
                render();
            } else {
                finishGame();
            }
        }

        function finishGame() {
            const result = {
                studentName: state.studentName,
                date: new Date().toISOString(),
                words: [...state.words],
                score: state.score,
                total: state.words.length,
                percentage: Math.round((state.score / state.words.length) * 100),
                correctAnswers: [...state.correctAnswers]
            };
            state.testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(state.testResults));
            state.gameState = 'results';
            render();
        }

        function practiceAgain() {
            state.gameState = 'playing';
            state.currentIndex = 0;
            state.score = 0;
            state.correctAnswers = [];
            state.userAnswer = '';
            state.showAnswer = false;
            state.answered = false;
            state.streak = 0;
            state.showHint = false;
            state.hintLevel = 'basic';
            render();
        }

        function newWords() {
            state.words = [];
            state.gameState = 'setup';
            render();
        }

        function clearAllData() {
            if (confirm('âš ï¸ Delete ALL progress? This cannot be undone!')) {
                localStorage.clear();
                state.testResults = [];
                state.totalWords = 0;
                state.bestStreak = 0;
                render();
            }
        }

        // Make functions globally available
        window.toggleDarkMode = toggleDarkMode;
        window.startLearning = startLearning;
        window.openParentDashboard = openParentDashboard;
        window.goHome = goHome;
        window.updateStudentName = updateStudentName;
        window.updateUserAnswer = updateUserAnswer;
        window.addWord = addWord;
        window.removeWord = removeWord;
        window.startGame = startGame;
        window.speakWord = speakWord;
        window.speakHint = speakHint;
        window.changeHintLevel = changeHintLevel;
        window.toggleHint = toggleHint;
        window.submitAnswer = submitAnswer;
        window.nextWord = nextWord;
        window.practiceAgain = practiceAgain;
        window.newWords = newWords;
        window.clearAllData = clearAllData;
        window.exportData = exportData;

        // Initial render
        render();
    </script>
</body>
</html>