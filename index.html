<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spello – Spelling Made Fun</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne+Mono&family=Syne:wght@400;600;700;800&family=Unbounded:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0d18;
            --surface: rgba(255,255,255,0.04);
            --surface2: rgba(255,255,255,0.07);
            --border: rgba(255,255,255,0.09);
            --border-hi: rgba(255,255,255,0.18);
            --text: #f0eeff;
            --soft: rgba(240,238,255,0.6);
            --muted: rgba(240,238,255,0.35);
            --lime: #c8ff00;
            --lime-dim: rgba(200,255,0,0.12);
            --violet: #a678f0;
            --amber: #ffb347;
            --red: #ff4f6a;
            --green: #3dffa0;
            --teal: #00d4b4;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        body::before {
            content:''; position:fixed; inset:0;
            background:
                radial-gradient(ellipse 60% 50% at 20% 10%, rgba(123,94,167,0.15) 0%, transparent 70%),
                radial-gradient(ellipse 50% 60% at 80% 80%, rgba(200,255,0,0.05) 0%, transparent 70%),
                radial-gradient(ellipse 40% 40% at 60% 30%, rgba(240,85,163,0.07) 0%, transparent 70%);
            pointer-events:none; z-index:0;
        }
        .wrap { position:relative; z-index:1; max-width:800px; margin:0 auto; padding:20px 16px 100px; }
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: fadeUp 0.25s ease;
        }
        @media(max-width:600px){ .card{padding:20px 16px;} .wrap{padding:14px 10px 100px;} }

```
    .logo {
        font-family: 'Unbounded', sans-serif; font-weight:900;
        font-size: clamp(3rem,10vw,5rem);
        color: var(--lime);
        text-shadow: 0 0 40px rgba(200,255,0,0.4);
        letter-spacing: -0.02em; line-height:1;
    }
    h2 { font-family:'Unbounded',sans-serif; font-weight:700; color:var(--text); letter-spacing:-0.01em; }

    /* Buttons */
    .btn {
        display:inline-flex; align-items:center; justify-content:center; gap:8px;
        padding:13px 22px; border-radius:12px;
        font-family:'Syne',sans-serif; font-weight:700; font-size:0.95rem;
        border:none; cursor:pointer; transition:all 0.15s ease;
    }
    .btn:hover:not([disabled]){ transform:translateY(-2px); }
    .btn:active:not([disabled]){ transform:translateY(0); }
    .btn[disabled]{ opacity:0.35; cursor:not-allowed; }
    .btn-lime { background:var(--lime); color:#0d0d18; font-weight:800; box-shadow:0 4px 20px rgba(200,255,0,0.3); }
    .btn-lime:hover:not([disabled]){ box-shadow:0 8px 32px rgba(200,255,0,0.5); }
    .btn-ghost { background:var(--surface2); color:var(--soft); border:1px solid var(--border-hi); }
    .btn-ghost:hover:not([disabled]){ color:var(--text); border-color:rgba(255,255,255,0.3); }
    .btn-violet { background:linear-gradient(135deg,#7b5ea7,var(--violet)); color:white; box-shadow:0 4px 20px rgba(123,94,167,0.35); }
    .btn-danger { background:linear-gradient(135deg,#ff4f6a,#c0284a); color:white; }
    .btn-lg { padding:18px 28px; font-size:1.05rem; border-radius:14px; }
    .btn-sm { padding:8px 16px; font-size:0.84rem; border-radius:9px; }
    .w-full { width:100%; }

    /* Stats */
    .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    @media(max-width:580px){ .stats-row{ grid-template-columns:repeat(2,1fr); } }
    .stat { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:16px 10px; text-align:center; }
    .stat-n { font-family:'Unbounded',sans-serif; font-size:1.9rem; font-weight:700; line-height:1; display:block; }
    .stat-l { font-size:0.68rem; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; color:var(--muted); margin-top:5px; display:block; }

    /* Tabs */
    .tab-row { display:flex; flex-wrap:wrap; gap:8px; }
    .tab { padding:7px 16px; border-radius:100px; background:var(--surface2); border:1px solid var(--border); color:var(--soft); font-weight:700; font-size:0.85rem; cursor:pointer; transition:all 0.15s; display:inline-flex; align-items:center; gap:6px; }
    .tab:hover{ border-color:var(--border-hi); color:var(--text); }
    .tab.on { background:var(--lime); border-color:var(--lime); color:#0d0d18; }
    .lbadge { padding:2px 8px; border-radius:100px; font-size:0.65rem; font-weight:700; text-transform:uppercase; background:rgba(0,0,0,0.15); color:inherit; }

    /* Words */
    .word-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:8px; }
    .wchip { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:9px 12px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .wchip:hover{ border-color:var(--border-hi); }
    .wchip:hover .wdel{ opacity:1; }
    .wname { font-weight:700; font-size:0.9rem; text-transform:capitalize; color:var(--text); }
    .wdel { background:none; border:none; cursor:pointer; color:var(--red); opacity:0; font-size:0.8rem; transition:opacity 0.15s; padding:2px 4px; border-radius:4px; }

    /* Inputs */
    .word-inp { flex:1; padding:12px 16px; font-family:'Syne',sans-serif; font-size:0.97rem; font-weight:600; border:1px solid var(--border-hi); border-radius:11px; background:var(--surface2); color:var(--text); outline:none; }
    .word-inp:focus{ border-color:var(--lime); box-shadow:0 0 0 3px rgba(200,255,0,0.1); }
    .word-inp::placeholder{ color:var(--muted); }
    .ans-inp { width:100%; padding:20px 22px; font-family:'Syne Mono',monospace; font-size:1.7rem; text-align:center; border:2px solid var(--border-hi); border-radius:16px; background:var(--surface2); color:var(--lime); outline:none; transition:all 0.2s; letter-spacing:0.05em; }
    .ans-inp:focus{ border-color:var(--lime); box-shadow:0 0 0 4px rgba(200,255,0,0.08); }
    .ans-inp::placeholder{ color:var(--muted); font-size:1.1rem; letter-spacing:0; }
    .ans-inp:disabled{ opacity:0.7; }

    /* Progress */
    .prog-wrap { height:5px; background:var(--surface2); border-radius:100px; overflow:hidden; }
    .prog-fill { height:100%; border-radius:100px; background:linear-gradient(90deg,var(--teal),var(--lime)); transition:width 0.4s ease; }

    /* Speak */
    .speak-btn { width:100%; padding:26px 20px; background:var(--surface2); border:2px dashed var(--border-hi); border-radius:18px; color:var(--text); font-family:'Unbounded',sans-serif; font-size:1rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:12px; transition:all 0.2s; letter-spacing:0.02em; }
    .speak-btn:hover{ background:var(--lime-dim); border-color:var(--lime); color:var(--lime); }
    .speak-icon { font-size:1.6rem; animation:pulse-icon 2.5s ease-in-out infinite; }
    @keyframes pulse-icon{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.15);} }

    /* Feedback */
    .fb-box { border-radius:16px; padding:22px; text-align:center; }
    .fb-ok { background:rgba(61,255,160,0.08); border:2px solid rgba(61,255,160,0.35); }
    .fb-bad { background:rgba(255,79,106,0.08); border:2px solid rgba(255,79,106,0.35); }
    .fb-emoji { font-size:2.8rem; display:block; margin-bottom:8px; }
    .fb-word { font-family:'Syne Mono',monospace; font-size:1.5rem; color:#ff8fa1; font-weight:700; }

    /* Dict */
    .dict-box { background:var(--surface); border:1px solid rgba(166,120,240,0.3); border-radius:14px; padding:18px; margin-top:12px; }
    .dict-def { font-size:1rem; line-height:1.65; color:var(--text); padding-left:12px; border-left:3px solid var(--violet); margin-bottom:10px; }
    .dict-ex { font-style:italic; color:var(--soft); font-size:0.9rem; padding:10px 12px; border-radius:9px; background:var(--surface2); }

    /* Results */
    .score-hero { text-align:center; padding:28px 20px; border-radius:16px; border:1px solid var(--border); background:var(--surface); margin-bottom:20px; }
    .score-big { font-family:'Unbounded',sans-serif; font-size:4rem; font-weight:900; color:var(--lime); text-shadow:0 0 30px rgba(200,255,0,0.4); line-height:1; }
    .score-pct { font-family:'Unbounded',sans-serif; font-size:1.6rem; color:var(--soft); margin-top:6px; }
    .rword { padding:10px 14px; border-radius:10px; display:flex; align-items:center; justify-content:space-between; font-weight:700; font-size:0.9rem; text-transform:capitalize; }
    .rw-ok { background:rgba(61,255,160,0.1); border:1px solid rgba(61,255,160,0.3); color:var(--green); }
    .rw-bad { background:rgba(255,79,106,0.1); border:1px solid rgba(255,79,106,0.3); color:#ff8fa1; }

    /* Test row */
    .test-row { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:8px; }

    /* Info box */
    .info-box { border-radius:12px; padding:16px; border:1px solid; }
    .info-danger { background:rgba(255,79,106,0.07); border-color:rgba(255,79,106,0.25); }
    .info-teal { background:rgba(0,212,180,0.07); border-color:rgba(0,212,180,0.25); }

    /* Spinner */
    .spinner { width:26px; height:26px; border:3px solid var(--surface2); border-top-color:var(--lime); border-radius:50%; animation:spin 0.8s linear infinite; display:inline-block; vertical-align:middle; margin-right:10px; }
    @keyframes spin{ to{transform:rotate(360deg);} }

    /* FAB */
    .fab-row { position:fixed; bottom:22px; right:18px; z-index:1000; }
    .fab { width:48px; height:48px; border-radius:50%; border:1px solid var(--border-hi); background:#17172a; cursor:pointer; font-size:1.1rem; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 16px rgba(0,0,0,0.5); color:var(--text); transition:transform 0.2s; font-family:'Syne',sans-serif; font-weight:700; }
    .fab:hover{ transform:scale(1.1); }

    /* Modal */
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px; backdrop-filter:blur(4px); }
    .modal-card { background:#17172a; border:1px solid var(--border-hi); border-radius:22px; max-width:520px; width:100%; max-height:85vh; overflow-y:auto; padding:30px; position:relative; box-shadow:0 40px 100px rgba(0,0,0,0.7); }

    /* Animations */
    @keyframes fadeUp{ from{opacity:0;transform:translateY(14px);} to{opacity:1;transform:translateY(0);} }
    @keyframes pop{ 0%{transform:scale(0.85);opacity:0;} 60%{transform:scale(1.05);} 100%{transform:scale(1);opacity:1;} }
    .pop { animation:pop 0.35s ease; }
    @keyframes blink{ 0%,100%{opacity:1;} 50%{opacity:0.25;} }

    /* Helpers */
    .row { display:flex; align-items:center; }
    .col { display:flex; flex-direction:column; }
    .jb { justify-content:space-between; }
    .jc { justify-content:center; }
    .gap2 { gap:8px; }
    .gap3 { gap:12px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:460px){ .grid2{grid-template-columns:1fr;} }
    .mb1{margin-bottom:4px;} .mb2{margin-bottom:8px;} .mb3{margin-bottom:12px;} .mb4{margin-bottom:16px;} .mb6{margin-bottom:24px;} .mb8{margin-bottom:32px;}
    .mt2{margin-top:8px;} .mt3{margin-top:12px;} .mt4{margin-top:16px;}
    .tc{text-align:center;}
    .sep{height:1px;background:var(--border);margin:18px 0;}
    .f700{font-weight:700;}
    .fs-sm{font-size:0.82rem;} .fs-xs{font-size:0.72rem;letter-spacing:0.06em;text-transform:uppercase;}
    .soft{color:var(--soft);} .muted{color:var(--muted);}

    /* Home */
    .badge { display:inline-flex; align-items:center; gap:8px; background:var(--lime-dim); border:1px solid rgba(200,255,0,0.22); border-radius:100px; padding:5px 14px; font-size:0.75rem; font-weight:700; color:var(--lime); letter-spacing:0.07em; text-transform:uppercase; margin-bottom:20px; }
    .badge .dot { width:6px; height:6px; border-radius:50%; background:var(--lime); animation:blink 1.8s ease-in-out infinite; }
    .list-banner { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background:var(--lime-dim); border:1px solid rgba(200,255,0,0.2); border-radius:13px; cursor:pointer; transition:border-color 0.2s, background 0.2s; gap:10px; }
    .list-banner:hover { border-color:rgba(200,255,0,0.4); background:rgba(200,255,0,0.14); }

    /* Game */
    .game-hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; padding-bottom:14px; border-bottom:1px solid var(--border); flex-wrap:wrap; gap:8px; }
    .chip { padding:5px 12px; border-radius:100px; font-size:0.8rem; font-weight:700; background:var(--surface2); border:1px solid var(--border); }
    .chip-lime { background:var(--lime-dim); border-color:rgba(200,255,0,0.3); color:var(--lime); }
    .chip-amber { background:rgba(255,179,71,0.12); border-color:rgba(255,179,71,0.3); color:var(--amber); }
    .listen-area { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:20px; }
</style>
```

</head>
<body>

<div class="fab-row">
    <button class="fab" id="fabHelp" title="Help">?</button>
</div>

<div class="wrap" id="app"></div>

<div class="modal-bg" id="helpModal" style="display:none">
    <div class="modal-card">
        <button id="helpClose" style="position:absolute;top:14px;right:14px;background:var(--surface2);border:1px solid var(--border);color:var(--soft);width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1rem;font-family:sans-serif;">&#x2715;</button>
        <h2 style="font-size:1.3rem;margin-bottom:18px;color:var(--lime);">How to Use Spello</h2>
        <div style="line-height:2.1;color:var(--soft);">
            <p>&#128203; <strong style="color:var(--text)">Add words</strong> to your list in My Words</p>
            <p>&#127757; <strong style="color:var(--text)">Choose a language</strong> when creating a list (en / af / zu)</p>
            <p>&#128266; <strong style="color:var(--text)">Listen</strong> to the word, then spell it</p>
            <p>&#128218; <strong style="color:var(--text)">Get a hint</strong> &#8212; see the definition without the word shown</p>
            <p>&#128106; <strong style="color:var(--text)">Parent dashboard</strong> tracks all progress and history</p>
            <p>&#128229; <strong style="color:var(--text)">Export CSV</strong> to share results</p>
        </div>
    </div>
</div>

<script>
// ── State ──────────────────────────────────────────────────────────────────────
var S = {
    page: 'home',
    lists: [],
    listIdx: 0,
    wordIdx: 0,
    score: 0,
    streak: 0,
    correctSet: [],
    userAnswer: '',
    answered: false,
    showHint: false,
    hintLoading: false,
    def: null,
    bestStreak: 0,
    totalWords: 0,
    results: []
};

// ── Persist ────────────────────────────────────────────────────────────────────
function load() {
    try {
        var d;
        d = localStorage.getItem('sp_lists');
        S.lists = d ? JSON.parse(d) : [{name:'My Words', lang:'en', words:[]}];
        if (!S.lists.length) S.lists = [{name:'My Words', lang:'en', words:[]}];
        d = localStorage.getItem('sp_li');
        S.listIdx = d ? Math.min(parseInt(d,10)||0, S.lists.length-1) : 0;
        d = localStorage.getItem('sp_best'); if (d) S.bestStreak = parseInt(d,10)||0;
        d = localStorage.getItem('sp_total'); if (d) S.totalWords = parseInt(d,10)||0;
        d = localStorage.getItem('sp_results'); if (d) S.results = JSON.parse(d);
    } catch(e){ console.warn('load error',e); }
}
function save() {
    try {
        localStorage.setItem('sp_lists', JSON.stringify(S.lists));
        localStorage.setItem('sp_li', S.listIdx);
        localStorage.setItem('sp_best', S.bestStreak);
        localStorage.setItem('sp_total', S.totalWords);
        localStorage.setItem('sp_results', JSON.stringify(S.results));
    } catch(e){ console.warn('save error',e); }
}

// ── Speech ─────────────────────────────────────────────────────────────────────
var voice = null;
function pickVoice(lang) {
    if (!window.speechSynthesis) return;
    var voices = window.speechSynthesis.getVoices();
    if (!voices.length) return;
    if (lang === 'af') {
        voice = voices.find(function(v){return v.lang.startsWith('af');}) ||
                voices.find(function(v){return v.lang === 'en-ZA';}) || null;
    } else if (lang === 'zu') {
        voice = voices.find(function(v){return v.lang.startsWith('zu');}) ||
                voices.find(function(v){return v.lang === 'en-ZA';}) || null;
    } else {
        voice = voices.find(function(v){return v.lang === 'en-ZA';}) ||
                voices.find(function(v){return v.lang === 'en-GB';}) ||
                voices.find(function(v){return v.lang.startsWith('en');}) || null;
    }
}
if (window.speechSynthesis) {
    window.speechSynthesis.onvoiceschanged = function() {
        pickVoice(S.lists[S.listIdx] ? S.lists[S.listIdx].lang : 'en');
    };
}
function speak(text, rate) {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
    var u = new SpeechSynthesisUtterance(text);
    if (voice) u.voice = voice;
    u.rate = rate || 0.75; u.pitch = 1; u.volume = 1;
    setTimeout(function(){ window.speechSynthesis.speak(u); }, 60);
}

// ── Dictionary ─────────────────────────────────────────────────────────────────
function fetchDef(word, lang, cb) {
    if (lang === 'en') {
        fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word))
            .then(function(r) {
                if (!r.ok) throw new Error('not found');
                return r.json();
            })
            .then(function(data) {
                var m = data[0] && data[0].meanings && data[0].meanings[0];
                var d = m && m.definitions && m.definitions[0];
                cb({
                    definition: d ? d.definition : 'No definition found.',
                    example: (d && d.example) ? d.example : ''
                });
            })
            .catch(function() {
                cb({ definition: 'Definition not available. Check your internet connection.', example: '' });
            });
    } else if (lang === 'af') {
        cb({
            definition: "Afrikaans: Hierdie woord word gebruik in alledaagse kommunikasie. Probeer om dit in 'n sin te gebruik.",
            example: "Die leerder het die woord korrek gespel."
        });
    } else {
        cb({
            definition: "IsiZulu: Leli gama lisetshenziswa ekuxhumaneni nsuku zonke. Zama ukulisebenzisa emusho.",
            example: "Umfundi ubhale igama ngendlela efanele."
        });
    }
}

// ── List helpers ───────────────────────────────────────────────────────────────
function curList() { return S.lists[S.listIdx] || {name:'', lang:'en', words:[]}; }
function curWords() { return curList().words; }

function setListIdx(i) {
    S.listIdx = i;
    pickVoice(S.lists[i].lang);
    save(); render();
}

function addList() {
    var name = prompt('List name:');
    if (!name || !name.trim()) return;
    var lang = (prompt('Language (en / af / zu):', 'en') || 'en').toLowerCase().trim();
    if (['en','af','zu'].indexOf(lang) === -1) lang = 'en';
    S.lists.push({name: name.trim(), lang: lang, words: []});
    S.listIdx = S.lists.length - 1;
    save(); render();
}

function deleteList(i) {
    if (S.lists.length <= 1) { alert('Keep at least one list.'); return; }
    if (!confirm('Delete list "' + S.lists[i].name + '"?')) return;
    S.lists.splice(i, 1);
    if (S.listIdx >= S.lists.length) S.listIdx = S.lists.length - 1;
    save(); render();
}

function addWord() {
    var inp = document.getElementById('wordinp');
    if (!inp) return;
    var w = inp.value.trim().toLowerCase().replace(/[^a-z\-']/g, '');
    if (!w) { inp.value = ''; return; }
    var words = S.lists[S.listIdx].words;
    if (words.indexOf(w) === -1) {
        words.push(w);
        save(); render();
    } else {
        inp.value = '';
    }
    var fresh = document.getElementById('wordinp');
    if (fresh) fresh.focus();
}

function removeWord(i) {
    S.lists[S.listIdx].words.splice(i, 1);
    save(); render();
}

// ── Game ───────────────────────────────────────────────────────────────────────
function startGame() {
    if (!curWords().length) { alert('Add some words to this list first!'); return; }
    pickVoice(curList().lang);
    S.page = 'playing'; S.wordIdx = 0; S.score = 0; S.streak = 0;
    S.correctSet = []; S.userAnswer = ''; S.answered = false;
    S.showHint = false; S.hintLoading = false; S.def = null;
    render();
    setTimeout(speakWord, 400);
}

function speakWord() { speak(curWords()[S.wordIdx], 0.65); }

function showDefinition() {
    S.showHint = true; S.hintLoading = true; S.def = null;
    render();
    fetchDef(curWords()[S.wordIdx], curList().lang, function(data) {
        S.def = data; S.hintLoading = false;
        render();
        speak(data.definition, 0.82);
    });
}

function replayDef() {
    if (S.def && S.def.definition) speak(S.def.definition, 0.82);
}

function checkAnswer() {
    var inp = document.getElementById('ansinp');
    var val = inp ? inp.value.trim().toLowerCase() : '';
    S.userAnswer = val;
    var correct = (val === curWords()[S.wordIdx]);
    if (correct) {
        S.score++;
        S.correctSet.push(S.wordIdx);
        S.streak++;
        if (S.streak > S.bestStreak) S.bestStreak = S.streak;
        S.totalWords++;
    } else {
        S.streak = 0;
    }
    S.answered = true;
    save();
    render();
}

function nextWord() {
    if (S.wordIdx < curWords().length - 1) {
        S.wordIdx++;
        S.userAnswer = ''; S.answered = false;
        S.showHint = false; S.hintLoading = false; S.def = null;
        render();
        setTimeout(speakWord, 200);
    } else {
        endGame();
    }
}

function endGame() {
    var words = curWords();
    var pct = Math.round((S.score / words.length) * 100);
    S.results.push({
        date: new Date().toISOString(),
        listName: curList().name,
        lang: curList().lang,
        words: words.slice(),
        score: S.score,
        total: words.length,
        pct: pct,
        correct: S.correctSet.slice()
    });
    save();
    S.page = 'results';
    render();
}

function practiceAgain() {
    S.page = 'playing'; S.wordIdx = 0; S.score = 0; S.streak = 0;
    S.correctSet = []; S.userAnswer = ''; S.answered = false;
    S.showHint = false; S.hintLoading = false; S.def = null;
    render();
    setTimeout(speakWord, 400);
}

// ── Nav ────────────────────────────────────────────────────────────────────────
function goHome()   { S.page = 'home';   render(); }
function goManage() { S.page = 'manage'; render(); }
function goParent() { S.page = 'parent'; render(); }

function clearAll() {
    if (!confirm('Delete ALL lists and test history? This cannot be undone.')) return;
    localStorage.clear();
    S.lists = [{name:'My Words', lang:'en', words:[]}];
    S.listIdx = 0; S.bestStreak = 0; S.totalWords = 0; S.results = [];
    save(); render();
}

function exportCSV() {
    if (!S.results.length) { alert('No results to export yet.'); return; }
    var rows = [['Date','List','Lang','Score','Percent','Words']];
    S.results.forEach(function(r) {
        rows.push([
            new Date(r.date).toLocaleDateString(),
            r.listName, r.lang,
            r.score + '/' + r.total,
            r.pct + '%',
            r.words.join('; ')
        ]);
    });
    var csv = rows.map(function(row) {
        return row.map(function(c) { return '"' + String(c).replace(/"/g,'""') + '"'; }).join(',');
    }).join('\r\n');
    var a = document.createElement('a');
    a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
    a.download = 'spello-' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
}

// ── HTML builders (no template literals to avoid nesting issues) ───────────────

function renderHome() {
    var al = curList();
    var wc = al.words.length;
    var last = S.results.length ? S.results[S.results.length-1] : null;

    var lastHtml = '';
    if (last) {
        var col = last.pct >= 80 ? 'var(--green)' : last.pct >= 60 ? 'var(--amber)' : 'var(--red)';
        lastHtml = '<div class="info-box info-teal mb4">' +
            '<div class="fs-xs muted mb1">Last Test</div>' +
            '<div class="f700">' + esc(last.listName) + ' &mdash; ' + last.score + '/' + last.total +
            ' <span style="color:' + col + '">(' + last.pct + '%)</span></div>' +
            '</div>';
    }

    var startDis = wc ? '' : 'disabled';

    return '<div style="padding-top:4px;">' +
        '<div class="tc mb8">' +
            '<div class="badge"><span class="dot"></span>Spelling Practice</div>' +
            '<div class="logo">Spello.</div>' +
            '<p class="soft" style="font-size:1.05rem;margin-top:14px;line-height:1.65;max-width:420px;margin-left:auto;margin-right:auto;">' +
                'Master spelling by listening &mdash; not just memorising. Supports English, Afrikaans &amp; Zulu.' +
            '</p>' +
        '</div>' +
        '<div class="stats-row mb6">' +
            '<div class="stat"><span class="stat-n" style="color:var(--amber)">' + S.bestStreak + '</span><span class="stat-l">Best Streak &#x1F525;</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--green)">' + S.totalWords + '</span><span class="stat-l">Mastered &#x1F4DA;</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--violet)">' + S.results.length + '</span><span class="stat-l">Tests Done</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--lime)">' + wc + '</span><span class="stat-l">Ready &#x1F3AF;</span></div>' +
        '</div>' +
        '<div class="list-banner mb3" id="listBannerBtn">' +
            '<div>' +
                '<div class="fs-xs muted mb1">Active List</div>' +
                '<div class="f700" style="font-size:1rem;">' + esc(al.name) +
                    ' <span style="font-size:0.65rem;padding:2px 8px;border-radius:100px;background:var(--lime-dim);color:var(--lime);border:1px solid rgba(200,255,0,0.25);text-transform:uppercase;letter-spacing:0.06em;margin-left:6px;">' + esc(al.lang) + '</span>' +
                '</div>' +
                '<div class="muted fs-sm" style="margin-top:2px;">' + wc + ' word' + (wc!==1?'s':'') + ' &mdash; tap to manage</div>' +
            '</div>' +
            '<span style="font-size:1.4rem;color:var(--muted);">&rsaquo;</span>' +
        '</div>' +
        lastHtml +
        '<div class="col gap3">' +
            '<button class="btn btn-lime btn-lg w-full" id="startBtn" ' + startDis + '>' +
                (wc ? '&#x1F680; Start Spelling Test' : '&#x270F;&#xFE0F; Add Words to Start') +
            '</button>' +
            '<button class="btn btn-ghost w-full" id="manageBtn">&#x1F4CB; Manage Word Lists</button>' +
            '<button class="btn btn-ghost w-full" id="parentBtn">&#x1F46A; Parent Dashboard</button>' +
        '</div>' +
    '</div>';
}

function renderManage() {
    var al = curList();
    var tabsHtml = '';
    for (var i = 0; i < S.lists.length; i++) {
        tabsHtml += '<div class="tab ' + (i === S.listIdx ? 'on' : '') + '" data-li="' + i + '">' +
            esc(S.lists[i].name) + ' <span class="lbadge">' + esc(S.lists[i].lang) + '</span> <span style="opacity:0.6">' + S.lists[i].words.length + '</span>' +
        '</div>';
    }
    tabsHtml += '<div class="tab" id="addListBtn">+ New</div>';

    var delBtn = S.lists.length > 1
        ? '<button class="btn btn-danger btn-sm mt2" id="delListBtn">Delete &ldquo;' + esc(al.name) + '&rdquo;</button>'
        : '';

    var wordsHtml = '';
    if (al.words.length) {
        var chips = '';
        for (var j = 0; j < al.words.length; j++) {
            chips += '<div class="wchip"><span class="wname">' + esc(al.words[j]) + '</span>' +
                '<button class="wdel" data-wi="' + j + '">&#x2715;</button></div>';
        }
        wordsHtml = '<div class="mb6">' +
            '<div class="fs-xs muted mb3">' + al.words.length + ' Words</div>' +
            '<div class="word-grid">' + chips + '</div>' +
        '</div>';
    } else {
        wordsHtml = '<div class="tc mb6" style="padding:24px 0;">' +
            '<div style="font-size:2.2rem;margin-bottom:10px;">&#x270F;&#xFE0F;</div>' +
            '<p class="muted">No words yet. Add some above.</p>' +
        '</div>';
    }

    return '<div class="card">' +
        '<div class="row jb mb6">' +
            '<h2 style="font-size:1.3rem;">&#x1F4CB; Word Lists</h2>' +
            '<button class="btn btn-ghost btn-sm" id="homeBtn2">&#x2190; Home</button>' +
        '</div>' +
        '<div class="mb6">' +
            '<div class="fs-xs muted mb3">Your Lists</div>' +
            '<div class="tab-row mb3" id="tabRow">' + tabsHtml + '</div>' +
            delBtn +
        '</div>' +
        '<div class="sep"></div>' +
        '<div class="mb4">' +
            '<div class="fs-xs muted mb3">Add Word to &ldquo;' + esc(al.name) + '&rdquo; (' + al.lang.toUpperCase() + ')</div>' +
            '<div class="row gap3">' +
                '<input id="wordinp" class="word-inp" placeholder="Type a word&hellip;" />' +
                '<button class="btn btn-lime" id="addWordBtn">Add</button>' +
            '</div>' +
        '</div>' +
        wordsHtml +
        '<button class="btn btn-lime btn-lg w-full" id="startBtn2" ' + (al.words.length ? '' : 'disabled') + '>&#x1F680; Start Spelling Test</button>' +
    '</div>';
}

function renderPlay() {
    var words = curWords();
    var w = words[S.wordIdx];
    var total = words.length;
    var pct = Math.round(((S.wordIdx + (S.answered ? 1 : 0)) / total) * 100);
    var list = curList();
    var isCorrect = S.answered && (S.userAnswer === w);

    var hintHtml = '';
    if (S.showHint) {
        if (S.hintLoading) {
            hintHtml = '<div class="dict-box"><span class="spinner"></span><span class="muted">Loading definition&hellip;</span></div>';
        } else if (S.def) {
            hintHtml = '<div class="dict-box">' +
                '<div class="dict-def">' + esc(S.def.definition) + '</div>' +
                (S.def.example ? '<div class="dict-ex">&ldquo;' + esc(S.def.example) + '&rdquo;</div>' : '') +
                '<button class="btn btn-ghost btn-sm mt3" id="replayBtn">&#x21BB; Read aloud</button>' +
            '</div>';
        } else {
            hintHtml = '<div class="dict-box"><p class="muted">No definition available.</p></div>';
        }
    }

    var defBtnHtml = (!S.showHint || S.hintLoading)
        ? '<button class="btn btn-violet w-full mt3" id="defBtn">&#x1F4D6; Show Definition (word hidden)</button>'
        : '';

    var fbHtml = '';
    if (S.answered) {
        if (isCorrect) {
            fbHtml = '<div class="fb-box fb-ok mb4 pop"><span class="fb-emoji">&#x1F389;</span><div style="font-weight:800;font-size:1.1rem;color:var(--green)">Perfect!</div></div>';
        } else {
            fbHtml = '<div class="fb-box fb-bad mb4 pop">' +
                '<span class="fb-emoji">&#x1F4AA;</span>' +
                '<div class="soft f700 mb2">Correct spelling:</div>' +
                '<div class="fb-word">' + esc(w) + '</div>' +
            '</div>';
        }
    }

    var actionHtml = '';
    if (!S.answered) {
        actionHtml = '<button class="btn btn-lime btn-lg w-full" id="checkBtn">&#x2705; Check Answer</button>';
    } else if (S.wordIdx < total - 1) {
        actionHtml = '<button class="btn btn-lime btn-lg w-full" id="nextBtn">&rarr; Next Word</button>';
    } else {
        actionHtml = '<button class="btn btn-lime btn-lg w-full" id="nextBtn">&#x1F3C1; See Results</button>';
    }

    return '<div class="card">' +
        '<div class="game-hdr">' +
            '<div class="f700" style="font-size:0.9rem;">' + esc(list.name) + ' <span class="lbadge" style="background:var(--lime-dim);color:var(--lime);">' + esc(list.lang) + '</span></div>' +
            '<div class="row gap2">' +
                '<div class="chip chip-lime">&#x2B50; ' + S.score + '</div>' +
                '<div class="chip chip-amber">&#x1F525; ' + S.streak + '</div>' +
            '</div>' +
            '<button class="btn btn-ghost btn-sm" id="exitBtn">Exit</button>' +
        '</div>' +
        '<div class="mb6">' +
            '<div class="row jb mb2">' +
                '<span class="muted fs-sm">Word ' + (S.wordIdx+1) + ' of ' + total + '</span>' +
                '<span class="muted fs-sm">' + pct + '%</span>' +
            '</div>' +
            '<div class="prog-wrap"><div class="prog-fill" style="width:' + pct + '%"></div></div>' +
        '</div>' +
        '<div class="listen-area mb4">' +
            '<button class="speak-btn" id="speakBtn"><span class="speak-icon">&#x1F50A;</span> HEAR THE WORD</button>' +
            defBtnHtml +
            hintHtml +
        '</div>' +
        '<div class="mb4">' +
            '<input id="ansinp" class="ans-inp" value="' + esc(S.answered ? S.userAnswer : '') + '" placeholder="Type the word here&hellip;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ' + (S.answered ? 'disabled' : '') + ' />' +
        '</div>' +
        fbHtml +
        actionHtml +
    '</div>';
}

function renderResults() {
    var words = curWords();
    var pct = Math.round((S.score / words.length) * 100);
    var emoji = pct === 100 ? '&#x1F3C6;' : pct >= 80 ? '&#x1F389;' : pct >= 60 ? '&#x1F44D;' : '&#x1F4AA;';

    var rowsHtml = '';
    for (var i = 0; i < words.length; i++) {
        var ok = S.correctSet.indexOf(i) !== -1;
        rowsHtml += '<div class="rword ' + (ok ? 'rw-ok' : 'rw-bad') + '"><span>' + esc(words[i]) + '</span><span>' + (ok ? '&#x2713;' : '&#x2717;') + '</span></div>';
    }

    return '<div class="card">' +
        '<div class="row jb mb6">' +
            '<h2 style="font-size:1.3rem;">&#x1F3C1; Results</h2>' +
            '<button class="btn btn-ghost btn-sm" id="homeBtn3">Home</button>' +
        '</div>' +
        '<div class="score-hero mb6 pop">' +
            '<div style="font-size:3rem;margin-bottom:8px">' + emoji + '</div>' +
            '<div class="score-big">' + S.score + '<span style="color:var(--muted);font-size:2rem;">/' + words.length + '</span></div>' +
            '<div class="score-pct">' + pct + '% correct</div>' +
        '</div>' +
        '<div class="word-grid mb6">' + rowsHtml + '</div>' +
        '<div class="grid2">' +
            '<button class="btn btn-lime" id="againBtn">&#x1F504; Try Again</button>' +
            '<button class="btn btn-ghost" id="listsBtn">&#x1F4CB; My Lists</button>' +
        '</div>' +
    '</div>';
}

function renderParent() {
    var total = S.results.length;
    var avgPct = total ? Math.round(S.results.reduce(function(a,r){return a+r.pct;},0)/total) : 0;

    var bodyHtml = '';
    if (!total) {
        bodyHtml = '<div class="tc" style="padding:36px 0;">' +
            '<div style="font-size:2.8rem;margin-bottom:12px">&#x1F4CA;</div>' +
            '<p class="muted">No tests completed yet.</p>' +
        '</div>';
    } else {
        bodyHtml = '<div class="stats-row mb6">' +
            '<div class="stat"><span class="stat-n" style="color:var(--violet)">' + total + '</span><span class="stat-l">Tests</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--green)">' + S.totalWords + '</span><span class="stat-l">Mastered</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--amber)">' + S.bestStreak + '</span><span class="stat-l">Best Streak</span></div>' +
            '<div class="stat"><span class="stat-n" style="color:var(--lime)">' + avgPct + '%</span><span class="stat-l">Avg Score</span></div>' +
        '</div>';

        var slice = S.results.slice(-8).reverse();
        bodyHtml += '<div class="fs-xs muted mb3">Recent Tests</div>';
        for (var i = 0; i < slice.length; i++) {
            var r = slice[i];
            var col = r.pct >= 80 ? 'var(--green)' : r.pct >= 60 ? 'var(--amber)' : 'var(--red)';
            var barCol = r.pct >= 80
                ? 'linear-gradient(90deg,var(--teal),var(--green))'
                : r.pct >= 60 ? 'linear-gradient(90deg,var(--amber),#ffd070)'
                : 'linear-gradient(90deg,var(--red),#ff8fa1)';
            bodyHtml += '<div class="test-row">' +
                '<div class="row jb mb2">' +
                    '<div class="f700">' + esc(r.listName) + ' <span class="lbadge">' + esc(r.lang) + '</span></div>' +
                    '<div class="row gap2"><span style="font-weight:800;color:' + col + '">' + r.pct + '%</span>' +
                    '<span class="muted fs-sm">' + new Date(r.date).toLocaleDateString() + '</span></div>' +
                '</div>' +
                '<div class="prog-wrap mb2"><div class="prog-fill" style="width:' + r.pct + '%;background:' + barCol + '"></div></div>' +
                '<div class="muted fs-sm">' + r.score + '/' + r.total + ' correct &mdash; ' + r.words.map(esc).join(', ') + '</div>' +
            '</div>';
        }
    }

    return '<div class="card">' +
        '<div class="row jb mb6">' +
            '<h2 style="font-size:1.3rem;">&#x1F46A; Parent Dashboard</h2>' +
            '<div class="row gap2">' +
                '<button class="btn btn-ghost btn-sm" id="csvBtn">&#x1F4E5; CSV</button>' +
                '<button class="btn btn-ghost btn-sm" id="homeBtn4">Home</button>' +
            '</div>' +
        '</div>' +
        bodyHtml +
        '<div class="sep"></div>' +
        '<div class="info-box info-danger">' +
            '<div class="f700 mb2">&#x26A0;&#xFE0F; Danger Zone</div>' +
            '<p class="muted fs-sm mb3">Permanently deletes all lists and test history.</p>' +
            '<button class="btn btn-danger btn-sm" id="clearBtn">&#x1F5D1;&#xFE0F; Delete All Data</button>' +
        '</div>' +
    '</div>';
}

// ── Render + wire events ───────────────────────────────────────────────────────
function render() {
    var app = document.getElementById('app');
    if      (S.page === 'home')    app.innerHTML = renderHome();
    else if (S.page === 'manage')  app.innerHTML = renderManage();
    else if (S.page === 'playing') app.innerHTML = renderPlay();
    else if (S.page === 'results') app.innerHTML = renderResults();
    else if (S.page === 'parent')  app.innerHTML = renderParent();
    wireEvents();
}

function wireEvents() {
    var el = function(id){ return document.getElementById(id); };

    // Home
    if (S.page === 'home') {
        var sb = el('startBtn');
        if (sb) sb.addEventListener('click', startGame);
        var lb = el('listBannerBtn');
        if (lb) lb.addEventListener('click', goManage);
        var mb = el('manageBtn');
        if (mb) mb.addEventListener('click', goManage);
        var pb = el('parentBtn');
        if (pb) pb.addEventListener('click', goParent);
    }

    // Manage
    if (S.page === 'manage') {
        var h2 = el('homeBtn2');
        if (h2) h2.addEventListener('click', goHome);
        var alb = el('addListBtn');
        if (alb) alb.addEventListener('click', addList);
        var dlb = el('delListBtn');
        if (dlb) dlb.addEventListener('click', function(){ deleteList(S.listIdx); });
        var awb = el('addWordBtn');
        if (awb) awb.addEventListener('click', addWord);
        var wi = el('wordinp');
        if (wi) {
            wi.addEventListener('keydown', function(e){ if(e.key==='Enter') addWord(); });
            wi.focus();
        }
        var sb2 = el('startBtn2');
        if (sb2) sb2.addEventListener('click', startGame);
        // Tab clicks
        var tabRow = el('tabRow');
        if (tabRow) {
            tabRow.addEventListener('click', function(e){
                var t = e.target.closest('[data-li]');
                if (t) setListIdx(parseInt(t.getAttribute('data-li'),10));
            });
        }
        // Word delete clicks
        var wg = document.querySelector('.word-grid');
        if (wg) {
            wg.addEventListener('click', function(e){
                var d = e.target.closest('[data-wi]');
                if (d) removeWord(parseInt(d.getAttribute('data-wi'),10));
            });
        }
    }

    // Playing
    if (S.page === 'playing') {
        var spk = el('speakBtn');
        if (spk) spk.addEventListener('click', speakWord);
        var def = el('defBtn');
        if (def) def.addEventListener('click', showDefinition);
        var rep = el('replayBtn');
        if (rep) rep.addEventListener('click', replayDef);
        var chk = el('checkBtn');
        if (chk) chk.addEventListener('click', checkAnswer);
        var nxt = el('nextBtn');
        if (nxt) nxt.addEventListener('click', nextWord);
        var ext = el('exitBtn');
        if (ext) ext.addEventListener('click', goHome);
        var ai = el('ansinp');
        if (ai && !S.answered) {
            ai.focus();
            ai.addEventListener('keydown', function(e){ if(e.key==='Enter') checkAnswer(); });
        }
    }

    // Results
    if (S.page === 'results') {
        var h3 = el('homeBtn3');
        if (h3) h3.addEventListener('click', goHome);
        var ag = el('againBtn');
        if (ag) ag.addEventListener('click', practiceAgain);
        var ls = el('listsBtn');
        if (ls) ls.addEventListener('click', goManage);
    }

    // Parent
    if (S.page === 'parent') {
        var h4 = el('homeBtn4');
        if (h4) h4.addEventListener('click', goHome);
        var csv = el('csvBtn');
        if (csv) csv.addEventListener('click', exportCSV);
        var clr = el('clearBtn');
        if (clr) clr.addEventListener('click', clearAll);
    }
}

// ── Utility ────────────────────────────────────────────────────────────────────
function esc(str) {
    return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;');
}

// ── Modal events ───────────────────────────────────────────────────────────────
document.getElementById('fabHelp').addEventListener('click', function(){
    document.getElementById('helpModal').style.display = 'flex';
});
document.getElementById('helpClose').addEventListener('click', function(){
    document.getElementById('helpModal').style.display = 'none';
});
document.getElementById('helpModal').addEventListener('click', function(e){
    if (e.target === this) this.style.display = 'none';
});

// ── Boot ───────────────────────────────────────────────────────────────────────
load();
render();
</script>

</body>
</html> 