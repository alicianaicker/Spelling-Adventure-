<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Adventure - South African English</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark mode styles */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .dark-mode .bg-white {
            background-color: #1e1e2f;
            color: #e0e0e0;
        }
        .dark-mode .text-gray-600 {
            color: #b0b0b0;
        }
        .dark-mode .text-gray-500 {
            color: #909090;
        }
        .dark-mode .bg-gray-50 {
            background-color: #2a2a3a;
        }
        .dark-mode .bg-gray-100 {
            background-color: #2a2a3a;
        }
        .dark-mode .border-2 {
            border-color: #4a4a6a;
        }
        .dark-mode input {
            background-color: #2a2a3a;
            color: #e0e0e0;
            border-color: #4a4a6a;
        }
        .dark-mode .bg-yellow-100 {
            background-color: #4a3a2a;
            color: #e0b080;
        }
        .dark-mode .bg-green-100 {
            background-color: #2a4a3a;
            color: #a0e0a0;
        }
        .dark-mode .bg-blue-100 {
            background-color: #2a3a5a;
            color: #a0c0ff;
        }
        .dark-mode .bg-purple-100 {
            background-color: #3a2a5a;
            color: #d0a0ff;
        }
        .dark-mode .bg-red-100 {
            background-color: #5a2a2a;
            color: #ffa0a0;
        }
        
        .correct-icon {
            color: #10b981;
            animation: pop 0.3s ease;
        }
        .incorrect-icon {
            color: #ef4444;
            animation: shake 0.3s ease;
        }
        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .stat-card {
            transition: all 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        .theme-toggle {
            transition: all 0.3s ease;
        }
        .theme-toggle:hover {
            transform: rotate(15deg);
        }
        .hint-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #4a4a6a;
        }
        .dark-mode .hint-text {
            color: #d0d0ff;
        }
        .speak-button {
            transition: all 0.2s ease;
        }
        .speak-button:active {
            transform: scale(0.95);
        }
        .word-highlight {
            font-weight: 700;
            color: #7c3aed;
            background: rgba(124, 58, 237, 0.1);
            padding: 0 4px;
            border-radius: 4px;
        }
        .dark-mode .word-highlight {
            color: #a78bfa;
            background: rgba(167, 139, 250, 0.2);
        }
    </style>
</head>
<body id="body" class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 min-h-screen transition-colors duration-300">
    <div id="app"></div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let state = {
            mode: 'home',
            gameState: 'setup',
            studentName: '',
            words: [],
            currentIndex: 0,
            userAnswer: '',
            score: 0,
            showAnswer: false,
            answered: false,
            correctAnswers: [],
            streak: 0,
            bestStreak: parseInt(localStorage.getItem('bestStreak') || '0'),
            totalWords: parseInt(localStorage.getItem('totalWords') || '0'),
            testResults: JSON.parse(localStorage.getItem('testResults') || '[]'),
            showHint: false,
            darkMode: localStorage.getItem('darkMode') === 'true'
        };

        // Apply dark mode on load
        if (state.darkMode) {
            document.getElementById('body').classList.add('dark-mode');
        }

        // ==================== SOUTH AFRICAN SPEECH FUNCTIONS ====================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Small delay to ensure clean playback
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Get available voices
                    const voices = window.speechSynthesis.getVoices();
                    
                    // Try to find a South African English voice
                    let selectedVoice = voices.find(voice => 
                        voice.lang.includes('en-ZA') || 
                        voice.name.includes('South African') ||
                        voice.name.includes('Tessa') ||
                        voice.name.includes('Zola')
                    );
                    
                    // Fallback to any English voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.lang.includes('en-'));
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                    }
                    
                    // Clear, slow, deliberate speech
                    utterance.rate = 0.75;      // Slower for clarity
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    window.speechSynthesis.speak(utterance);
                }, 100);
            }
        }

        // Pre-load voices
        if ('speechSynthesis' in window) {
            window.speechSynthesis.getVoices();
            window.speechSynthesis.onvoiceschanged = function() {
                window.speechSynthesis.getVoices();
            };
        }

        // ==================== IMPROVED HINT SYSTEM - NO WORD IN TEXT ====================
        function getContextualHint(word) {
            word = word.toLowerCase().trim();
            
            if (!word) return "Please enter a word to spell.";
            
            // Category 1: Animals
            const animals = ['cat', 'dog', 'fish', 'bird', 'rabbit', 'horse', 'cow', 'lion', 'tiger', 'elephant', 'giraffe', 'zebra', 'monkey', 'snake', 'frog'];
            if (animals.includes(word)) {
                const hints = [
                    "This animal is often kept as a pet.",
                    "You might see this animal on a farm.",
                    "This animal lives in the wild.",
                    "This animal makes a distinctive sound.",
                    "Children love to learn about this animal."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 2: Food
            const foods = ['apple', 'banana', 'orange', 'bread', 'milk', 'cake', 'pizza', 'rice', 'soup', 'egg', 'cheese', 'chicken', 'fish', 'water'];
            if (foods.includes(word)) {
                const hints = [
                    "You can eat this for breakfast.",
                    "This is a healthy food to eat.",
                    "Many people enjoy eating this.",
                    "You might find this in a kitchen.",
                    "This is something you can buy at a shop."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 3: Actions (verbs)
            const actions = ['run', 'jump', 'swim', 'fly', 'eat', 'drink', 'sleep', 'play', 'read', 'write', 'sing', 'dance', 'walk', 'talk'];
            if (actions.includes(word)) {
                const hints = [
                    "This is something you can do with your body.",
                    "People do this every day.",
                    "This is an action word.",
                    "You can do this for fun.",
                    "This is something active."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 4: Colors
            const colors = ['red', 'blue', 'green', 'yellow', 'orange', 'purple', 'brown', 'black', 'white', 'pink'];
            if (colors.includes(word)) {
                const hints = [
                    "This is a colour you can see in a rainbow.",
                    "Many things in nature are this colour.",
                    "You can find this colour in a box of crayons.",
                    "This colour is bright and easy to spot."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 5: Objects
            const objects = ['ball', 'car', 'book', 'pen', 'chair', 'table', 'door', 'window', 'house', 'school', 'bag', 'shoe', 'hat', 'shirt'];
            if (objects.includes(word)) {
                const hints = [
                    "You can find this in a classroom.",
                    "This is something you use every day.",
                    "This object is useful at home.",
                    "You might see this at school.",
                    "This is a common thing people own."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 6: People
            const people = ['mom', 'dad', 'baby', 'girl', 'boy', 'teacher', 'doctor', 'friend', 'family'];
            if (people.includes(word)) {
                const hints = [
                    "This is someone you know.",
                    "This person is important in your life.",
                    "This is a role that people have.",
                    "You see this person often."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 7: Places
            const places = ['park', 'beach', 'store', 'home', 'zoo', 'school', 'hospital', 'library'];
            if (places.includes(word)) {
                const hints = [
                    "This is a place you can visit.",
                    "People go here for different reasons.",
                    "You might go here with your family.",
                    "This is a fun place to be."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 8: Weather
            const weather = ['rain', 'snow', 'wind', 'cloud', 'sun', 'storm', 'fog'];
            if (weather.includes(word)) {
                const hints = [
                    "This is a type of weather.",
                    "You might see this outside today.",
                    "This affects what you wear.",
                    "This is part of nature."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 9: Words with specific endings
            if (word.endsWith('ing')) {
                return "This word shows an action that is happening right now.";
            }
            if (word.endsWith('ed')) {
                return "This word shows an action that already happened.";
            }
            if (word.endsWith('er') || word.endsWith('or')) {
                return "This word describes a person who does something.";
            }
            if (word.endsWith('ful')) {
                return "This word means 'full of' something.";
            }
            if (word.endsWith('less')) {
                return "This word means 'without' something.";
            }
            if (word.endsWith('y') && word.length > 3) {
                return "This word describes how something looks or feels.";
            }
            
            // Category 10: Very long words
            if (word.length > 8) {
                return "This is quite a long word. Take your time spelling it.";
            }
            
            // Category 11: Short words
            if (word.length <= 4) {
                const hints = [
                    "This is a short word.",
                    "You might use this word every day.",
                    "This word is easy to learn.",
                    "Try to remember how this word sounds."
                ];
                return hints[Math.floor(Math.random() * hints.length)];
            }
            
            // Category 12: Words with double letters
            for (let i = 0; i < word.length - 1; i++) {
                if (word[i] === word[i + 1]) {
                    return "Be careful - this word has two of the same letters together.";
                }
            }
            
            // Default hints for any other word
            const defaultHints = [
                "Listen carefully to how this word sounds.",
                "Think about each letter as you spell it.",
                "Take your time with this word.",
                "Try breaking the word into smaller parts.",
                "You can do this - just focus on the sounds."
            ];
            
            return defaultHints[Math.floor(Math.random() * defaultHints.length)];
        }

        // ==================== DARK MODE TOGGLE ====================
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            
            const body = document.getElementById('body');
            if (state.darkMode) {
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
            }
            
            render();
        }

        // ==================== RENDER FUNCTIONS ====================
        function render() {
            const app = document.getElementById('app');
            
            if (state.mode === 'home') {
                app.innerHTML = `
                    <div class="max-w-4xl mx-auto p-4 md:p-8">
                        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 relative">
                            <!-- Theme Toggle -->
                            <button onclick="toggleDarkMode()" class="absolute top-4 right-4 text-2xl theme-toggle">
                                ${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                            </button>

                            <div class="text-center mb-8">
                                <h1 class="text-5xl md:text-6xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                                    âœ¨ Spelling Adventure âœ¨
                                </h1>
                                <p class="text-xl text-gray-600">South African English Edition ğŸ‡¿ğŸ‡¦</p>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-8">
                                <div class="stat-card bg-yellow-100 rounded-xl p-4 md:p-6 text-center">
                                    <div class="text-3xl md:text-4xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-xs md:text-sm text-yellow-700">ğŸ”¥ Best Streak</div>
                                </div>
                                <div class="stat-card bg-green-100 rounded-xl p-4 md:p-6 text-center">
                                    <div class="text-3xl md:text-4xl font-bold text-green-800">${state.totalWords}</div>
                                    <div class="text-xs md:text-sm text-green-700">ğŸ“š Words Mastered</div>
                                </div>
                                <div class="stat-card bg-blue-100 rounded-xl p-4 md:p-6 text-center">
                                    <div class="text-3xl md:text-4xl font-bold text-blue-800">${state.testResults.length}</div>
                                    <div class="text-xs md:text-sm text-blue-700">ğŸ“ Tests Done</div>
                                </div>
                                <div class="stat-card bg-purple-100 rounded-xl p-4 md:p-6 text-center">
                                    <div class="text-3xl md:text-4xl font-bold text-purple-800">${state.words.length}</div>
                                    <div class="text-xs md:text-sm text-purple-700">ğŸ¯ Words Ready</div>
                                </div>
                            </div>

                            <div class="flex flex-col gap-4">
                                <button onclick="startLearning()" 
                                        class="py-6 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xl font-bold rounded-xl hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all">
                                    ğŸš€ Start Learning
                                </button>
                                <button onclick="openParentDashboard()" 
                                        class="py-6 bg-gradient-to-r from-blue-500 to-indigo-500 text-white text-xl font-bold rounded-xl hover:from-blue-600 hover:to-indigo-600 transform hover:scale-105 transition-all">
                                    ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Parent Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (state.mode === 'parent') {
                renderParent();
            }
            else if (state.mode === 'student') {
                if (state.gameState === 'setup') renderSetup();
                else if (state.gameState === 'playing') renderPlaying();
                else if (state.gameState === 'results') renderResults();
            }
        }

        function renderParent() {
            const app = document.getElementById('app');
            
            const totalTests = state.testResults.length;
            const averageScore = totalTests > 0 
                ? Math.round(state.testResults.reduce((acc, t) => acc + t.percentage, 0) / totalTests) 
                : 0;
            
            const studentMap = new Map();
            state.testResults.forEach(test => {
                if (!studentMap.has(test.studentName)) {
                    studentMap.set(test.studentName, {
                        tests: [],
                        totalCorrect: 0,
                        totalWords: 0
                    });
                }
                const student = studentMap.get(test.studentName);
                student.tests.push(test);
                student.totalCorrect += test.score;
                student.totalWords += test.total;
            });

            app.innerHTML = `
                <div class="max-w-6xl mx-auto p-4 md:p-8">
                    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 relative">
                        <button onclick="toggleDarkMode()" class="absolute top-4 right-4 text-2xl theme-toggle">
                            ${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                        </button>

                        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h1 class="text-3xl md:text-4xl font-bold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Parent Dashboard</h1>
                            <button onclick="goHome()" class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors w-full md:w-auto">
                                ğŸ  Back to Home
                            </button>
                        </div>

                        ${totalTests === 0 ? `
                            <div class="text-center py-16 bg-gray-50 rounded-2xl">
                                <div class="text-7xl mb-4">ğŸ“Š</div>
                                <h3 class="text-2xl font-bold text-gray-700 mb-2">No Data Yet</h3>
                                <p class="text-gray-500">Complete some spelling tests to see progress here!</p>
                                <button onclick="startLearning()" class="mt-6 px-8 py-4 bg-purple-500 text-white rounded-xl font-bold hover:bg-purple-600">
                                    ğŸš€ Start Your First Test
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-blue-800">${totalTests}</div>
                                    <div class="text-sm text-blue-600">Total Tests</div>
                                </div>
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-green-800">${averageScore}%</div>
                                    <div class="text-sm text-green-600">Average Score</div>
                                </div>
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-purple-800">${state.totalWords}</div>
                                    <div class="text-sm text-purple-600">Words Mastered</div>
                                </div>
                                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-yellow-800">${state.bestStreak}</div>
                                    <div class="text-sm text-yellow-600">Best Streak</div>
                                </div>
                            </div>

                            <div class="space-y-8">
                                ${Array.from(studentMap.entries()).map(([name, data]) => {
                                    const studentAvg = Math.round((data.totalCorrect / data.totalWords) * 100);
                                    const recentTests = data.tests.slice(-5).reverse();
                                    
                                    return `
                                        <div class="bg-gray-50 rounded-2xl p-6">
                                            <div class="flex items-center gap-3 mb-6">
                                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                                                    ${name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <h2 class="text-2xl font-bold">${name}</h2>
                                                    <p class="text-gray-600">${data.tests.length} tests completed</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-3 gap-4 mb-6">
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-2xl font-bold text-blue-600">${studentAvg}%</div>
                                                    <div class="text-xs text-gray-500">Average</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-2xl font-bold text-green-600">${data.totalCorrect}</div>
                                                    <div class="text-xs text-gray-500">Correct</div>
                                                </div>
                                                <div class="bg-white rounded-xl p-4 text-center">
                                                    <div class="text-2xl font-bold text-purple-600">${data.totalWords}</div>
                                                    <div class="text-xs text-gray-500">Total Words</div>
                                                </div>
                                            </div>
                                            
                                            <h3 class="font-bold mb-3">ğŸ“‹ Recent Tests</h3>
                                            <div class="space-y-3">
                                                ${recentTests.map(test => `
                                                    <div class="bg-white rounded-xl p-4 border-l-4 ${test.percentage >= 80 ? 'border-green-500' : 'border-yellow-500'}">
                                                        <div class="flex justify-between items-center mb-2">
                                                            <span class="font-bold">${test.score}/${test.total} words correct</span>
                                                            <span class="text-sm text-gray-500">${new Date(test.date).toLocaleDateString()}</span>
                                                        </div>
                                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                                            <div class="bg-${test.percentage >= 80 ? 'green' : 'yellow'}-500 h-2 rounded-full" style="width: ${test.percentage}%"></div>
                                                        </div>
                                                        <div class="mt-2 text-sm text-gray-600">
                                                            Words: ${test.words.join(', ')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="mt-8 bg-gray-50 rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4">ğŸ“ˆ Progress Over Time</h3>
                                <div class="h-40 flex items-end justify-between gap-1">
                                    ${state.testResults.slice(-10).map((test, i) => `
                                        <div class="flex-1 flex flex-col items-center">
                                            <div class="w-full bg-gradient-to-t from-blue-500 to-purple-500 rounded-t-lg transition-all hover:from-blue-600 hover:to-purple-600" 
                                                 style="height: ${test.percentage}%"></div>
                                            <span class="text-xs text-gray-600 mt-2">${i+1}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="mt-8 grid md:grid-cols-2 gap-4">
                                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-red-800 mb-2">âš ï¸ Clear All Data</h3>
                                    <p class="text-red-600 mb-4">This will delete all progress for all students.</p>
                                    <button onclick="clearAllData()" class="px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors w-full md:w-auto">
                                        ğŸ—‘ï¸ Delete Everything
                                    </button>
                                </div>
                                
                                <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6">
                                    <h3 class="text-xl font-bold text-blue-800 mb-2">ğŸ“Š Export Data</h3>
                                    <p class="text-blue-600 mb-4">Download progress as a CSV file.</p>
                                    <button onclick="exportData()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors w-full md:w-auto">
                                        â¬‡ï¸ Download CSV
                                    </button>
                                </div>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="max-w-2xl mx-auto p-4 md:p-8">
                    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 relative">
                        <button onclick="toggleDarkMode()" class="absolute top-4 right-4 text-2xl theme-toggle">
                            ${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                        </button>

                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl md:text-3xl font-bold">ğŸ“š Let's Get Started</h1>
                            <button onclick="goHome()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                ğŸ 
                            </button>
                        </div>

                        <div class="mb-6">
                            <label class="block text-lg font-bold mb-2">What's your name? ğŸŒŸ</label>
                            <input type="text" id="studentNameInput" value="${state.studentName}" 
                                   oninput="updateStudentName(this.value)"
                                   class="w-full px-4 py-4 border-2 border-purple-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none"
                                   placeholder="Enter your name...">
                        </div>

                        <div class="mb-6">
                            <label class="block text-lg font-bold mb-2">Add spelling words ğŸ“</label>
                            <div class="flex gap-2">
                                <input type="text" id="newWord" placeholder="Type a word..."
                                       class="flex-1 px-4 py-4 border-2 border-blue-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none"
                                       onkeypress="if(event.key==='Enter') addWord()">
                                <button onclick="addWord()" class="px-6 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition-colors">
                                    Add
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">âœ¨ Any word works - we'll give you a hint!</p>
                        </div>

                        ${state.words.length > 0 ? `
                            <div class="mb-6">
                                <h3 class="font-bold mb-3">Your Words (${state.words.length})</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    ${state.words.map((word, i) => `
                                        <div class="bg-purple-100 rounded-lg p-3 flex justify-between items-center group">
                                            <span class="font-medium capitalize">${word}</span>
                                            <button onclick="removeWord(${i})" class="text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                                âœ•
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <button onclick="startGame()" 
                                ${state.words.length === 0 || !state.studentName.trim() ? 'disabled' : ''}
                                class="w-full py-5 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold rounded-xl hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            ğŸš€ Start Spelling Adventure!
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlaying() {
            const app = document.getElementById('app');
            const progress = ((state.currentIndex + 1) / state.words.length) * 100;
            const currentWord = state.words[state.currentIndex];
            const hint = getContextualHint(currentWord);

            app.innerHTML = `
                <div class="max-w-xl mx-auto p-4 md:p-8">
                    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 relative">
                        <button onclick="toggleDarkMode()" class="absolute top-4 right-4 text-2xl theme-toggle">
                            ${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                        </button>

                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold">Hello, ${state.studentName}! âœ¨</h2>
                                <p class="text-gray-600">Listen carefully and spell the word</p>
                            </div>
                            <button onclick="goHome()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Exit
                            </button>
                        </div>

                        <div class="mb-6">
                            <div class="flex justify-between text-sm mb-2">
                                <span>Word ${state.currentIndex + 1} of ${state.words.length}</span>
                                <span>Score: ${state.score} â­</span>
                                <span>Streak: ${state.streak} ğŸ”¥</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl p-6 mb-6">
                            <div class="text-center mb-4">
                                <div class="text-5xl mb-3">ğŸ”Š</div>
                                <p class="text-lg font-bold mb-4">Click to hear the word:</p>
                            </div>

                            <div class="space-y-3">
                                <button onclick="speakWord('${currentWord}')" 
                                        class="speak-button w-full bg-blue-500 text-white px-6 py-5 rounded-xl font-bold hover:bg-blue-600 transform hover:scale-105 transition-all flex items-center justify-center gap-3 text-lg">
                                    <span class="text-2xl">ğŸ”Š</span>
                                    <span>SAY THE WORD</span>
                                </button>
                                
                                <button onclick="toggleHint('${currentWord}')"
                                        class="w-full bg-purple-500 text-white px-6 py-4 rounded-xl font-bold hover:bg-purple-600 transform hover:scale-105 transition-all flex items-center justify-center gap-2">
                                    ğŸ’¡ Get a Hint
                                </button>
                            </div>

                            ${state.showHint ? `
                                <div class="mt-4 p-6 bg-purple-100 rounded-xl border-2 border-purple-300">
                                    <p class="hint-text text-center">"${hint}"</p>
                                    <button onclick="speakHint('${currentWord}')" class="mt-4 w-full px-4 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                        ğŸ” Hear Hint Again
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="mb-4">
                            <input type="text" id="answerInput" value="${state.userAnswer}"
                                   oninput="updateUserAnswer(this.value)"
                                   ${state.answered ? 'disabled' : ''}
                                   class="w-full px-6 py-5 text-2xl text-center border-2 ${state.answered ? 'border-gray-300' : 'border-purple-400'} rounded-xl font-bold focus:border-purple-500 focus:outline-none"
                                   placeholder="âœï¸ Type your answer..."
                                   autocomplete="off" autocorrect="off" spellcheck="false">
                        </div>

                        ${state.showAnswer ? `
                            <div class="p-6 rounded-xl mb-4 text-center ${
                                state.userAnswer.toLowerCase().trim() === currentWord 
                                    ? 'bg-green-100 border-2 border-green-400' 
                                    : 'bg-red-100 border-2 border-red-400'
                            }">
                                <div class="text-5xl mb-2">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord ? 'âœ“âœ“âœ“' : 'âœ—âœ—âœ—'}
                                </div>
                                <p class="text-xl font-bold">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Lekker! You got it right!' 
                                        : `The correct spelling is: "${currentWord}"`}
                                </p>
                                <p class="text-gray-600 mt-2">
                                    ${state.userAnswer.toLowerCase().trim() === currentWord 
                                        ? 'Well done! ğŸŒŸ' 
                                        : 'Keep practicing - you\'ll get it next time! ğŸ’ª'}
                                </p>
                            </div>
                        ` : ''}

                        ${!state.answered ? `
                            <button onclick="submitAnswer()" 
                                    class="w-full py-5 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xl font-bold rounded-xl hover:from-purple-600 hover:to-pink-600 transform hover:scale-105 transition-all shadow-lg">
                                âœ… Check My Answer
                            </button>
                        ` : `
                            <button onclick="nextWord()" 
                                    class="w-full py-5 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xl font-bold rounded-xl hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all shadow-lg">
                                ${state.currentIndex < state.words.length - 1 ? 'ğŸš€ Next Word' : 'ğŸ‰ See My Results'}
                            </button>
                        `}
                    </div>
                </div>
            `;

            if (!state.answered) {
                setTimeout(() => document.getElementById('answerInput')?.focus(), 100);
            }
        }

        function renderResults() {
            const app = document.getElementById('app');
            const percentage = Math.round((state.score / state.words.length) * 100);
            
            let message = '';
            let emoji = '';
            if (percentage === 100) {
                message = "PERFECT SCORE! You're a spelling champion!";
                emoji = "ğŸ†ğŸŒŸğŸ‰";
            } else if (percentage >= 80) {
                message = "Excellent work! You're getting really good!";
                emoji = "ğŸ‰âœ¨â­";
            } else if (percentage >= 60) {
                message = "Good job! Keep practicing to get even better!";
                emoji = "ğŸ‘ğŸ“šğŸ’ª";
            } else {
                message = "Nice try! Every mistake helps you learn. Try again!";
                emoji = "ğŸ’ªğŸŒŸğŸ“";
            }

            app.innerHTML = `
                <div class="max-w-2xl mx-auto p-4 md:p-8">
                    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 relative">
                        <button onclick="toggleDarkMode()" class="absolute top-4 right-4 text-2xl theme-toggle">
                            ${state.darkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
                        </button>

                        <div class="flex justify-end mb-4">
                            <button onclick="goHome()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                ğŸ  Home
                            </button>
                        </div>

                        <div class="text-center mb-6">
                            <div class="text-7xl mb-4 animate-bounce">${emoji}</div>
                            <h2 class="text-3xl md:text-4xl font-bold mb-3">Great job, ${state.studentName}!</h2>
                            <p class="text-xl text-gray-600">${message}</p>
                        </div>

                        <div class="bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl p-8 mb-8 text-white text-center">
                            <div class="text-6xl font-bold mb-2">${state.score}/${state.words.length}</div>
                            <div class="text-3xl font-bold">${percentage}%</div>
                            <div class="mt-4 text-lg">Words correct: ${state.score}</div>
                        </div>

                        <h3 class="text-2xl font-bold mb-4">Your Results:</h3>
                        <div class="grid grid-cols-2 gap-3 mb-8">
                            ${state.words.map((word, i) => `
                                <div class="p-4 rounded-xl ${state.correctAnswers.includes(i) ? 'bg-green-100 border-2 border-green-400' : 'bg-red-100 border-2 border-red-400'} flex justify-between items-center">
                                    <span class="font-bold capitalize">${word}</span>
                                    <span class="text-2xl ${state.correctAnswers.includes(i) ? 'correct-icon' : 'incorrect-icon'}">
                                        ${state.correctAnswers.includes(i) ? 'âœ“âœ“' : 'âœ—âœ—'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="practiceAgain()" 
                                    class="py-4 bg-purple-500 text-white text-xl font-bold rounded-xl hover:bg-purple-600 transform hover:scale-105 transition-all">
                                ğŸ”„ Practice Again
                            </button>
                            <button onclick="newWords()"
                                    class="py-4 bg-blue-500 text-white text-xl font-bold rounded-xl hover:bg-blue-600 transform hover:scale-105 transition-all">
                                â• New Words
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== HELPER FUNCTIONS ====================
        function exportData() {
            const data = state.testResults.map(r => ({
                Student: r.studentName,
                Date: new Date(r.date).toLocaleDateString(),
                Score: `${r.score}/${r.total}`,
                Percentage: `${r.percentage}%`,
                Words: r.words.join('; ')
            }));
            
            const csv = convertToCSV(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spelling-progress-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function convertToCSV(objArray) {
            if (objArray.length === 0) return '';
            const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
            let str = Object.keys(array[0]).join(',') + '\r\n';
            return array.reduce((str, next) => {
                str += Object.values(next).map(value => `"${value}"`).join(',') + '\r\n';
                return str;
            }, str);
        }

        // ==================== EVENT HANDLERS ====================
        function startLearning() { state.mode = 'student'; render(); }
        function openParentDashboard() { state.mode = 'parent'; render(); }
        function goHome() { state.mode = 'home'; render(); }

        function updateStudentName(name) { state.studentName = name; }
        function updateUserAnswer(answer) { state.userAnswer = answer; }

        function addWord() {
            const input = document.getElementById('newWord');
            const word = input.value.trim().toLowerCase();
            if (word && !state.words.includes(word)) {
                state.words.push(word);
                input.value = '';
                render();
            }
        }

        function removeWord(index) {
            state.words.splice(index, 1);
            render();
        }

        function startGame() {
            if (state.words.length > 0 && state.studentName.trim()) {
                state.gameState = 'playing';
                state.currentIndex = 0;
                state.score = 0;
                state.correctAnswers = [];
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.streak = 0;
                state.showHint = false;
                render();
                // DON'T auto-play the word
            }
        }

        function speakWord(word) {
            speakText(word);
        }

        function speakHint(word) {
            const hint = getContextualHint(word);
            speakText(hint);
        }

        function toggleHint(word) {
            state.showHint = !state.showHint;
            // DON'T auto-play the hint
            render();
        }

        function submitAnswer() {
            const input = document.getElementById('answerInput');
            if (input) {
                state.userAnswer = input.value;
            }
            checkAnswer();
            render();
        }

        function checkAnswer() {
            const correct = state.userAnswer.toLowerCase().trim() === state.words[state.currentIndex];
            if (correct) {
                state.score++;
                state.correctAnswers.push(state.currentIndex);
                state.streak++;
                if (state.streak > state.bestStreak) {
                    state.bestStreak = state.streak;
                    localStorage.setItem('bestStreak', state.bestStreak);
                }
                state.totalWords++;
                localStorage.setItem('totalWords', state.totalWords);
            } else {
                state.streak = 0;
            }
            state.showAnswer = true;
            state.answered = true;
        }

        function nextWord() {
            if (state.currentIndex < state.words.length - 1) {
                state.currentIndex++;
                state.userAnswer = '';
                state.showAnswer = false;
                state.answered = false;
                state.showHint = false;
                render();
                // DON'T auto-play the next word
            } else {
                finishGame();
            }
        }

        function finishGame() {
            const result = {
                studentName: state.studentName,
                date: new Date().toISOString(),
                words: [...state.words],
                score: state.score,
                total: state.words.length,
                percentage: Math.round((state.score / state.words.length) * 100),
                correctAnswers: [...state.correctAnswers]
            };
            state.testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(state.testResults));
            state.gameState = 'results';
            render();
        }

        function practiceAgain() {
            state.gameState = 'playing';
            state.currentIndex = 0;
            state.score = 0;
            state.correctAnswers = [];
            state.userAnswer = '';
            state.showAnswer = false;
            state.answered = false;
            state.streak = 0;
            state.showHint = false;
            render();
            // DON'T auto-play the word
        }

        function newWords() {
            state.words = [];
            state.gameState = 'setup';
            render();
        }

        function clearAllData() {
            if (confirm('âš ï¸ Delete ALL progress? This cannot be undone!')) {
                localStorage.clear();
                state.testResults = [];
                state.totalWords = 0;
                state.bestStreak = 0;
                render();
            }
        }

        // Make functions globally available
        window.toggleDarkMode = toggleDarkMode;
        window.startLearning = startLearning;
        window.openParentDashboard = openParentDashboard;
        window.goHome = goHome;
        window.updateStudentName = updateStudentName;
        window.updateUserAnswer = updateUserAnswer;
        window.addWord = addWord;
        window.removeWord = removeWord;
        window.startGame = startGame;
        window.speakWord = speakWord;
        window.speakHint = speakHint;
        window.toggleHint = toggleHint;
        window.submitAnswer = submitAnswer;
        window.nextWord = nextWord;
        window.practiceAgain = practiceAgain;
        window.newWords = newWords;
        window.clearAllData = clearAllData;
        window.exportData = exportData;

        // Initial render
        render();
    </script>
</body>
</html>